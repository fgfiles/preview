var TrackRunner=pc.createScript("trackRunner");TrackRunner.attributes.add("cornerScale",{type:"number"}),TrackRunner.attributes.add("bumpScale",{type:"number"}),TrackRunner.prototype.initialize=function(){this.currentSegments=[],this.speed=0,this.ctrlDist=0,this.ctrlTick=0,this.ctrlStart=pc.Vec3.ZERO.clone()},TrackRunner.prototype.setOriginAndForward=function(t,e){this.ctrlOrigin=t,this.ctrlForward=e,this.smoothedForward||(this.smoothedForward=this.ctrlForward.clone())},TrackRunner.prototype.addSegment=function(t){var e;(t.reparent(this.entity,0),0<this.currentSegments.length)?e=this.currentSegments[this.currentSegments.length-1].getPosition().z+DM2.SEGMENT_SCALE:e=0;return t.setPosition(0,0,e),t.enabled=!0,this.currentSegments.push(t),e},TrackRunner.prototype.getNearestSegment=function(t){for(var e=null,i=this.currentSegments.length-1;0<=i&&!((e=this.currentSegments[i]).getPosition().z<t);i--);return e},TrackRunner.prototype.step=function(t){this.controlPoints=this.currentSegments[0].controlPoints;for(var e=0;e<this.currentSegments.length;e++){this.currentSegments[e].script.segmentRenderer.stepSegment(t,this.speed,this.ctrlOrigin,this.ctrlForward)}this.lastSegment&&this.lastSegment.script.segmentRenderer.stepSegment(t,this.speed,this.ctrlOrigin,this.ctrlForward);this.updateControlOriginAndForward(t*this.speed);var i=this.currentSegments[0];i.getPosition().z<=0&&(this.lastSegment&&(this.lastSegment.enabled=!1),this.ctrlDist=0,this.ctrlTick+=1,this.ctrlStart=i.offset,this.lastSegment=this.currentSegments[0],this.currentSegments.splice(0,1)),this.currentSegments.length<DM2.MAX_SEGMENTS&&this.app.fire(DM2.EVENT_SEGMENT_REQ)},TrackRunner.prototype.updateControlOriginAndForward=function(t){if(!(t<=0)){this.ctrlDist=pc.math.clamp(this.ctrlDist+t/DM2.SEGMENT_SCALE,0,1);var e=DM2.calcCatmulRomPoint(this.ctrlDist,this.controlPoints[0],this.controlPoints[1],this.controlPoints[2],this.controlPoints[3]);e.z=(this.ctrlTick+this.ctrlDist)*DM2.SEGMENT_SCALE,this.ctrlForward.x=e.x-this.ctrlOrigin.x,this.ctrlForward.y=e.y-this.ctrlOrigin.y,this.ctrlForward.z=e.z-this.ctrlOrigin.z,this.ctrlOrigin.add(this.ctrlForward),this.smoothedForward?(this.smoothedForward.x=pc.math.lerp(this.smoothedForward.x,this.ctrlForward.x,5*DM2.FIXED_T),this.smoothedForward.y=pc.math.lerp(this.smoothedForward.y,this.ctrlForward.y,5*DM2.FIXED_T),this.smoothedForward.z=pc.math.lerp(this.smoothedForward.z,this.ctrlForward.z,5*DM2.FIXED_T)):this.smoothedForward=this.ctrlForward.clone()}};var SegmentRenderer=pc.createScript("segmentRenderer");SegmentRenderer.attributes.add("vs",{type:"asset",assetType:"shader",title:"Vertex Shader"}),SegmentRenderer.attributes.add("fs",{type:"asset",assetType:"shader",title:"Fragment Shader"}),SegmentRenderer.attributes.add("textureMap",{type:"asset",assetType:"texture",title:"Texture Map"}),SegmentRenderer.prototype.initialize=function(){this.shaderDecorators=[],this.isInitialized=!1,this.on("disable",this.onDisable)},SegmentRenderer.prototype.registerDecorator=function(t){this.shaderDecorators.push(t),this.isInitialized=!1},SegmentRenderer.prototype.stepSegment=function(t,e,i,s){var n=this.entity.controlPoints,o=this.entity.getLocalPosition().clone(),r=o.z-t*e/DM2.SEGMENT_SCALE;o.z=r,this.entity.setLocalPosition(o),this.setControlPoints(i,s,n[0],n[1],n[2],n[3],t),this.entity.model.enabled=!0},SegmentRenderer.prototype.setControlPoints=function(t,e,i,s,n,o,r){this.isInitialized||(this.setupMaterial(),this.updateFogColor(),this.isInitialized=!0);var a=this.material;a.setParameter("uOrigin",t.data),a.setParameter("uForward",e.data),a.setParameter("uP0",i.data),a.setParameter("uP1",s.data),a.setParameter("uP2",n.data),a.setParameter("uP3",o.data),this.shaderDecorators.map(function(t){t.onUpdateMaterial(a,r)}),this.glowMaterial&&(this.glowMaterial.setParameter("uOrigin",t.data),this.glowMaterial.setParameter("uForward",e.data),this.glowMaterial.setParameter("uP0",i.data),this.glowMaterial.setParameter("uP1",s.data),this.glowMaterial.setParameter("uP2",n.data),this.glowMaterial.setParameter("uP3",o.data))},SegmentRenderer.prototype.updateFogColor=function(){var t=this.app.root.findByName("GameCamera").camera.clearColor;this.material.setParameter("uFogColor",t.data)},SegmentRenderer.prototype.onDisable=function(){this.off("disable",this.onDisable),this.entity.model.enabled=!1,this.entity.props=[]},SegmentRenderer.prototype.setupMaterial=function(){var t=this.app,e=this.entity.model.model,i=t.graphicsDevice,s=this.textureMap.resource,n=this.setupVertShader(this.vs.resource),o="precision "+i.precision+" float;\n";o+=this.setupFragShader(this.fs.resource);var r={attributes:{aPosition:pc.SEMANTIC_POSITION,aNormal:pc.SEMANTIC_NORMAL,aUv0:pc.SEMANTIC_TEXCOORD0,aColor:pc.SEMANTIC_COLOR},vshader:n,fshader:o};this.shader=new pc.Shader(i,r),this.material=new pc.Material,this.time=0,e||console.log(this.entity.name+" has no mesh"),this.material.setShader(this.shader),this.material.setParameter("uTextureMap",s),e.meshInstances[0].material=this.material,1<e.meshInstances.length&&(this.glowMaterial=new pc.Material,this.glowMaterial.setShader(this.shader),this.glowMaterial.setParameter("uTextureMap",s),this.glowMaterial.blendType=pc.BLEND_ADDITIVEALPHA,e.meshInstances[1].material=this.glowMaterial)},SegmentRenderer.prototype.setupVertShader=function(t){var e=t;return this.shaderDecorators.map(function(t){e=t.setupVertShader(e)}),e},SegmentRenderer.prototype.setupFragShader=function(t){var e=t;return this.shaderDecorators.map(function(t){e=t.setupFragShader(e)}),e};var LevelController=pc.createScript("levelController");LevelController.attributes.add("assetTag",{type:"string"}),LevelController.attributes.add("trackData",{type:"asset"}),LevelController.prototype.initialize=function(){this.propManager=this.app.root.findByName("PropManager").script.propManager,this.segmentManager=this.entity.findByName("SegmentManager").script.segmentManager,this.trackRunner=this.entity.findByName("TrackRunner").script.trackRunner,this.sfxManager=DM2.findSFXManagerForApp(this.app),this.progress=0,this.progressLength=1,this.blueprintCount=0,this.app.on(DM2.EVENT_ASSETS_LOADED,this.onAssetsReady,this),this.app.on(DM2.EVENT_TRIGGER,this.onEventTrigger,this),this.app.on(DM2.EVENT_TOGGLE_SFX,this.onToggleSFX,this)},LevelController.prototype.step=function(t){this.propManager.step(t,this.trackRunner.speed),this.trackRunner.step(t);var e=this.segmentIndex/this.progressLength*100;this.progress<e&&(this.progress=e)},LevelController.prototype.preWarmAssets=function(){this.segments=this.trackData.resource.segments;for(var t=this.segmentIndex=0;t<this.segments.length;t++){var e=this.segments[t],i=this.getSegmentID(e);this.segmentManager.cacheSegment(i,DM2.SEGM_CACHE_SIZE);for(var s=0;s<e.props.length;s++){var n=e.props[s];if("end_level"===n.typeID)this.progressLength=t;else{var o=this.propManager.getPropID(n);this.propManager.cacheProp(o,DM2.PROP_CACHE_SIZE)}}}this.propManager.cacheProp("explosion",10)},LevelController.prototype.setSpeed=function(t){this.trackRunner.speed=t},LevelController.prototype.getSpeed=function(){return this.trackRunner.speed},LevelController.prototype.registerBlueprint=function(t){t&&this.blueprintCount++},LevelController.prototype.loadNextSegment=function(){var t=this.segments[this.segmentIndex],e=this.getSegmentID(t),i=this.segmentManager.createInstance(e),s=new pc.Vec3(t.x,t.y,1);i.fwd=s.normalize(),i.controlPoints=this.getControlPoints(this.segmentIndex),i.index=this.segmentIndex;var n=this.trackRunner.addSegment(i);t.props&&0<t.props.length&&this.spawnProps(t.props,i,n),this.segmentIndex++},LevelController.prototype.getSegmentID=function(t){var e=0===t.typeValue?1:t.typeValue,i=t.tileSet+"-tile-"+("0"+e).substr(-2,2);return DM2.LOWMEM&&(i=this.getLowMemReplacementID(i)),i},LevelController.prototype.spawnProps=function(t,e,i){for(var s=0;s<t.length;s++){var n=t[s];this.propManager.spawnProp(n,i)}},LevelController.prototype.onAssetsReady=function(){this.setInitialBendControls();for(var t=0;t<DM2.MAX_SEGMENTS;t++)this.loadNextSegment();this.app.on(DM2.EVENT_SEGMENT_REQ,this.onSegmentRequest,this)},LevelController.prototype.onSegmentRequest=function(){this.segmentIndex<this.segments.length&&this.loadNextSegment()},LevelController.prototype.onEventTrigger=function(t){t===DM2.TRIGGER_START_INTRO?(this.sfxManager.play(DM2.SFX_MUSIC_TRACK),this.sfxManager.play(DM2.SFX_NARR_LOC_INTRO)):t===DM2.TRIGGER_LEVEL_END&&this.sfxManager.play(DM2.SFX_NARR_LOC_COMPLETE)},LevelController.prototype.onToggleSFX=function(t){t||this.sfxManager.play(DM2.SFX_MUSIC_TRACK)},LevelController.prototype.setInitialBendControls=function(){var t=this.segments[0],e=this.segments[1],i=new pc.Vec3(t.cx*DM2.BEND_INDEX,t.cy*DM2.BEND_INDEX,0),s=new pc.Vec3(e.cx*DM2.BEND_INDEX,e.cy*DM2.BEND_INDEX,DM2.SEGMENT_SCALE),n=new pc.Vec3(s.x-i.x,s.y-i.y,s.z-i.z);this.trackRunner.setOriginAndForward(i,n)},LevelController.prototype.getControlPoints=function(t){var e,i,s,n;if(0===t)e=pc.Vec3.ZERO.clone();else{var o=this.segments[t-1];e=new pc.Vec3(o.cx*DM2.BEND_INDEX,o.cy*DM2.BEND_INDEX,(t-1)*DM2.SEGMENT_SCALE)}var r=this.segments[t];if(i=new pc.Vec3(r.cx*DM2.BEND_INDEX,r.cy*DM2.BEND_INDEX,t*DM2.SEGMENT_SCALE),t+1<this.segments.length){var a=this.segments[t+1];s=new pc.Vec3(a.cx*DM2.BEND_INDEX,a.cy*DM2.BEND_INDEX,(t+1)*DM2.SEGMENT_SCALE)}else s=i;if(t+2<this.segments.length){var l=this.segments[t+2];n=new pc.Vec3(l.cx*DM2.BEND_INDEX,l.cy*DM2.BEND_INDEX,(t+2)*DM2.SEGMENT_SCALE)}else n=s;return[e,i,s,n]},LevelController.prototype.getLowMemReplacementID=function(t){switch(t){case"london-tile-02":case"london-tile-04":return"london-tile-01";case"london-tile-05":case"london-tile-06":case"london-tile-07":return"london-tile-03";case"thames-tile-07":case"thames-tile-08":return"thames-tile-02";case"subway-tile-02":case"subway-tile-05":case"subway-tile-06":case"subway-tile-09":return"subway-tile-01";case"tokyo-tile-01":case"tokyo-tile-03":case"tokyo-tile-05":case"tokyo-tile-07":return"tokyo-tile-02";case"canyon-tile-07":case"canyon-tile-11":case"canyon-tile-12":return"canyon-tile-10";case"canyon-tile-05":return"canyon-tile-09";case"planet-tile-01":case"planet-tile-02":case"planet-tile-03":case"planet-tile-05":return"planet-tile-04";case"trench-tile-02":case"trench-tile-03":case"trench-tile-04":case"trench-tile-05":case"trench-tile-10":return"trench-tile-01";case"trench-tile-08":case"trench-tile-09":return"trench-tile-07";case"factory-tile-02":case"factory-tile-03":case"factory-tile-04":case"factory-tile-05":case"factory-tile-06":return"factory-tile-01";case"factory-tile-07":return"factory-tile-08";default:return t}};var TrackLanes=pc.createScript("trackLanes");TrackLanes.prototype.initialize=function(){this.lanes=this.entity.children,this.farLeftLane=0,this.farRightLane=3},TrackLanes.prototype.getStartingLane=function(){return this.lanes||(this.lanes=this.entity.children),this.lanes[1]},TrackLanes.prototype.setLaneConfig=function(t){0===t?(this.farLeftLane=0,this.farRightLane=3):1===t?(this.farLeftLane=1,this.farRightLane=3):2===t&&(this.farLeftLane=0,this.farRightLane=2)},TrackLanes.prototype.getPosForLane=function(t){return this.lanes[t].getLocalPosition()},TrackLanes.prototype.canMoveLeft=function(t){return t.name!==this.lanes[this.farLeftLane].name&&-1!==this.lanes.indexOf(t)},TrackLanes.prototype.canMoveRight=function(t){return t.name!==this.lanes[this.farRightLane].name&&-1!==this.lanes.indexOf(t)},TrackLanes.prototype.canMoveLeftFromPos=function(t){return t.x<this.lanes[this.farLeftLane].getLocalPosition().x},TrackLanes.prototype.canMoveRightFromPos=function(t){return t.x>this.lanes[this.farRightLane].getLocalPosition().x},TrackLanes.prototype.getFarLeftLane=function(){return this.lanes[this.farLeftLane]},TrackLanes.prototype.getFarRightLane=function(){return this.lanes[this.farRightLane]},TrackLanes.prototype.getClosestLane=function(t){for(var e=this.lanes[this.farLeftLane],i=0;i<this.lanes.length;i++){var s=e.getLocalPosition().x,n=this.lanes[i].getLocalPosition().x;Math.abs(n-t.x)<=Math.abs(s-t.x)&&(e=this.lanes[i])}return e},TrackLanes.prototype.getNextClosestLeftLane=function(t){for(var e=this.lanes[this.farLeftLane],i=this.farLeftLane;i<=this.farRightLane;i++){this.lanes[i].getLocalPosition().x>t.x&&(e=this.lanes[i])}return e},TrackLanes.prototype.getNextClosestRightLane=function(t){for(var e=this.lanes[this.farRightLane],i=this.farRightLane;i>=this.farLeftLane;i--){this.lanes[i].getLocalPosition().x<t.x&&(e=this.lanes[i])}return e},TrackLanes.prototype.getNextLeftLane=function(t){for(var e=this.farLeftLane;e<=this.farRightLane;e++)if(this.lanes[e].name===t.name)return this.lanes[e-1];return null},TrackLanes.prototype.getNextRightLane=function(t){for(var e=this.farLeftLane;e<this.farRightLane;e++)if(this.lanes[e].name===t.name)return this.lanes[e+1];return null};var PlayerController=pc.createScript("playerController");PlayerController.attributes.add("gameCamera",{type:"entity"}),PlayerController.attributes.add("hasIntroAnim",{type:"boolean"}),PlayerController.attributes.add("attackOnLevelEnd",{type:"boolean"}),PlayerController.prototype.initialize=function(){this.lanes=this.app.root.findByName("TrackLanes").script.trackLanes,this.speedFX=this.app.root.findByName("SpeedFX").script.speedLines,this.trackRunner=this.app.root.findByName("TrackRunner").script.trackRunner,this.levelController=this.app.root.findByName("LevelController").script.levelController,this.camera=this.gameCamera.camera,this.vehicleEntity=this.entity.findByName("Vehicle"),this.vehicle=this.vehicleEntity.script.playerVehicle,this.speed=0,this.timer=0,this.isNitroActive=!1,this.isCrashing=!1,this.isStopped=!0,this.isFlyOrTakeOff=!1,this.startFOV=this.camera.fov,this.isRamping=!1,this.isComplete=!1,this.currentLanePos=this.lanes.getStartingLane().getLocalPosition(),this.vehicle.setStartPosition(this.currentLanePos),this.app.on(DM2.EVENT_ANIM_COMPLETED,this.onAnimationComplete,this),this.app.on(DM2.EVENT_INPUT_UPDATE,this.onInputUpdate,this),this.app.on(DM2.EVENT_TRIGGER,this.onEventTrigger,this),this.app.on(DM2.EVENT_TRIGGER_SFX,this.onSFXTrigger,this),this.isLeftDown=!1,this.isRightDown=!1,this.wasLeftPressed=!1,this.wasRightPressed=!1,this.wasLeftReleased=!1,this.wasRightReleased=!1,this.maxSpeed=DM2.configPlayer.maxSpeed,this.minSpeed=DM2.configPlayer.minSpeed,this.nitroSpeed=DM2.configPlayer.nitroSpeed,this.nitroAccel=DM2.configPlayer.nitroAccel,this.nitroTime=DM2.configPlayer.nitroTime,this.forwardAccel=DM2.configPlayer.forwardAccel,this.brakeAccel=DM2.configPlayer.brakeAccel,this.stopAccel=DM2.configPlayer.stopAccel,this.useJoypad=DM2.configPlayer.useJoypad,this.bendBuildup=0,this.oversteerTrigger=DM2.configPlayer.oversteerTrigger,this.oversteerValue=DM2.configPlayer.oversteerValue,this.oversteerRate=DM2.configPlayer.oversteerRate,this.oversteerTO=0,this.crashCount=0,this.crashTimeout=0,this.blueprintCount=0,this.speedFX.alphaStrength=0,this.setDifficulty(),pc.platform.mobile||(this.setupKeyboardInput(),this.keyPressTimestamp=0)},PlayerController.prototype.step=function(t){this.timer+=t,this.updateNitro(t),this.updateCrash(t),this.updateStopping(t),this.updateCameraPos(t),this.updateVehicleBehaviour(t),this.levelController.setSpeed(this.speed),this.updateOversteer(t),this.processPlayerInput(t),this.inputProcessed&&(this.app.fire(DM2.EVENT_INPUT_PROCESSED),this.inputProcessed=!1),0<this.crashTimeout&&(this.crashTimeout-=t),this.vehicle.isInvincible=this.crashTimeout<3&&.5<this.crashTimeout,this.vehicle.step(t)},PlayerController.prototype.startIntro=function(){this.hasIntroAnim?(this.isStopped=!0,this.vehicle.playAnimationTimed(DM2.states.intro,!1)):this.vehicle.playAnimation(DM2.states.drive,!0)},PlayerController.prototype.startDriving=function(){this.isStopped=!1,this.vehicle.startDriving()},PlayerController.prototype.getVehiclePos=function(){var t=this.entity.getLocalPosition().clone();return t.x=this.vehicleEntity.getLocalPosition().x,t.y=this.vehicleEntity.getLocalPosition().y,t},PlayerController.prototype.getAABB=function(){return this.vehicle.AABB},PlayerController.prototype.playAnimation=function(t,e,i){this.vehicle.playAnimation(t,e,i)},PlayerController.prototype.playRampAnimation=function(){this.isRamping=!0,this.isCrashing=!1,this.speed=this.maxSpeed,this.vehicle.ramp()},PlayerController.prototype.crashVehicle=function(){return!(this.isFlyOrTakeOff&&!this.vehicle.isFlying||this.isCrashing||this.isStopped||this.isRamping||0<this.crashTimeout)&&(this.vehicle.stopLazers(!0),this.isCrashing=!0,this.crashTimeout=3,this.crashCount++,this.vehicle.isFlying?this.vehicle.crashFlying():this.vehicle.crash(),!0)},PlayerController.prototype.updateCrash=function(t){this.isCrashing&&this.speed>this.minSpeed&&(this.speed-=this.brakeAccel*t/DM2.FIXED_T,this.speed<this.minSpeed&&(this.speed=this.minSpeed))},PlayerController.prototype.stopVehicle=function(){this.isStopped||(this.isStopped=!0)},PlayerController.prototype.updateStopping=function(t){this.isStopped&&0<this.speed&&(this.speed-=this.stopAccel*t/DM2.FIXED_T,this.speed<0&&(this.speed=0))},PlayerController.prototype.immediateStop=function(){this.isStopped=!0,this.isNitroActive=!1,this.isZoomOutro=!0,this.zoomOutroTO=1,this.levelController.setSpeed(this.speed),this.vehicle.handbrakeStop()},PlayerController.prototype.flyTakeOff=function(){return!this.isFlyOrTakeOff&&!this.isStopped&&(this.isCrashing=!1,this.speed=this.maxSpeed,this.isFlyOrTakeOff=!0,this.vehicle.takeOff(),!0)},PlayerController.prototype.flyLand=function(){return this.isFlyOrTakeOff=!1,this.vehicle.land(),!0},PlayerController.prototype.pickupBlueprint=function(e){var t=DM2.getGameData()[DM2.SETTING_BLUEPRINTS],i=!0;t||(t={collectedCount:0,collectedIDs:[]}),t.collectedIDs.map(function(t){t!==e||(i=!1)}),i&&(t.collectedCount=t.collectedCount+1,t.collectedIDs.push(e)),DM2.putGameData(DM2.SETTING_BLUEPRINTS,t),this.blueprintCount++,this.vehicle.playPickupFX()},PlayerController.prototype.updateOversteer=function(t){if(0<this.oversteerTO)this.oversteerTO-=t;else if(!this.isFlyOrTakeOff&&!this.isStopped&&!this.isComplete){var e=this.trackRunner.smoothedForward.x;Math.abs(e)>=this.oversteerTrigger&&(this.vehicle.oversteerBend(e,this.oversteerValue,this.oversteerRate,t),this.vehicle.setBoostersActive(!0))}},PlayerController.prototype.pickupNitro=function(){if(!this.isCrashing)return this.vehicle.playPickupFX(),this.isNitroActive?this.vehicle.boostUp():this.vehicle.boost(),this.nitroActivationTime=this.timer,this.isNitroActive=!0},PlayerController.prototype.updateNitro=function(t){this.isNitroActive?this.nitroActivationTime+this.nitroTime>this.timer?(this.speed<this.nitroSpeed&&(this.speed+=this.nitroAccel*t/DM2.FIXED_T,this.increaseCamereFov(.5,100)),this.speedFX.alphaStrength=1):(this.decreaseCamereFov(.25,this.startFOV),this.speed>this.maxSpeed?(this.speed-=this.brakeAccel*t/DM2.FIXED_T,this.speed<this.maxSpeed&&(this.speed=this.maxSpeed)):(this.isNitroActive=!1,this.vehicle.stopBoost())):(this.speedFX.alphaStrength=0,this.decreaseCamereFov(.25,this.startFOV))},PlayerController.prototype.pickupBattery=function(){this.vehicle.isShootingLazers||(this.vehicle.playPickupFX(),this.vehicle.startLazers())},PlayerController.prototype.increaseCamereFov=function(t,e){this.camera.fov<e&&(this.camera.fov+=t,this.camera.fov>e&&(this.camera.fov=e))},PlayerController.prototype.decreaseCamereFov=function(t,e){this.camera.fov>e&&(this.camera.fov-=t,this.camera.fov<e&&(this.camera.fov=e))},PlayerController.prototype.updateCameraPos=function(t){this.isZoomOutro?this.updateZoomCameraPos(t):this.updateFollowCameraPos(t)},PlayerController.prototype.updateZoomCameraPos=function(t){var e=this.gameCamera.getPosition().clone(),i=this.vehicleEntity.getPosition().clone();i.z-=3,i.y+=1.75,e.z=pc.math.lerp(e.z,i.z,2.5*t),e.y=pc.math.lerp(e.y,i.y,2.5*t);var s=this.gameCamera.getLocalEulerAngles().clone();165<s.z&&(s.z-=(s.z-165)*t*2.5,this.gameCamera.setEulerAngles(s)),this.gameCamera.setPosition(e)},PlayerController.prototype.updateFollowCameraPos=function(t){if(!this.isStopped){DM2.configPlayer.cameraXOffset,DM2.configPlayer.cameraYOffset;var e=this.gameCamera.getLocalPosition().clone(),i=this.vehicleEntity.getLocalPosition().clone();i.y=DM2.configPlayer.cameraYPos;var s=10*Math.max(.5,Math.abs(this.trackRunner.smoothedForward.x));this.isComplete||(i.x-=pc.math.clamp(this.trackRunner.smoothedForward.x*s,-2.5,2.5),i.y+=2.5*this.trackRunner.smoothedForward.y),i.y=pc.math.clamp(i.y,DM2.configPlayer.cameraYMin,DM2.configPlayer.cameraYMax),i.z=-DM2.configPlayer.cameraZPos,e.x=pc.math.lerp(e.x,i.x,t*DM2.configPlayer.cameraXRate),e.y=pc.math.lerp(e.y,i.y,t*DM2.configPlayer.cameraYRate),e.z=pc.math.lerp(e.z,i.z,t*DM2.configPlayer.cameraZRate),this.gameCamera.setLocalPosition(e)}},PlayerController.prototype.updateVehicleBehaviour=function(t){this.isCrashing&&(this.isNitroActive=!1,this.decreaseCamereFov(.25,this.startFOV),this.brakeVechile()),this.isNitroActive||this.speed>this.minSpeed+2?this.vehicle.setFastSpeedBehaviour():this.vehicle.setSlowSpeedBehaviour(),this.isNitroActive||this.isStopped||this.accelVehicle()},PlayerController.prototype.startAttack=function(){this.isPlayingAttack||(this.isPlayingAttack=!0,this.vehicle.playAttackSequence())},PlayerController.prototype.hillJump=function(){this.isCrashing=!1,this.speed=this.maxSpeed,this.vehicle.hillJump()},PlayerController.prototype.processPlayerInput=function(t){this.isStopped||("none"!==this.useJoypad.toLowerCase()&&this.processGamePad(t),this.handleCurrentInputState(t),this.wasLeftPressed=!1,this.wasRightPressed=!1,this.wasLeftReleased=!1,this.wasRightReleased=!1)},PlayerController.prototype.processGamePad=function(t){this.app.gamepads.update();var e=pc.input.PAD_2,i=this.app.gamepads.getAxis(e,pc.PAD_L_STICK_X),s=(this.app.gamepads.isPressed(e,pc.PAD_FACE_1),this.app.gamepads.isPressed(e,pc.PAD_R_SHOULDER_1));0===i&&this.isLeftDown?(this.isLeftDown=!1,this.isRightDown=!1,this.wasLeftReleased=!0):0===i&&this.isRightDown?(this.isRightDown=!1,this.isLeftDown=!1,this.wasRightReleased=!0):i<0?(this.isLeftDown=!0,this.wasLeftPressed=!0):0<i&&(this.isRightDown=!0,this.wasRightPressed=!0),s&&this.pickupNitro()},PlayerController.prototype.handleCurrentInputState=function(t){var e,i=this.vehicleEntity.getLocalPosition().clone();if(!(this.isLeftDown&&this.isRightDown||this.isCrashing)){(this.wasLeftPressed||this.wasRightPressed)&&(this.inputProcessed=!0,this.keyPressTimestamp=this.timer);var s=this.timer-this.keyPressTimestamp;this.isLeftDown?(this.oversteerTO=1,e=this.lanes.getFarLeftLane().getLocalPosition(),this.lanes.canMoveLeftFromPos(i)?this.vehicle.steerToPosition(e,t):this.vehicle.snapToLane(e)):this.wasLeftReleased&&!this.isRightDown&&(e=.25<s?this.lanes.getClosestLane(i).getLocalPosition():this.lanes.getNextClosestLeftLane(i).getLocalPosition(),this.vehicle.snapToLane(e),this.inputProcessed=!0),this.isRightDown?(this.oversteerTO=1,e=this.lanes.getFarRightLane().getLocalPosition(),this.lanes.canMoveRightFromPos(i)?this.vehicle.steerToPosition(e,t):this.vehicle.snapToLane(e)):this.wasRightReleased&&!this.isLeftDown&&(e=.25<s?this.lanes.getClosestLane(i).getLocalPosition():this.lanes.getNextClosestRightLane(i).getLocalPosition(),this.vehicle.snapToLane(e),this.inputProcessed=!0)}},PlayerController.prototype.accelVehicle=function(){this.speed<this.maxSpeed&&(this.speed+=this.forwardAccel)},PlayerController.prototype.brakeVechile=function(){this.speed>this.minSpeed&&(this.speed-=this.brakeAccel,this.speed<this.minSpeed&&(this.speed=this.minSpeed))},PlayerController.prototype.onAnimationComplete=function(t){this.isCrashing=!1,this.isRamping=!1,t===DM2.states.intro?this.app.fire(DM2.EVENT_TRIGGER,DM2.TRIGGER_END_INTRO):t===DM2.states.stopAttack?this.immediateStop():t===DM2.states.startAttack?this.app.fire(DM2.EVENT_TRIGGER,DM2.TRIGGER_BOSS_DEFEATED):t===DM2.states.outro&&(this.isZoomOutro=!0)},PlayerController.prototype.onInputUpdate=function(t){t===DM2.INPUT_LEFT_START?(this.isLeftDown=!0,this.wasLeftPressed=!0):t===DM2.INPUT_LEFT_END?(this.isLeftDown=!1,this.wasLeftReleased=!0):t===DM2.INPUT_RIGHT_START?(this.isRightDown=!0,this.wasRightPressed=!0):t===DM2.INPUT_RIGHT_END&&(this.isRightDown=!1,this.wasRightReleased=!0)},PlayerController.prototype.onEventTrigger=function(t){t===DM2.TRIGGER_TAKEOFF?this.flyTakeOff():t===DM2.TRIGGER_LAND?this.flyLand():t===DM2.TRIGGER_START_INTRO?this.startIntro():t===DM2.TRIGGER_LEVEL_END?(this.isComplete=!0,this.attackOnLevelEnd?this.startAttack():this.immediateStop()):t===DM2.TRIGGER_JUMP&&this.hillJump()},PlayerController.prototype.setupKeyboardInput=function(){var e=this.app;this.app.keyboard.on("keydown",function(t){t.key!==pc.KEY_LEFT&&t.key!==pc.KEY_A||(e.fire(DM2.EVENT_INPUT_UPDATE,DM2.INPUT_LEFT_START),t.event.preventDefault()),t.key!==pc.KEY_RIGHT&&t.key!==pc.KEY_D||(e.fire(DM2.EVENT_INPUT_UPDATE,DM2.INPUT_RIGHT_START),t.event.preventDefault())}),this.app.keyboard.on("keyup",function(t){t.key!==pc.KEY_LEFT&&t.key!==pc.KEY_A||(e.fire(DM2.EVENT_INPUT_UPDATE,DM2.INPUT_LEFT_END),t.event.preventDefault()),t.key!==pc.KEY_RIGHT&&t.key!==pc.KEY_D||(e.fire(DM2.EVENT_INPUT_UPDATE,DM2.INPUT_RIGHT_END),t.event.preventDefault())})},PlayerController.prototype.setDifficulty=function(){switch(DM2.getGameData()[DM2.SETTING_DIFFICULTY]){case DM2.DIFFICULTY_EASY:this.maxSpeed=DM2.easySettings.maxSpeed,this.minSpeed=DM2.easySettings.minSpeed,this.nitroSpeed=DM2.easySettings.nitroSpeed,this.vehicle.animSpeed=DM2.easySettings.animSpeed;break;case DM2.DIFFICULTY_TURBO:this.maxSpeed=DM2.turboSettings.maxSpeed,this.minSpeed=DM2.turboSettings.minSpeed,this.nitroSpeed=DM2.turboSettings.nitroSpeed,this.vehicle.animSpeed=DM2.turboSettings.animSpeed;break;default:this.maxSpeed=DM2.normalSettings.maxSpeed,this.minSpeed=DM2.normalSettings.minSpeed,this.nitroSpeed=DM2.normalSettings.nitroSpeed,this.vehicle.animSpeed=DM2.normalSettings.animSpeed}};var PlayerVehicle=pc.createScript("playerVehicle");PlayerVehicle.prototype.initialize=function(){this.isAnimating=!1,this.sfxManager=DM2.findSFXManagerForApp(this.app),this.vehicleEntity=this.entity.findByName("markiv"),this.colliderEntity=this.entity.parent.findByName("Collider"),this.collider=this.colliderEntity.collision,this.lazer=this.entity.findByName("lazer").script.playerLazer,this.pickupFX=this.entity.findByName("starburst"),this.lazerModel=this.lazer.entity.model,this.animator=this.vehicleEntity.animation,this.animator.activate=!1,this.isFlying=!1,this.isSteerLocked=!1,this.isBoosting=!1,this.isAnimationLocked=!1,this.isShootingLazers=!1,this.timer=0,this.forwardDelta=0,this.crashColorTimer=0,this.boosterTO=0,this.isAssetsLoaded=!1,this.markivMesh=null,this.markivModel=this.vehicleEntity.model,this.oversteerFXTO=0,this.pickupFXTO=0,this.lookatPos=new pc.Vec3,this.dir=0;var t=this.entity.parent.getPosition(),e=this.colliderEntity.getLocalPosition(),i=new pc.Vec3(t.x+e.x,t.y+e.y,t.z+e.z);this.AABB=new pc.BoundingBox(i,this.collider.halfExtents),this.delayedLocator=new pc.Entity;var s=new pc.Vec3;s.x=this.entity.getPosition().x,s.z=this.entity.getPosition().z-6,this.delayedLocator.setPosition(s),this.kickOutBuildUp=0,this.kickOutNow=0,this.kickOutTimer=0,this.markivModel.enabled=!1,this.lazerModel.enabled=!1,this.pickupFX.enabled=!1,this.app.on(DM2.EVENT_ASSETS_LOADED,this.onAllAssetsLoaded,this)},PlayerVehicle.prototype.step=function(t){if(this.isAssetsLoaded){if(this.AABB.center.x=this.entity.getLocalPosition().x,this.timer+=t,this.steerFunction&&this.steerFunction(t),0<this.pickupFXTO?this.pickupFXTO-=t:this.pickupFX.enabled&&(this.pickupFX.enabled=!1),this.updateInvincibleFlash(t),this.animationTimer&&this.animationTimer.t<=this.timer){var e=this.animationTimer.anim;this.animationTimer=null,this.onAnimationComplete(e)}this.isShootingLazers&&this.stepLazers(t),this.isFlying||this.updateDriveKickOut(t),this.isBoosterActive&&this.boosterTO<=0?this.setBoostersActive(!1):this.boosterTO-=t}},PlayerVehicle.prototype.setStartPosition=function(t){this.entity.setLocalPosition(t)},PlayerVehicle.prototype.startDriving=function(){this.playAnimation(DM2.states.drive,!0),this.sfxManager.play(DM2.SFX_CAR_ENGINE)},PlayerVehicle.prototype.setSlowSpeedBehaviour=function(){this.steerLag=1,this.maxSteerLag=.9,this.ovsFreq=3,this.ovsElast=.5,this.turnSpeed=10},PlayerVehicle.prototype.setFastSpeedBehaviour=function(){this.steerLag=1,this.maxSteerLag=2,this.ovsFreq=3,this.ovsElast=.5,this.turnSpeed=15},PlayerVehicle.prototype.playPickupFX=function(){this.pickupFX.enabled=!0,this.pickupFXTO=DM2.PICKUP_FX_TO,this.pickupFX.animation.play("starburst.json")},PlayerVehicle.prototype.boost=function(){this.isBoosting=!0,this.sfxManager.play(DM2.SFX_CAR_TURBO),this.sfxManager.play(DM2.SFX_DM_TURBO),this.sfxManager.play(DM2.SFX_PENFOLD_TURBO),this.setBoostersActive(!0),this.isFlying||this.playAnimationTimed(DM2.states.boostStart,!1)},PlayerVehicle.prototype.boostUp=function(){this.isBoosting?(this.sfxManager.play(DM2.SFX_CAR_TURBO),this.sfxManager.play(DM2.SFX_PENFOLD_TURBO)):this.boost()},PlayerVehicle.prototype.stopBoost=function(){this.isBoosting=!1,this.setBoostersActive(!1),this.isFlying||this.playAnimationTimed(DM2.states.boostStop,!1)},PlayerVehicle.prototype.setBoostersActive=function(i){(!0===i&&(this.boosterTO=1),this.isBoosterActive!==i)&&(this.isBoosterActive=i,this.entity.getChildren().map(function(t,e){"smoke"===t.name&&(t.model.enabled=i)}))},PlayerVehicle.prototype.crash=function(){this.isBoosting=!1,this.setBoostersActive(!1);var t=this.entity.getLocalPosition().clone(),e=new pc.Vec3(t.x,t.y,t.z+1);this.entity.lookAt(e),this.playAnimationTimed(DM2.states.driveCrash,!1),this.playCrashSFX()},PlayerVehicle.prototype.crashFlying=function(){this.isBoosting=!1,this.setBoostersActive(!1);var t=this.entity.getLocalPosition().clone(),e=new pc.Vec3(t.x,t.y,t.z+1);this.entity.lookAt(e),this.isAnimationLocked=!1,this.playAnimationTimed(DM2.states.flyCrash,!1),this.isAnimationLocked=!0,this.playCrashSFX()},PlayerVehicle.prototype.playCrashSFX=function(){switch(Math.floor(5*Math.random())){case 0:this.sfxManager.play(DM2.SFX_DM_HIT1);break;case 1:this.sfxManager.play(DM2.SFX_DM_HIT2);break;case 2:this.sfxManager.play(DM2.SFX_DM_HIT3);break;default:this.sfxManager.play(DM2.SFX_DM_HIT4)}switch(Math.floor(3*Math.random())){case 1:this.sfxManager.play(DM2.SFX_PENFOLD_HIT1);break;default:this.sfxManager.play(DM2.SFX_PENFOLD_HIT2)}},PlayerVehicle.prototype.takeOff=function(){this.isBoosting=!1,this.setBoostersActive(!1),this.sfxManager.play(DM2.SFX_CAR_WINGS),this.isAnimationLocked=!1,this.playAnimationTimed(DM2.states.takeoff,!1),this.isAnimationLocked=!0},PlayerVehicle.prototype.ramp=function(){this.isBoosting=!1,this.setBoostersActive(!1),this.sfxManager.play(DM2.SFX_DM_RAMP),this.sfxManager.play(DM2.SFX_CAR_RAMP),this.isAnimationLocked=!1,.5<pc.math.random(0,1)?this.playAnimationTimed(DM2.states.rampFly,!1):this.playAnimationTimed(DM2.states.rampJump,!1),this.isAnimationLocked=!0},PlayerVehicle.prototype.land=function(){this.isBoosting=!1,this.setBoostersActive(!1),this.sfxManager.play(DM2.SFX_CAR_WINGS),this.isAnimationLocked=!1,this.playAnimationTimed(DM2.states.land,!1),this.isAnimationLocked=!0},PlayerVehicle.prototype.hillJump=function(){this.isBoosting=!1,this.setBoostersActive(!1),this.stopLazers(!0),this.sfxManager.play(DM2.SFX_DM_RAMP),this.sfxManager.play(DM2.SFX_CAR_RAMP),this.isAnimationLocked=!1,this.currentState=null,this.playAnimationTimed(DM2.states.hillJump,!1),this.isAnimationLocked=!0},PlayerVehicle.prototype.handbrakeStop=function(){this.isSteerLocked=!0,this.steerFunction=null,this.stopLazers(!0),this.isAnimationLocked=!1,this.playAnimationTimed(DM2.states.outro,!1),this.isAnimationLocked=!0,this.sfxManager.fadeOut(DM2.SFX_CAR_ENGINE),this.sfxManager.play(DM2.SFX_CAR_BIG_SKID)},PlayerVehicle.prototype.playAttackSequence=function(){this.isSteerLocked=!0,this.playAnimationTimed(DM2.states.startAttack,!1)},PlayerVehicle.prototype.setupCarMode=function(){for(var t=DM2.getGameData(),e=t[DM2.SETTING_DIFFICULTY]===DM2.DIFFICULTY_TURBO,i=t[DM2.SETTING_DIFFICULTY]===DM2.DIFFICULTY_NORMAL,s=this.vehicleEntity.model.meshInstances,n=0;n<s.length;n++){var o=s[n];"flame_GEO"!==o.node.name&&"turbobooster_GEO"!==o.node.name||(o.visible=e),"spoiler_GEO"===o.node.name&&(o.visible=i)}},PlayerVehicle.prototype.startLazers=function(){this.playAnimationTimed(DM2.states.startLazers,!1),this.sfxManager.play(DM2.SFX_LAZER_PICKUP),this.lazerTO=DM2.configPlayer.lazerDuration,this.isAnimationLocked=!0},PlayerVehicle.prototype.stepLazers=function(t){if(0<this.lazerTO)if(this.lazerTO-=t,this.lazerTO<=0)this.stopLazers();else{this.lazerModel.enabled||(this.lazerModel.enabled=!0);var e=this.lazer.entity.getPosition().clone();e.sub(this.entity.getPosition().clone()),e.y=0,this.lazer.checkCollisions(e,t)}},PlayerVehicle.prototype.stopLazers=function(t){t?(this.animationTimer=null,this.isShootingLazers=!1,this.isAnimationLocked=!1):(this.isAnimationLocked=!1,this.playAnimationTimed(DM2.states.stopLazers,!1),this.isAnimationLocked=!0),this.sfxManager.stop(DM2.SFX_CAR_LAZERS),this.lazerModel.enabled=!1},PlayerVehicle.prototype.steerToPosition=function(t,e){this.isSteerLocked?this.forwardDelta=0:(this.steerFunction=null,this.isFlying?this.airSteerToPosition(t,e):this.groundSteerToPos(t,e))},PlayerVehicle.prototype.snapToLane=function(t){this.isSteerLocked||(this.isFlying?this.airSnapToLane(t):this.groundSnapToLane(t))},PlayerVehicle.prototype.oversteerBend=function(t,e,i,s){this.oversteerFXTO<=0?(this.oversteerFXTO=2,this.sfxManager.play(DM2.SFX_CAR_BIG_SKID)):this.oversteerFXTO-=s;var n=this.delayedLocator.getPosition().clone();n.x=this.entity.getPosition().x+t*e,n.z=this.entity.getPosition().z+2,n.lerp(this.delayedLocator.getPosition(),n,s*i),this.delayedLocator.setPosition(n)},PlayerVehicle.prototype.groundSteerToPos=function(t,e){this.kickOut=0,this.kickOutTimer=0,this.steerFunction=null,this.kickOutBuildUp+=e,this.kickOutNow=0;var i=this.entity.getLocalPosition(),s=t.x-i.x,n=0<s?1:-1,o=e*this.turnSpeed*n;1===(this.dir=n)&&0<=this.forwardDelta||-1===n&&this.forwardDelta<=0?Math.abs(s)>e*this.turnSpeed?i.x+=o:i.x=t.x:o*=1.5,(1===n&&this.forwardDelta<this.maxSteerLag||-1===n&&this.forwardDelta>-this.maxSteerLag)&&(this.forwardDelta+=this.steerLag*o),this.entity.setLocalPosition(i.x,i.y,i.z),0<n?this.isBoosting?this.playAnimationTimed(DM2.states.boostLeft,!1):this.isShootingLazers?this.playAnimationTimed(DM2.states.shootLazersLeft,!1):this.isAnimationLocked||this.playAnimationTimed(DM2.states.driveLeft,!1):n<0&&(this.isBoosting?this.playAnimationTimed(DM2.states.boostRight,!1):this.isShootingLazers?this.playAnimationTimed(DM2.states.shootLazersRight,!1):this.isAnimationLocked||this.playAnimationTimed(DM2.states.driveRight,!1))},PlayerVehicle.prototype.groundSnapToLane=function(o){this.isAnimationLocked||this.app.fire(DM2.EVENT_TRIGGER_SFX,DM2.SFX_CAR_SKID),this.steerFunction=function(t){var e=this.entity.getLocalPosition(),i=o.x-this.entity.getLocalPosition().x,s=0<i?1:-1,n=t*this.turnSpeed*s;Math.abs(i)>t*this.turnSpeed?e.x+=n:e.x=o.x,this.entity.setLocalPosition(e.x,e.y,e.z)}.bind(this)},PlayerVehicle.prototype.airSteerToPosition=function(t,e){var i=this.entity.getLocalPosition().clone(),s=t.x-i.x,n=0<s?1:-1,o=e*this.turnSpeed*n;1===(this.dir=n)&&0<=this.forwardDelta||-1===n&&this.forwardDelta<=0?Math.abs(s)>e*this.turnSpeed?i.x+=o:i.x=t.x:o*=1.5,(1===n&&this.forwardDelta<this.maxSteerLag||-1===n&&this.forwardDelta>-this.maxSteerLag)&&(this.forwardDelta+=this.steerLag*o),this.entity.setLocalPosition(i),this.entity.setEulerAngles(0,0,-10*this.forwardDelta)},PlayerVehicle.prototype.airSnapToLane=function(o){var r=this.entity,a=this;this.forwardDelta,this.forwardDelta,this.ovsElast;this.steerFunction=function(t){var e=r.getLocalPosition().clone(),i=o.x-r.getLocalPosition().x,s=0<i?1:-1,n=t*a.turnSpeed*s;Math.abs(i)>t*a.turnSpeed?e.x+=n:e.x=o.x,r.setLocalPosition(e),0!==a.forwardDelta&&(0<a.forwardDelta?a.forwardDelta-=.1:a.forwardDelta+=.1,Math.abs(a.forwardDelta)<.2&&(a.forwardDelta=0),a.entity.setEulerAngles(0,0,-10*this.forwardDelta))}},PlayerVehicle.prototype.updateDriveKickOut=function(t){var e=this.delayedLocator.getPosition(),i=pc.math.clamp(10*t,0,1);this.kickOutTimer+=2*t;var s=this.kickOutTimer;s=pc.math.clamp(s,0,1);var n=.5+.5*Math.sin(2*Math.PI*(s-.25));0<this.kickOutBuildUp&&(this.kickOutBuildUp+=20*t*t),1<=s&&(this.kickOutBuildUp=0),this.kickOutBuildUp=pc.math.clamp(this.kickOutBuildUp,0,1),this.kickOut=this.kickOutBuildUp*pc.math.clamp(n,0,1),this.lookatPos.x=pc.math.lerp(e.x,this.entity.getPosition().x+this.kickOut*this.dir,i),this.lookatPos.y=e.y,this.lookatPos.z=pc.math.lerp(e.z,this.entity.getPosition().z-6+4*this.kickOutBuildUp,i),this.delayedLocator.setPosition(this.lookatPos),this.entity.lookAt(this.delayedLocator.getLocalPosition())},PlayerVehicle.prototype.snapCenterForward=function(){this.steerFunction=null,this.kickOut=0,this.kickOutTimer=0,this.kickOutBuildUp=0,this.kickOutNow=0,this.forwardDelta=0,this.lookatPos.x=this.entity.getPosition().x+pc.Vec3.FORWARD.x,this.lookatPos.y=this.entity.getPosition().y+pc.Vec3.FORWARD.y,this.lookatPos.z=this.entity.getPosition().z+pc.Vec3.FORWARD.z,this.entity.lookAt(this.lookatPos),this.delayedLocator.setPosition(this.lookatPos)},PlayerVehicle.prototype.playAnimation=function(t,e,i){this.currentState===t||this.isAnimationLocked||(t===DM2.states.rampJump||t===DM2.states.rampFly?this.animator.speed=this.animSpeed:this.animator.speed=1,this.currentState=t,this.currentAnimation=this.animator.getAnimation(t),0<i?this.animator.play(t,i):this.animator.play(t),this.animator.loop=e)},PlayerVehicle.prototype.playAnimationTimed=function(t,e){if(this.currentState!==t&&!this.isAnimationLocked){this.playAnimation(t,!1,e);var i=this.timer+this.currentAnimation.duration;this.animationTimer={t:i,anim:t}}},PlayerVehicle.prototype.onAnimationComplete=function(t){if(this.isAnimationLocked=!1,this.currentState=null,t!==DM2.states.outro){if(t===DM2.states.takeoff?(this.isFlying=!0,this.snapCenterForward()):t===DM2.states.land&&(this.isFlying=!1,this.snapCenterForward()),t===DM2.states.startLazers)return this.sfxManager.play(DM2.SFX_CAR_LAZERS),this.playAnimation(DM2.states.shootLazers,!0),void(this.isShootingLazers=!0);t===DM2.states.stopLazers&&(this.isShootingLazers=!1),t===DM2.states.startAttack?(this.sfxManager.play(DM2.SFX_CAR_MISSILE),this.playAnimationTimed(DM2.states.shootMissiles,!1)):t===DM2.states.shootMissiles?this.playAnimationTimed(DM2.states.stopAttack,!1):this.isFlying?this.playAnimation(DM2.states.fly,!0):this.isBoosting?this.playAnimation(DM2.states.boost,!0):this.isShootingLazers?this.playAnimation(DM2.states.shootLazers,!0):this.playAnimation(DM2.states.drive,!0),this.app.fire(DM2.EVENT_ANIM_COMPLETED,t)}else this.app.fire(DM2.EVENT_ANIM_COMPLETED,t)},PlayerVehicle.prototype.updateInvincibleFlash=function(t){this.markivMesh},PlayerVehicle.prototype.onAllAssetsLoaded=function(){for(var t=0;t<this.vehicleEntity.model.meshInstances.length;t++){var e=this.vehicleEntity.model.meshInstances[t];"markiv_GEO"===e.node.name&&(this.markivMesh=e)}this.markivModel.enabled=!0,this.setSlowSpeedBehaviour(),this.setupCarMode(),this.isAssetsLoaded=!0},(DM2=DM2||{}).EVENT_TRIGGER="dm:event_trigger",DM2.EVENT_ANIM_COMPLETED="dm:anim_completed",DM2.EVENT_SEGMENT_REQ="dm:segment_req",DM2.EVENT_INPUT_UPDATE="dm:input_update",DM2.EVENT_TRIGGER_SFX="dm:trigger_sfx",DM2.EVENT_TIMER_UPDATE="dm:timer_update",DM2.EVENT_SCENE_LOADED="dm:scene_loaded",DM2.EVENT_ARIA_UPDATE="dm:aria_live_update",DM2.EVENT_BUTTON_CLICK="dm:button_clicked",DM2.EVENT_TOGGLE_PAUSE="dm:toggle_pause",DM2.EVENT_TOGGLE_SETTINGS="dm:toggle_settings",DM2.EVENT_TOGGLE_HOWTO="dm:toggle_howto",DM2.EVENT_INPUT_PROCESSED="dm:input_processed",DM2.EVENT_GAME_CONTINUE="dm:game_continue",DM2.EVENT_LEVEL_RESTART="dm:level_restart",DM2.EVENT_LEVEL_SELECT="dm:level_select",DM2.EVENT_TOGGLE_SFX="dm:toggle_sfx",DM2.EVENT_TOGGLE_SPEEDFX="dm:toggle_speedfx",DM2.EVENT_PLAY_VOICEOVER="dm:play_voice_over",DM2.EVENT_ASSETS_LOADED="dm:assets_loaded",DM2.TRIGGER_TAKEOFF="fly",DM2.TRIGGER_LAND="land",DM2.TRIGGER_JUMP="jump",DM2.TRIGGER_START_INTRO="start_into",DM2.TRIGGER_END_INTRO="end_intro",DM2.TRIGGER_DM_ATTACK="dm_attack",DM2.TRIGGER_BOSS_DEFEATED="boss_defeat",DM2.TRIGGER_LEVEL_END="level_end",DM2.INPUT_NONE=0,DM2.INPUT_LEFT_START=1,DM2.INPUT_RIGHT_START=2,DM2.INPUT_LEFT_END=3,DM2.INPUT_RIGHT_END=4,DM2.INPUT_SPEED_START=5,DM2.INPUT_SPEED_END=6,DM2.INPUT_TOGGLE_PAUSE=7,DM2.SETTING_SPEED_FX="dm_speed_fx_disabled",DM2.SETTING_DIFFICULTY="dm_difficulty",DM2.SETTING_STAR_COUNT="dm_star_count",DM2.SETTING_HAS_PLAYED="dm_has_played",DM2.SETTING_BLUEPRINTS="dm_blueprints",DM2.LOCATION_LONDON="london",DM2.LOCATION_TOKYO="tokyo",DM2.LOCATION_SPACE="space",DM2.LOCATION_TRENCH="trench",DM2.LOCATION_FACTORY="factory",DM2.DIFFICULTY_EASY="easy",DM2.DIFFICULTY_NORMAL="normal",DM2.DIFFICULTY_TURBO="turbo",DM2.SFX_CAR_BIG_SKID="car_big_skid",DM2.SFX_CAR_CRASH="car_crash",DM2.SFX_CAR_ENGINE="car_engine",DM2.SFX_CAR_MISSILE="car_missile",DM2.SFX_CAR_RAMP="car_ramp",DM2.SFX_CAR_SKID="car_skid",DM2.SFX_CAR_TURBO="car_turbo",DM2.SFX_CAR_WINGS="car_wings",DM2.SFX_CAR_LAZERS="car_lazers",DM2.SFX_DM_TURBO="dm_turbo",DM2.SFX_DM_RAMP="dm_ramp",DM2.SFX_DM_HIT1="dm_hit1",DM2.SFX_DM_HIT2="dm_hit2",DM2.SFX_DM_HIT2="dm_hit2",DM2.SFX_DM_HIT3="dm_hit3",DM2.SFX_PENFOLD_HIT1="penfold_hit1",DM2.SFX_PENFOLD_HIT2="penfold_hit2",DM2.SFX_PENFOLD_TURBO="penfold_turbo",DM2.SFX_NARR_LOC_INTRO="narr_location_intro",DM2.SFX_NARR_LOC_COMPLETE="narr_location_complete",DM2.SFX_NARR_TITLE="narr_title",DM2.SFX_SCORE_1="score1",DM2.SFX_SCORE_2="score2",DM2.SFX_SCORE_3="score3",DM2.SFX_LOADING_START="loading_start",DM2.SFX_COLLECTIBLE_PICKUP="collectible_pickup",DM2.SFX_LAZER_PICKUP="laser_pickup",DM2.SFX_MUSIC_TRACK="music_track",DM2.SFX_MUSIC_RESULTS="music_results",DM2.SFX_MUSIC_TITLE="music_title",DM2.SFX_BOSS_ATTACK="boss_attack",DM2.SFX_BOSS_LAUGH="boss_laugh",DM2.states={drive:"markiv_drive.json",fly:"markiv_fly.json",takeoff:"markiv_drive2fly.json",land:"markiv_fly2drive.json",flyRight:"markiv_flyright.json",flyLeft:"markiv_flyleft.json",flyCrash:"markiv_flycrash.json",driveRight:"markiv_driveright.json",driveLeft:"markiv_driveleft.json",driveRightFast:"markiv_driverightfast.json",driveLeftFast:"markiv_driveleftfast.json",driveCrash:"markiv_drivecrash.json",rampFly:"markiv_driverampfly.json",rampJump:"markiv_driveramproll.json",intro:"markiv_intro.json",boostStart:"markiv_drive2boost.json",boost:"markiv_boost.json",boostLeft:"markiv_boostleft.json",boostRight:"markiv_boostright.json",boostStop:"markiv_boost2drive.json",outro:"markiv_outro.json",startAttack:"markiv_drive2shoot.json",shootMissiles:"markiv_shoot.json",stopAttack:"markiv_shoot2drive.json",hillJump:"markiv_drivehilljump.json",startLazers:"markiv_drive2laser.json",stopLazers:"markiv_laser2drive.json",shootLazers:"markiv_laser.json",shootLazersLeft:"markiv_laserleft.json",shootLazersRight:"markiv_laserright.json"},DM2.bossStates={intro:"boss_intro.json",idle:"boss_drive.json",flyLeft:"boss_drive.json",flyRight:"boss_drive.json",attack:"boss_shoot.json",taunt:"boss_taunt.json",quickIntro:"boss_quickintro.json",defeated:"boss_outro.json"},DM2.voiceOver={anyPortal:"any_portal",back:"back",bossLevel:"boss_level",close:"close",continue:"continue",easy:"easy",exit:"exit",flushAndFurious:"flush_and_furious",greenbackInTime:"greenback_in_time",home:"home",howToPlay:"how_to_play",levelSelect:"level_select",next:"next",normal:"normal",pause:"pause",piesTheLimit:"pies_the_limit",planetOfTheFakes:"planet_of_the_fakes",play:"play",playAgain:"play_again",previous:"previous",settings:"settings",skip:"skip",toggleSound:"toggle_sound",toggleSpeedFX:"toggle_speed_effects",trackOne:"track_one",trackTwo:"track_two",turbo:"turbo"},DM2.BMI_ACTION_PAUSE="pause",DM2.BMI_ACTION_UNPAUSE="unpause",DM2.BMI_ACTION_SETTINGS="settings",DM2.BMI_ACTION_HOWTO="how_to_play",DM2.BMI_ACTION_HOME="home",DM2.BMI_ACTION_RESTART="restart",DM2.BMI_ACTION_CONTINUE="continue",DM2.BMI_ACTION_BACK="back",DM2.BMI_ACTION_MUTE="mute",DM2.BMI_ACTION_UNMUTE="unmute",DM2.BMI_ACTION_PLAY="play",DM2.SCREEN_ID_GAME="game",DM2.SCREEN_ID_TITLE="title",DM2.SCREEN_ID_TRACK="track_select",DM2.SCREEN_ID_DIFFICULTY="difficulty_select",DM2.SCREEN_ID_CHAPTER="chapter_select",DM2.SCREEN_ID_BRIEFING="briefing",DM2.SCREEN_ID_PAUSE="pause",DM2.SCREEN_ID_RESULT="results",DM2.SCREEN_ID_HOWTO="how_to_play",DM2.SCREEN_ID_INTRO="intro";var PropManager=pc.createScript("propManager");PropManager.prototype.initialize=function(){this.trackLanes=this.app.root.findByName("TrackLanes").script.trackLanes,this.trackRunner=this.app.root.findByName("TrackRunner").script.trackRunner,this.levelController=this.app.root.findByName("LevelController").script.levelController,this.bendFactor=0,this.speed=0,this.children=this.entity.getChildren(),this.props={},this.activeProps=Array.apply(0,new Array(1e3)).map(function(t){}),this.insertIndex=0,this.activeCount=0,this.cachedFlag={},this.propYOffset={};for(var t=0;t<this.children.length;t++){var e=this.children[t];this.props[e.name]=e,this.cachedFlag[e.name]=!1}this.on("disable",this.onDisable)},PropManager.prototype.getPropID=function(t){return"generic"===t.typeID?t.trigger:t.typeID},PropManager.prototype.cacheProp=function(t,e){if(!0!==this.cachedFlag[t]){var i=this.props[t];if(i){for(var s=0;s<e;s++){if(i.script.propRenderer)if(this.propYOffset[t]=i.getPosition().y,!DM2.LOWMEM)this.spawnFromPrefab(i,new pc.Vec3(10,0,100),null).hit=!0}this.cachedFlag[t]=!0}}},PropManager.prototype.spawnProp=function(t,e){var i=this.getPropID(t),s="generic"===t.typeID?null:t.trigger,n=new pc.Vec3(0,0,0);n.x=this.trackLanes.getPosForLane(t.lane).x,n.z=e+(8-4*t.row);var o=this.recycleProp(i,n,s);if(!o){var r=this.props[i];r&&(o=this.spawnFromPrefab(r,n,s))}return"blueprint"===i&&this.levelController.registerBlueprint(o),o},PropManager.prototype.spawnPropDirect=function(t,e,i){var s=this.recycleProp(t,e,i);if(s)result=s;else{var n=this.props[t];n&&(result=this.spawnFromPrefab(n,e,i))}return result},PropManager.prototype.step=function(t,e){this.cleanupActiveProps();for(var i=this.trackRunner.ctrlOrigin,s=this.trackRunner.ctrlForward,n=0;n<this.activeCount;n++){var o=this.activeProps[n];o.enabled&&this.updateProp(o,t,e,i,s)}this.bossEntity&&this.updateBoss(this.bossEntity,i,s)},PropManager.prototype.updateProp=function(t,e,i,s,n){t.script.propBase.step(e,i);var o=t.script.propRenderer,r=t.getPosition();if(o){var a=this.trackRunner.getNearestSegment(r.z);if(a){var l=a.controlPoints,h=(a.getPosition().z-r.z)/DM2.SEGMENT_SCALE;o.setControlPoints(s,n,l[0],l[1],l[2],l[3],h,e)}}r.z-=e*i,t.setPosition(r)},PropManager.prototype.cleanupActiveProps=function(){for(var t=0;t<this.activeCount;t++){var e=this.activeProps[t];if((e.getPosition().z<-2*DM2.SEGMENT_SCALE&&e.enabled||e.hit)&&(e.script.propBase.resetProp(),e.enabled=!1,e.hit=!1,0<this.activeCount)){var i=this.activeProps[this.activeCount-1];this.activeProps[this.activeCount-1]=e,this.activeProps[t]=i,this.activeCount--}}},PropManager.prototype.spawnFromPrefab=function(t,e,i){var s=t.clone(),n=DM2.configPropRender[t.name];if(n){var o=s.script.propRenderer;o.uXRotCorrection=n.uXRotCorrection,o.uYRotCorrection=n.uYRotCorrection}if(e.y=this.propYOffset[t.name]||0,s.setPosition(e),s.enabled=!0,s.triggerName=i,this.activeProps[this.insertIndex]=s,0<this.activeCount){var r=this.activeProps[this.activeCount];this.activeProps[this.activeCount]=s,this.activeProps[this.insertIndex]=r}return this.insertIndex++,this.activeCount++,s},PropManager.prototype.recycleProp=function(t,e,i){var s;if(0<this.insertIndex){for(var n=this.activeCount;n<this.insertIndex;n++){if((s=this.activeProps[n]).name===t&&!s.enabled){var o=this.activeProps[this.activeCount];this.activeProps[this.activeCount]=s,this.activeProps[n]=o,this.activeCount++;break}s=null}s&&(e.y=this.propYOffset[s.name]||0,s.setPosition(e),s.enabled=!0,s.triggerName=i)}return s},PropManager.prototype.onDisable=function(){this.off("disable",this.onDisable),this.activeProps.map(function(t,e){t&&t.destroy()}),this.props={},this.activeProps=[],this.cachedProps=[]};var BombProp=pc.createScript("bombProp");BombProp.prototype.initialize=function(){this.propBase=this.entity.script.propBase,this.children=this.entity.getChildren(),this.explosion=this.entity.findByName("explosion"),this.propBase.registerCallbacks(this.onCollision,this.onResetProp,this)},BombProp.prototype.onCollision=function(t){this.explosion&&(this.explosion.animation.play("explode.json"),this.explosion.model.enabled=!0),this.app.fire(DM2.EVENT_TRIGGER_SFX,DM2.SFX_CAR_CRASH),this.entity.model.enabled=!1,t.crashVehicle()},BombProp.prototype.onResetProp=function(){this.explosion&&this.explosion.animation.currAnim&&(this.explosion.animation.currentTime=0,this.explosion.model.enabled=!1),this.entity.model.enabled=!0};var NitroProp=pc.createScript("nitroProp");NitroProp.prototype.initialize=function(){this.propBase=this.entity.script.propBase,this.propBase.registerCallbacks(this.onCollision,this.onResetProp,this)},NitroProp.prototype.onCollision=function(t){t.pickupNitro(),this.entity.model.enabled=!1},NitroProp.prototype.onResetProp=function(){this.entity.model.enabled=!0};var GameUi=pc.createScript("gameUi");GameUi.attributes.add("hudMobileContent",{type:"asset",assetType:"html",title:"HUD Mobile HTML"}),GameUi.attributes.add("hudDesktopContent",{type:"asset",assetType:"html",title:"HUD Desktop HTML"}),GameUi.prototype.initialize=function(){GameUi.divContent=document.querySelector(".gameHud"),GameUi.divContent||(GameUi.divContent=document.createElement("div"),GameUi.divContent.classList.add("gameHud"),this.injectContent()),pc.platform.mobile?GameUi.divContent.innerHTML=this.hudMobileContent.resource||"":GameUi.divContent.innerHTML=this.hudDesktopContent.resource||"",DM2.setGameHolderTouchEnabled(!1),this.bindEvents(),this.setHUDVisible(!1)},GameUi.prototype.setHUDVisible=function(t){GameUi.divContent.style.display=t?"block":"none"},GameUi.prototype.closeLoadingOverlay=function(t,e,i){var s=this.app.root.findByName("InGameLoadingOverlay"),n=s.script.loadingUi;t&&s.reparent(t),n.setVisibleOpen(),n.playCloseAnimation(e,i)},GameUi.prototype.openLoadingOverlay=function(t,e,i){var s=this.app.root.findByName("InGameLoadingOverlay"),n=s.script.loadingUi;t&&s.reparent(t),n.playOpenAnimation(e,i)},GameUi.prototype.setProgress=function(t){var e="calc("+t+"% - 12vh)";this.progressFill&&(this.progressFill.style.width=e),this.progressIcon&&(this.progressIcon.style.left=e)},GameUi.prototype.onAriaLiveUpdate=function(t){var e=GameUi.divContent.querySelector(".ariaReader");e.innerHTML===t&&(t+=" again"),e.innerHTML=t},GameUi.prototype.onInputProcessed=function(t){GameUi.divContent.querySelector(".desktopTipDisplay").style.display="none"},GameUi.prototype.bindEvents=function(){var e=this.app,i=e.root.findByName("PlayerController").script.playerController,t=GameUi.divContent.querySelector(".pause"),s=DM2.getFullLevelName();if(t){DM2.addEventListeners(t,function(){DM2.sendActionEvent(DM2.BMI_ACTION_PAUSE,s),e.fire(DM2.EVENT_TOGGLE_PAUSE,!0,!0)},DM2.voiceOver.pause,this.app),t.focus()}window.onblur=function(t){"block"!==GameUi.divContent.style.display||i.isStopped||e.fire(DM2.EVENT_TOGGLE_PAUSE,!0,!0)},e.on(DM2.EVENT_ARIA_UPDATE,this.onAriaLiveUpdate,this),pc.platform.mobile?this.bindMobileEvents():e.on(DM2.EVENT_INPUT_PROCESSED,this.onInputProcessed,this),this.progressFill=GameUi.divContent.querySelector(".progressFill"),this.progressIcon=GameUi.divContent.querySelector(".progressIcon")},GameUi.prototype.bindMobileEvents=function(){var e=this.app,i=GameUi.divContent.querySelector(".buttonLeft");i&&(i.addEventListener("touchstart",function(t){e.fire(DM2.EVENT_INPUT_UPDATE,DM2.INPUT_LEFT_START),i.classList.add("buttonLeftActive"),t.preventDefault()},!1),i.addEventListener("touchend",function(t){e.fire(DM2.EVENT_INPUT_UPDATE,DM2.INPUT_LEFT_END),i.classList.remove("buttonLeftActive"),t.preventDefault()},!1),i.addEventListener("touchcancel",function(t){e.fire(DM2.EVENT_INPUT_UPDATE,DM2.INPUT_LEFT_END),i.classList.remove("buttonLeftActive"),t.preventDefault()},!1),i.addEventListener("touchmove",function(t){t.preventDefault()}),pc.platform.ios&&i.addEventListener("gesturestart",function(t){t.preventDefault()}));var s=GameUi.divContent.querySelector(".buttonRight");s&&(s.addEventListener("touchstart",function(t){e.fire(DM2.EVENT_INPUT_UPDATE,DM2.INPUT_RIGHT_START),s.classList.add("buttonRightActive"),t.preventDefault()},!1),s.addEventListener("touchend",function(t){e.fire(DM2.EVENT_INPUT_UPDATE,DM2.INPUT_RIGHT_END),s.classList.remove("buttonRightActive"),t.preventDefault()},!1),s.addEventListener("touchcancel",function(t){e.fire(DM2.EVENT_INPUT_UPDATE,DM2.INPUT_RIGHT_END),s.classList.remove("buttonRightActive"),t.preventDefault()},!1),s.addEventListener("touchmove",function(t){t.preventDefault()}),pc.platform.ios&&s.addEventListener("gesturestart",function(t){t.preventDefault()}))},GameUi.prototype.injectContent=function(){var t=DM2.getGameHolder();t?t.appendChild(GameUi.divContent):document.body.appendChild(GameUi.divContent)};var GameEngine=pc.createScript("gameEngine");GameEngine.prototype.initialize=function(){this.timer=0,this.tickTimer=0,this.gameUi=this.app.root.findByName("GameUi").script.gameUi,this.speedFX=this.app.root.findByName("SpeedFX"),this.levelController=this.app.root.findByName("LevelController").script.levelController,this.playerController=this.app.root.findByName("PlayerController").script.playerController,this.gameCamera=this.app.root.findByName("GameCamera").camera,this.resultScreen=this.app.root.findByName("ResultScreen"),this.generalUiScreen=this.app.root.findByName("GeneralUIScreen"),this.sfxManager=DM2.findSFXManagerForApp(this.app),this.globalTimers=[0,0,0,0,0,0,0,0,0],this.gameCamera.enabled=!1,DM2.LOWMEM?this.assetTag=this.levelController.assetTag+"-sd":this.assetTag=this.levelController.assetTag+"-hd",this.hasPlayedIntro=!1,this.isTimerEnabled=!1,this.isPaused=!0,this.isLevelComplete=!1,this.resultDelayTick=0,this.app.root.findByName("BossController")?this.resultDelay=DM2.resultDelay[this.levelController.assetTag]||DM2.resultDelay.factory:this.resultDelay=DM2.resultDelay.default,this.hasStartedLoading=!1,this.hasLoadedAssets=!1,this.loadTimeout=DM2.LOAD_TIMEOUT,this.prewarmFrames=0,this.app.on(DM2.EVENT_TRIGGER,this.onEventTrigger,this),this.app.on(DM2.EVENT_TRIGGER_SFX,this.onSFXTrigger,this),this.app.on(DM2.EVENT_TOGGLE_PAUSE,this.setPaused,this),this.app.on(DM2.EVENT_GAME_CONTINUE,this.onContinueGame,this),this.app.on(DM2.EVENT_LEVEL_RESTART,this.onRestartLevel,this),this.app.on(DM2.EVENT_LEVEL_SELECT,this.onLevelSelect,this),this.app.on(DM2.EVENT_TOGGLE_SPEEDFX,this.onToggleSpeedFX,this);var t=DM2.getFullLevelName(),e=DM2.getLevelName();DM2.setHeartbeatData(t,e),DM2.lastChapterPlayed=DM2.getChapterNameForAssetTag(this.levelController.assetTag),DM2.putGameData(DM2.SETTING_HAS_PLAYED,!0),DM2.sendLevelStarted(),this.onToggleSpeedFX(DM2.getGameData()[DM2.SETTING_SPEED_FX]),this.starRatings=DM2.trackStarConfig[e],this.app.scene.fogColor=this.gameCamera.clearColor.clone()},GameEngine.prototype.update=function(t){this.hasStartedLoading||(this.hasStartedLoading=!0,this.loadTimeout=DM2.LOAD_TIMEOUT,this.loadAssetsForTag(this.assetTag)),DM2.LOWMEM&&!this.hasLoadedAssets&&0<this.loadTimeout&&(this.loadTimeout-=t,this.loadTimeout<=0&&(this.hasLoadedAssets=!0)),this.hasLoadedAssets&&(this.hasPublishedEvent?this.prewarmFrames<DM2.PREWARM_FRAMES?(this.prewarmFrames+=1,1<this.prewarmFrames&&this.step(t)):this.hasPlayedIntro?this.step(t):(this.app.fire(DM2.EVENT_TRIGGER,DM2.TRIGGER_START_INTRO),this.gameUi.openLoadingOverlay(),this.hasPlayedIntro=!0,this.setPaused(!1)):(this.levelController.preWarmAssets(),this.app.fire(DM2.EVENT_ASSETS_LOADED),this.gameCamera.enabled=!0,this.hasPublishedEvent=!0),this.isLevelComplete&&this.resultDelayTick<this.resultDelay&&(this.resultDelayTick+=t,this.resultDelayTick>this.resultDelay&&!this.resultScreen.enabled&&this.showResultScreen()))},GameEngine.prototype.togglePaused=function(){this.setPaused(!this.isPaused)},GameEngine.prototype.setPaused=function(t){this.isPaused=t,this.isPaused?this.app.timeScale=0:this.app.timeScale=1},GameEngine.prototype.showResultScreen=function(){this.gameUi.closeLoadingOverlay(this.generalUiScreen,function(){var t=DM2.getGameData()[DM2.SETTING_DIFFICULTY],e=this.getPlayerScore(t);this.resultScreen.enabled=!0,this.resultScreen.script.resultUi.setScore(e),this.updateTotalStarCount(e.totalStars,t),this.sfxManager.stop(DM2.SFX_MUSIC_TRACK),this.sfxManager.play(DM2.SFX_MUSIC_RESULTS),this.gameUi.openLoadingOverlay(this.resultScreen);var i=[];e.noCrashes&&i.push("crash"),e.underTime&&i.push("time"),e.allBlueprints&&i.push("collect");var s=this.toMMSS(this.tickTimer);DM2.sendLevelCompleted(e,s,!0,i)},this)},GameEngine.prototype.step=function(t){this.isPaused||(this.stepTimer(t),this.stepGlobalTimers(t),this.levelController.step(t),this.playerController.step(t),this.gameUi.setProgress(this.levelController.progress))},GameEngine.prototype.getPlayerScore=function(t){var e={noCrashes:!1,underTime:!1,allBlueprints:!1,blueprintScore:"0/0",totalStars:0,totalTime:"",bestTime:"",targetTime:""};e.noCrashes=this.playerController.crashCount<1,this.starRatings&&(t===DM2.DIFFICULTY_EASY?(e.targetTime="Under: "+this.toMMSS(this.starRatings[0]),this.tickTimer<=this.starRatings[0]&&(e.underTime=!0)):t===DM2.DIFFICULTY_TURBO?(e.targetTime="Under: "+this.toMMSS(this.starRatings[2]),this.tickTimer<=this.starRatings[2]&&(e.underTime=!0)):(e.targetTime="Under: "+this.toMMSS(this.starRatings[1]),this.tickTimer<=this.starRatings[1]&&(e.underTime=!0)));var i=this.levelController.blueprintCount,s=this.playerController.blueprintCount;e.allBlueprints=i===s,e.blueprintScore=s+"/"+i,e.totalStars+=e.noCrashes?1:0,e.totalStars+=e.underTime?1:0,e.totalStars+=e.allBlueprints?1:0,e.totalTime=this.toMMSS(this.tickTimer);var n="best_"+this.levelController.trackData.name.replace(".json","_"+t),o=DM2.getGameData()[n];return(!o||this.tickTimer<o)&&(o=this.tickTimer,DM2.putGameData(n,o)),e.bestTime="Best:"+this.toMMSS(o),e},GameEngine.prototype.updateTotalStarCount=function(t,e){var i="score_"+this.levelController.trackData.name.replace(".json","_"+e),s=DM2.getGameData()[i],n=0;s?s<t&&(n=t-s,s=t):s=n=t,DM2.putGameData(i,s);var o=DM2.getGameData()[DM2.SETTING_STAR_COUNT];o||(o=0),0<n&&(o+=n),DM2.putGameData(DM2.SETTING_STAR_COUNT,o)},GameEngine.prototype.stepTimer=function(t){this.isTimerEnabled&&(this.timer+=t,1<this.timer&&this.tickTimer<999&&(this.tickTimer++,this.timer=0))},GameEngine.prototype.stepGlobalTimers=function(t){this.globalTimers[0]+=t,this.globalTimers[1]+=1.5*t},GameEngine.prototype.toMMSS=function(t){var e=Math.floor(t/3600),i=Math.floor((t-3600*e)/60),s=t-3600*e-60*i;return s<10&&(s="0"+s),i+"m "+s+"s"},GameEngine.prototype.onEventTrigger=function(t){t===DM2.TRIGGER_END_INTRO?(this.playerController.startDriving(),this.gameUi.setHUDVisible(!0),this.isTimerEnabled=!0):t===DM2.TRIGGER_LEVEL_END&&(this.gameUi.setHUDVisible(!1),this.isTimerEnabled=!1,this.isLevelComplete=!0)},GameEngine.prototype.onSFXTrigger=function(t){DM2.isMuted||this.entity.sound.play(t)},GameEngine.prototype.onToggleSpeedFX=function(t){this.speedFX.enabled=!t},GameEngine.prototype.onAssetReady=function(t){this.loadCount++,this.loadCount==this.assetList.length&&this.publishAllAssetsLoaded()},GameEngine.prototype.onAssetError=function(t,e){this.loadCount++,console.log(t),e.off("error",this.onAssetError,this)},GameEngine.prototype.onContinueGame=function(){this.setPaused(!1),this.gotoTitleScene()},GameEngine.prototype.onRestartLevel=function(){this.setPaused(!1),DM2.replayLastLevel=!0,this.gotoTitleScene()},GameEngine.prototype.onLevelSelect=function(){this.setPaused(!1),DM2.lastTrackPlayed=null,this.gotoTitleScene()},GameEngine.prototype.loadAssetsForTag=function(t){this.assetList=this.app.assets.findByTag(t,"all");for(var e=this.loadCount=0;e<this.assetList.length;e++){var i=this.assetList[e];i.ready(this.onAssetReady,this),i.on("error",this.onAssetError,this),this.app.assets.load(i)}},GameEngine.prototype.unloadAssetsForTag=function(t){this.assetList=this.app.assets.findByTag(t,"all");for(var e=this.loadCount=0;e<this.assetList.length;e++){this.assetList[e].unload()}},GameEngine.prototype.gotoTitleScene=function(){var t=this,e=function(){t.gotoScene("505078.json")};ResultUi.divContent&&(ResultUi.divContent.style.display="none"),PauseUi.divContent&&(PauseUi.divContent.style.display="none"),this.gameUi.setHUDVisible(!1),this.resultScreen.enabled?this.gameUi.closeLoadingOverlay(this.resultScreen,e):this.gameUi.closeLoadingOverlay(this.generalUiScreen,e)},GameEngine.prototype.publishAllAssetsLoaded=function(){this.hasLoadedAssets=!0,this.hasPublishedEvent=!1},GameEngine.prototype.gotoScene=function(t){GameEngine.Root=this.app.root.findByName("Root"),GameUi.divContent.style.display="none",this.isPaused=!0,this.resetAllEvents(),this.app.graphicsDevice.off("resizecanvas"),DM2.LOWMEM&&this.unloadAssetsForTag(this.assetTag),this.app.loadSceneHierarchy(t,function(t,e){!t&&GameEngine.Root?GameEngine.Root.destroy():console.log(t)})},GameEngine.prototype.resetAllEvents=function(){this.app.off(DM2.EVENT_TRIGGER),this.app.off(DM2.EVENT_ANIM_COMPLETED),this.app.off(DM2.EVENT_SEGMENT_REQ),this.app.off(DM2.EVENT_INPUT_UPDATE),this.app.off(DM2.EVENT_TRIGGER_SFX),this.app.off(DM2.EVENT_TIMER_UPDATE),this.app.off(DM2.EVENT_SCENE_LOADED),this.app.off(DM2.EVENT_ARIA_UPDATE),this.app.off(DM2.EVENT_BUTTON_CLICK),this.app.off(DM2.EVENT_TOGGLE_PAUSE),this.app.off(DM2.EVENT_TOGGLE_SETTINGS),this.app.off(DM2.EVENT_TOGGLE_HOWTO),this.app.off(DM2.EVENT_INPUT_PROCESSED),this.app.off(DM2.EVENT_GAME_CONTINUE),this.app.off(DM2.EVENT_LEVEL_RESTART),this.app.off(DM2.EVENT_LEVEL_SELECT),this.app.off(DM2.EVENT_TOGGLE_SFX),this.app.off(DM2.EVENT_TOGGLE_SPEEDFX),this.app.off(DM2.EVENT_PLAY_VOICEOVER),this.app.off(DM2.EVENT_ASSETS_LOADED)};var SegmentManager=pc.createScript("segmentManager");SegmentManager.prototype.initialize=function(){this.segmentCache=Array.apply(0,new Array(1e3)).map(function(t){}),this.insertIndex=0,this.cacheMeta={},this.on("disable",this.onDisable)},SegmentManager.prototype.cacheSegment=function(t,e){if(!this.cacheMeta[t]&&!DM2.LOWMEM){for(var i=0;i<e;i++){var s=this.entity.findByName(t);s&&(segment=s.clone(),segment.enabled=!1,segment.disposable=!0,segment.setPosition(0,0,1e3),this.segmentCache[this.insertIndex]=segment,this.insertIndex++)}this.cacheMeta[t]=!0}},SegmentManager.prototype.createInstance=function(t){for(var e,i=0;i<this.insertIndex&&((e=this.segmentCache[i]).name!==t||e.enabled);i++)e=null;if(!e){var s=this.entity.findByName(t);s?(e=s.clone(),this.segmentCache[this.insertIndex]=e,this.insertIndex++):console.log("no such segment :: "+t)}return e.model.enabled=!1,e.setPosition(0,0,1e3),e},SegmentManager.prototype.onDisable=function(){this.off("disable",this.onDisable),this.segmentCache.map(function(t,e){t&&t.destroy()}),this.segmentCache=[]};var BusProp=pc.createScript("busProp");BusProp.prototype.initialize=function(){this.propBase=this.entity.script.propBase,this.propBase.registerCallbacks(this.onCollision,this.onResetProp,this)},BusProp.prototype.update=function(t){this.hasCrashed&&this.entity.animation.currentTime>=this.entity.animation.duration&&(this.entity.model.enabled=!1)},BusProp.prototype.onCollision=function(t){this.hasCrashed=!0,this.entity.animation.enabled=!0,this.entity.animation.play("vehicle_hitforward.json"),this.app.fire(DM2.EVENT_TRIGGER_SFX,DM2.SFX_CAR_CRASH),t.crashVehicle()},BusProp.prototype.onResetProp=function(){this.entity.animation.currentTime=0,this.entity.animation.enabled=!1,this.hasCrashed=!1,this.entity.model.enabled=!0};var TaxiProp=pc.createScript("taxiProp");TaxiProp.prototype.initialize=function(){this.propBase=this.entity.script.propBase,this.propBase.registerCallbacks(this.onCollision,this.onResetProp,this)},TaxiProp.prototype.onCollision=function(t){this.entity.animation.enabled=!0,this.entity.animation.play("vehicle_hitforward.json"),this.app.fire(DM2.EVENT_TRIGGER_SFX,DM2.SFX_CAR_CRASH),t.crashVehicle()},TaxiProp.prototype.onResetProp=function(){this.entity.animation.currentTime=0,this.entity.animation.enabled=!1};var RampProp=pc.createScript("rampProp");RampProp.prototype.initialize=function(){this.propBase=this.entity.script.propBase,this.propBase.registerCallbacks(this.onCollision,this.onResetProp,this)},RampProp.prototype.onCollision=function(t){t.playRampAnimation()},RampProp.prototype.onResetProp=function(){this.entity.enabled=!0};var PropRenderer=pc.createScript("propRenderer");PropRenderer.attributes.add("vs",{type:"asset",assetType:"shader",title:"Vertex Shader"}),PropRenderer.attributes.add("fs",{type:"asset",assetType:"shader",title:"Fragment Shader"}),PropRenderer.attributes.add("textureMap",{type:"asset",assetType:"texture",title:"Texture Map"}),PropRenderer.prototype.initialize=function(){this.shaderDecorators=[],this.isInitialized=!1,this.scaleFactor=this.entity.getLocalScale().z/DM2.SEGMENT_SCALE,DM2.configPropRender[this.entity.name]&&DM2.configPropRender[this.entity.name].glowMeshIndex?this.glowMeshIndex=DM2.configPropRender[this.entity.name].glowMeshIndex:this.glowMeshIndex=-1},PropRenderer.prototype.registerDecorator=function(t){this.shaderDecorators||(this.shaderDecorators=[]),this.shaderDecorators.push(t),this.isInitialized=!1},PropRenderer.prototype.setControlPoints=function(t,e,i,s,n,o,r,a){if(this.fs&&this.vs){this.isInitialized||(this.setupMaterial(),this.updateFogColor()),this.uXRotCorrection&&this.uYRotCorrection||(this.uXRotCorrection=1,this.uYRotCorrection=1);var l=this.material;l&&(l.setParameter("uScaleFactor",this.scaleFactor),l.setParameter("uXRotCorrection",this.uXRotCorrection),l.setParameter("uYRotCorrection",this.uYRotCorrection),l.setParameter("uOrigin",t.data),l.setParameter("uForward",e.data),l.setParameter("uP0",i.data),l.setParameter("uP1",s.data),l.setParameter("uP2",n.data),l.setParameter("uP3",o.data),l.setParameter("uOffset",r));var h=this.glowMaterial;h&&(h.setParameter("uScaleFactor",this.scaleFactor),h.setParameter("uXRotCorrection",this.uXRotCorrection),h.setParameter("uYRotCorrection",this.uYRotCorrection),h.setParameter("uOrigin",t.data),h.setParameter("uForward",e.data),h.setParameter("uP0",i.data),h.setParameter("uP1",s.data),h.setParameter("uP2",n.data),h.setParameter("uP3",o.data),h.setParameter("uOffset",r)),this.shaderDecorators&&this.shaderDecorators.map(function(t){t.onUpdateMaterial(l,a)})}},PropRenderer.prototype.updateFogColor=function(){if(this.material){var t=this.app.root.findByName("GameCamera").camera.clearColor;this.material.setParameter("uFogColor",t.data)}},PropRenderer.prototype.setupMaterial=function(){if(this.vs&&this.fs){var t=this.app,e=this.entity.model.model,i=t.graphicsDevice,s=this.textureMap.resource,n=this.setupVertShader(this.vs.resource),o="precision "+i.precision+" float;\n";o+=this.setupFragShader(this.fs.resource);var r={attributes:{aPosition:pc.SEMANTIC_POSITION,aNormal:pc.SEMANTIC_NORMAL,aUv0:pc.SEMANTIC_TEXCOORD0,aColor:pc.SEMANTIC_COLOR},vshader:n,fshader:o};if(this.shader=new pc.Shader(i,r),this.material=new pc.Material,this.glowMaterial=new pc.Material,this.material.setShader(this.shader),this.material.setParameter("uTextureMap",s),0<=this.glowMeshIndex&&(this.material.blendType=pc.BLEND_NORMAL),this.glowMaterial.setShader(this.shader),this.glowMaterial.setParameter("uTextureMap",s),this.glowMaterial.blendType=pc.BLEND_ADDITIVEALPHA,e)for(var a=0;a<e.meshInstances.length;a++)a===this.glowMeshIndex?e.meshInstances[a].material=this.glowMaterial:e.meshInstances[a].material=this.material;else console.error("no model on prop: "+this.entity.name);this.isInitialized=!0}},PropRenderer.prototype.setupVertShader=function(t){var e=t;return this.shaderDecorators.map(function(t){e=t.setupVertShader(e)}),e},PropRenderer.prototype.setupFragShader=function(t){var e=t;return this.shaderDecorators.map(function(t){e=t.setupFragShader(e)}),e};var MainUi=pc.createScript("main_ui");MainUi.attributes.add("titleContent",{type:"asset",assetType:"html",title:"Title HTML"}),MainUi.attributes.add("chapterContent",{type:"asset",assetType:"html",title:"Chapter HTML"}),MainUi.attributes.add("tracksContent",{type:"asset",assetType:"html",title:"Tracks HTML"}),MainUi.attributes.add("difficultyContent",{type:"asset",assetType:"html",title:"Difficulty HTML"}),MainUi.attributes.add("introContent",{type:"asset",assetType:"html",title:"Intro Screen HTML"}),MainUi.prototype.initialize=function(){this.titleScreen=this.app.root.findByName("TitleScreen"),this.chapterScreen=this.app.root.findByName("ChapterScreen"),this.londonTracksScreen=this.app.root.findByName("LondonTracksScreen"),this.tokyoTracksScreen=this.app.root.findByName("TokyoTracksScreen"),this.spaceTracksScreen=this.app.root.findByName("SpaceTracksScreen"),this.trenchTracksScreen=this.app.root.findByName("TrenchTracksScreen"),this.factoryTracksScreen=this.app.root.findByName("FactoryTracksScreen"),this.difficultyScreen=this.app.root.findByName("DifficultyScreen"),this.introScreen=this.app.root.findByName("IntroScreen"),this.sfxManager=this.entity.findByName("TitleSFXManager").script.sfxManager,this.loadingOverlayEntity=this.app.root.findByName("LoadingOverlay"),this.loadingOverlay=this.loadingOverlayEntity.script.loadingUi,this.loadingOverlay.hide(),MainUi.divContent=document.querySelector(".mainScreen"),MainUi.divContent||(MainUi.divContent=document.createElement("div"),MainUi.divContent.classList.add("mainScreen"),MainUi.divContent.innerHTML="<div/>",this.injectContent()),MainUi.divContent.style.display="block",this.app.on(DM2.EVENT_BUTTON_CLICK,this.onGameButtonClick,this),this.app.on(DM2.EVENT_TOGGLE_PAUSE,this.onTogglePause,this),this.app.on(DM2.EVENT_GAME_CONTINUE,this.setTitleScreen,this),this.app.on(DM2.EVENT_TOGGLE_SFX,this.onToggleSFX,this),this.loadAssets(),this.setFirstScreen()},MainUi.prototype.update=function(t){!this.isPaused&&this.introScreen.enabled&&0<this.introTimeout&&(this.introTimeout-=t,this.introTimeout<=0&&this.gotoScene(this.trackSelection+".json"))},MainUi.prototype.setControlsVisible=function(t){var e=MainUi.divContent.querySelector(".home");e&&(e.style.display=t?"block":"none");var i=MainUi.divContent.querySelector(".resume");i&&(i.style.display=t?"block":"none");var s=MainUi.divContent.querySelector(".start");s&&(s.style.display=t?"block":"none");var n=MainUi.divContent.querySelector(".exit");n&&(n.style.display=t?"block":"none");var o=MainUi.divContent.querySelector(".settings");o&&(o.style.display=t?"block":"none");var r=MainUi.divContent.querySelector(".howto");r&&(r.style.display=t?"block":"none");var a=MainUi.divContent.querySelector("#sound");a&&(a.style.display=t?"block":"none")},MainUi.prototype.injectContent=function(){var t=DM2.getGameHolder();t?t.appendChild(MainUi.divContent):document.body.appendChild(MainUi.divContent)},MainUi.prototype.setFirstScreen=function(){MainUi.divContent.innerHTML=this.titleContent.resource||"",this.titleScreen.enabled=!0,this.chapterScreen.enabled=!1,this.londonTracksScreen.enabled=!1,this.tokyoTracksScreen.enabled=!1,this.spaceTracksScreen.enabled=!1,this.trenchTracksScreen.enabled=!1,this.factoryTracksScreen.enabled=!1,this.difficultyScreen.enabled=!1,this.introScreen.enabled=!1,DM2.lastChapterPlayed?(MainUi.divContent.style.display="none",this.chapterSelection=DM2.lastChapterPlayed,DM2.replayLastLevel?(this.trackSelection=DM2.lastTrackPlayed,DM2.replayLastLevel=!1,this.setIntroScreen(!0,this.titleScreen,!0)):(this.sfxManager.play(DM2.SFX_MUSIC_TITLE),this.navigateNext())):(MainUi.divContent.style.display="block",this.sfxManager.play(DM2.SFX_NARR_TITLE),this.sfxManager.play(DM2.SFX_MUSIC_TITLE),this.setTitleScreen())},MainUi.prototype.navigateNext=function(){switch(DM2.lastTrackPlayed){case DM2.trackIDs.London01:this.trackSelection=DM2.trackIDs.London02,DM2.lastTrackPlayed=DM2.trackIDs.London02,this.setIntroScreen(!0,this.titleScreen,!0);break;case DM2.trackIDs.London02:this.trackSelection=DM2.trackIDs.LondonBoss,DM2.lastTrackPlayed=DM2.trackIDs.LondonBoss,this.setIntroScreen(!0,this.titleScreen,!0);break;case DM2.trackIDs.Tokyo01:this.trackSelection=DM2.trackIDs.Tokyo02,DM2.lastTrackPlayed=DM2.trackIDs.Tokyo02,this.setIntroScreen(!0,this.titleScreen,!0);break;case DM2.trackIDs.Tokyo02:this.trackSelection=DM2.trackIDs.TokyoBoss,DM2.lastTrackPlayed=DM2.trackIDs.TokyoBoss,this.setIntroScreen(!0,this.titleScreen,!0);break;case DM2.trackIDs.Space01:this.trackSelection=DM2.trackIDs.Space02,DM2.lastTrackPlayed=DM2.trackIDs.Space02,this.setIntroScreen(!0,this.titleScreen,!0);break;case DM2.trackIDs.Space02:this.trackSelection=DM2.trackIDs.SpaceBoss,DM2.lastTrackPlayed=DM2.trackIDs.SpaceBoss,this.setIntroScreen(!0,this.titleScreen,!0);break;case DM2.trackIDs.Trench01:this.trackSelection=DM2.trackIDs.Trench02,DM2.lastTrackPlayed=DM2.trackIDs.Trench02,this.setIntroScreen(!0,this.titleScreen,!0);break;case DM2.trackIDs.Trench02:this.trackSelection=DM2.trackIDs.TrenchBoss,DM2.lastTrackPlayed=DM2.trackIDs.TrenchBoss,this.setIntroScreen(!0,this.titleScreen,!0);break;case DM2.trackIDs.Factory01:this.trackSelection=DM2.trackIDs.Factory02,DM2.lastTrackPlayed=DM2.trackIDs.Factory02,this.setIntroScreen(!0,this.titleScreen,!0);break;case DM2.trackIDs.Factory02:this.trackSelection=DM2.trackIDs.FactoryBoss,DM2.lastTrackPlayed=DM2.trackIDs.FactoryBoss,this.setIntroScreen(!0,this.titleScreen,!0);break;default:this.setChapterScreen(!0,this.titleScreen,!0)}},MainUi.prototype.setTitleScreen=function(t,e){this.app.fire(DM2.EVENT_TOGGLE_PAUSE,!1),MainUi.divContent.innerHTML=this.titleContent.resource||"",DM2.setGameHolderTouchEnabled(!0);var i=this,s=function(){DM2.setHeartbeatData(i.getCurrentScreenID()),i.bindTitleEvents(),i.moveForward(),i.chapterScreen.enabled=!1,i.titleScreen.enabled=!0,i.londonTracksScreen.enabled=!1,i.tokyoTracksScreen.enabled=!1,i.spaceTracksScreen.enabled=!1,i.trenchTracksScreen.enabled=!1,i.factoryTracksScreen.enabled=!1,i.difficultyScreen.enabled=!1,i.introScreen.enabled=!1};t?(MainUi.divContent.style.display="none",this.loadingOverlayEntity.reparent(e),this.loadingOverlay.setVisibleOpen(),this.loadingOverlay.playCloseAnimation(function(){this.loadingOverlayEntity.reparent(this.titleScreen),this.loadingOverlay.setVisibleClosed(),s(),this.loadingOverlay.playOpenAnimation(function(){MainUi.divContent.style.display="block",this.loadingOverlay.hide()},this)},this)):s()},MainUi.prototype.setChapterScreen=function(t,e,i){MainUi.divContent.innerHTML=this.chapterContent.resource||"",DM2.setGameHolderTouchEnabled(!1);var s=this,n=function(){DM2.setHeartbeatData(s.getCurrentScreenID()),s.bindChapterEvents(),s.moveForward(),s.chapterScreen.enabled=!0,s.titleScreen.enabled=!1,s.londonTracksScreen.enabled=!1,s.tokyoTracksScreen.enabled=!1,s.spaceTracksScreen.enabled=!1,s.trenchTracksScreen.enabled=!1,s.factoryTracksScreen.enabled=!1,s.difficultyScreen.enabled=!1,s.introScreen.enabled=!1};t?(MainUi.divContent.style.display="none",this.loadingOverlayEntity.reparent(e),i?this.loadingOverlay.setVisibleClosed():this.loadingOverlay.setVisibleOpen(),this.loadingOverlay.playCloseAnimation(function(){this.loadingOverlayEntity.reparent(this.chapterScreen),this.loadingOverlay.setVisibleClosed(),n(),this.loadingOverlay.playOpenAnimation(function(){MainUi.divContent.style.display="block",this.loadingOverlay.hide()},this)},this)):n()},MainUi.prototype.setTrackScreen=function(){MainUi.divContent.innerHTML=this.tracksContent.resource||"",DM2.setGameHolderTouchEnabled(!1),DM2.setHeartbeatData(this.getCurrentScreenID()),this.bindTracksEvents(),this.moveForward(),this.chapterScreen.enabled=!1,this.titleScreen.enabled=!1,this.difficultyScreen.enabled=!1,this.introScreen.enabled=!1,this.chapterSelection===DM2.LOCATION_LONDON?(this.londonTracksScreen.enabled=!0,this.tokyoTracksScreen.enabled=!1,this.spaceTracksScreen.enabled=!1,this.trenchTracksScreen.enabled=!1,this.factoryTracksScreen.enabled=!1):this.chapterSelection===DM2.LOCATION_TOKYO?(this.londonTracksScreen.enabled=!1,this.tokyoTracksScreen.enabled=!0,this.spaceTracksScreen.enabled=!1,this.trenchTracksScreen.enabled=!1,this.factoryTracksScreen.enabled=!1):this.chapterSelection===DM2.LOCATION_SPACE?(this.londonTracksScreen.enabled=!1,this.tokyoTracksScreen.enabled=!1,this.spaceTracksScreen.enabled=!0,this.trenchTracksScreen.enabled=!1,this.factoryTracksScreen.enabled=!1):this.chapterSelection===DM2.LOCATION_TRENCH?(this.londonTracksScreen.enabled=!1,this.tokyoTracksScreen.enabled=!1,this.spaceTracksScreen.enabled=!1,this.trenchTracksScreen.enabled=!0,this.factoryTracksScreen.enabled=!1):this.chapterSelection===DM2.LOCATION_FACTORY&&(this.londonTracksScreen.enabled=!1,this.tokyoTracksScreen.enabled=!1,this.spaceTracksScreen.enabled=!1,this.trenchTracksScreen.enabled=!1,this.factoryTracksScreen.enabled=!0)},MainUi.prototype.setDifficultyScreen=function(t,e,i){MainUi.divContent.innerHTML=this.difficultyContent.resource||"",DM2.setGameHolderTouchEnabled(!1);var s=function(){DM2.setHeartbeatData(this.getCurrentScreenID()),this.bindDifficultyEvents(),this.moveForward(),this.chapterScreen.enabled=!1,this.titleScreen.enabled=!1,this.londonTracksScreen.enabled=!1,this.tokyoTracksScreen.enabled=!1,this.spaceTracksScreen.enabled=!1,this.trenchTracksScreen.enabled=!1,this.factoryTracksScreen.enabled=!1,this.difficultyScreen.enabled=!0,this.introScreen.enabled=!1}.bind(this);t?(MainUi.divContent.style.display="none",this.loadingOverlayEntity.reparent(e),i?this.loadingOverlay.setVisibleClosed():this.loadingOverlay.setVisibleOpen(),this.loadingOverlay.playCloseAnimation(function(){this.loadingOverlayEntity.reparent(this.difficultyScreen),this.loadingOverlay.setVisibleClosed(),s(),this.loadingOverlay.playOpenAnimation(function(){MainUi.divContent.style.display="block",this.loadingOverlay.hide()},this)},this)):s()},MainUi.prototype.setIntroScreen=function(t,e,i){MainUi.divContent.innerHTML=this.introContent.resource||"",DM2.setGameHolderTouchEnabled(!1),this.sfxManager.play(DM2.SFX_MUSIC_TITLE);var s=function(){DM2.setHeartbeatData(this.getCurrentScreenID()),this.bindIntroEvents(),this.moveForward(),this.chapterScreen.enabled=!1,this.titleScreen.enabled=!1,this.londonTracksScreen.enabled=!1,this.tokyoTracksScreen.enabled=!1,this.spaceTracksScreen.enabled=!1,this.trenchTracksScreen.enabled=!1,this.factoryTracksScreen.enabled=!1,this.difficultyScreen.enabled=!1,this.introScreen.enabled=!0,this.introScreen.script.intro_screen.setLocation(this.chapterSelection,this.trackSelection)}.bind(this);t?(MainUi.divContent.style.display="none",this.loadingOverlayEntity.reparent(e),i?this.loadingOverlay.setVisibleClosed():this.loadingOverlay.setVisibleOpen(),this.loadingOverlay.playCloseAnimation(function(){this.loadingOverlayEntity.reparent(this.introScreen),this.loadingOverlay.setVisibleClosed(),s(),this.loadingOverlay.playOpenAnimation(function(){MainUi.divContent.style.display="block",this.loadingOverlay.hide()},this)},this)):(MainUi.divContent.style.display="block",s())},MainUi.prototype.getCurrentScreenID=function(){return this.titleScreen.enabled?DM2.SCREEN_ID_TITLE:this.chapterScreen.enabled?DM2.SCREEN_ID_CHAPTER:this.londonTracksScreen.enabled||this.tokyoTracksScreen.enabled||this.spaceTracksScreen.enabled||this.trenchTracksScreen.enabled||this.factoryTracksScreen.enabled?DM2.SCREEN_ID_TRACK:this.difficultyScreen.enabled?DM2.SCREEN_ID_DIFFICULTY:this.introScreen.enabled?DM2.SCREEN_ID_INTRO:void 0},MainUi.prototype.moveForward=function(){MainUi.divContent.parentNode.appendChild(MainUi.divContent)},MainUi.prototype.bindTitleEvents=function(){var t=MainUi.divContent.querySelector(".start");if(t){var e=function(t){DM2.sendActionEvent(DM2.BMI_ACTION_PLAY,DM2.SCREEN_ID_TITLE),this.setDifficultyScreen(!0,this.titleScreen),this.sfxManager.resumePlayback(),this.sfxManager.play(DM2.SFX_MUSIC_TITLE)}.bind(this);DM2.addEventListeners(t,e,DM2.voiceOver.play,this.app)}var i=MainUi.divContent.querySelector(".exit");if(i)if(!0===pc.platform.mobile||DM2.gmi&&DM2.gmi.shouldShowExitButton){DM2.addEventListeners(i,function(){DM2.exitGame()},DM2.voiceOver.exit,this.app)}else i.style.display="none";this.setupSettingsButton(DM2.SCREEN_ID_TITLE),this.setupHowToButton(DM2.SCREEN_ID_TITLE),this.setupSoundButton(DM2.SCREEN_ID_TITLE)},MainUi.prototype.bindChapterEvents=function(){var t=MainUi.divContent.querySelector(".back");if(t){var e=function(){DM2.sendActionEvent(DM2.BMI_ACTION_HOME,DM2.SCREEN_ID_CHAPTER),this.setDifficultyScreen()}.bind(this);DM2.addEventListeners(t,e,DM2.voiceOver.back,this.app)}this.setupPauseButton(DM2.SCREEN_ID_CHAPTER)},MainUi.prototype.bindTracksEvents=function(){var t=MainUi.divContent.querySelector(".back");if(t){var e=function(){DM2.sendActionEvent(DM2.BMI_ACTION_BACK,DM2.SCREEN_ID_TRACK),this.setChapterScreen()}.bind(this);DM2.addEventListeners(t,e,DM2.voiceOver.back,this.app)}this.setupPauseButton(DM2.SCREEN_ID_TRACK)},MainUi.prototype.bindDifficultyEvents=function(){var t=MainUi.divContent.querySelector(".back");if(t){var e=function(){DM2.sendActionEvent(DM2.BMI_ACTION_BACK,DM2.SCREEN_ID_DIFFICULTY),this.setTitleScreen(!0,this.difficultyScreen)}.bind(this);DM2.addEventListeners(t,e,DM2.voiceOver.back,this.app)}this.setupPauseButton(DM2.SCREEN_ID_DIFFICULTY)},MainUi.prototype.bindIntroEvents=function(){this.introTimeout=7,this.setupPauseButton(DM2.SCREEN_ID_INTRO),this.setupSkipIntroButton()},MainUi.prototype.onGameButtonClick=function(t){this.isPaused||this.loadingOverlay.enabled||("difficultySelect"===t.category&&this.difficultyScreen.enabled?(DM2.putGameData(DM2.SETTING_DIFFICULTY,t.data),DM2.sendDifficultySelect(t.data),this.setChapterScreen()):"chapterSelect"===t.category&&this.chapterScreen.enabled?(this.chapterSelection=t.data,DM2.sendChapterSelect(this.chapterSelection),this.setTrackScreen()):"trackSelect"===t.category&&(this.londonTracksScreen.enabled||this.tokyoTracksScreen.enabled||this.spaceTracksScreen.enabled||this.trenchTracksScreen.enabled||this.factoryTracksScreen.enabled)&&(this.trackSelection=t.data,DM2.lastTrackPlayed=t.data,DM2.sendTrackSelect(this.chapterSelection,this.trackSelection),!0===this.londonTracksScreen.enabled?this.setIntroScreen(!0,this.londonTracksScreen):!0===this.tokyoTracksScreen.enabled?this.setIntroScreen(!0,this.tokyoTracksScreen):!0===this.spaceTracksScreen.enabled?this.setIntroScreen(!0,this.spaceTracksScreen):!0===this.trenchTracksScreen.enabled?this.setIntroScreen(!0,this.trenchTracksScreen):!0===this.factoryTracksScreen.enabled&&this.setIntroScreen(!0,this.factoryTracksScreen)))},MainUi.prototype.onTogglePause=function(t){this.isPaused=t},MainUi.prototype.onToggleSFX=function(t){DM2.setMuted(t);var e=MainUi.divContent.querySelector("#sound");e&&(DM2.isMuted()?e.className="soundOff":e.className="soundOn")},MainUi.prototype.unloadAssets=function(){this.assetList=this.app.assets.findByTag("title");for(var t=this.loadCount=0;t<this.assetList.length;t++){this.assetList[t].unload()}},MainUi.prototype.loadAssets=function(){this.assetList=this.app.assets.findByTag("title");for(var t=0;t<this.assetList.length;t++){var e=this.assetList[t];this.app.assets.load(e)}},MainUi.prototype.gotoScene=function(t){var e=this.app;MainUi.divContent.style.display="none",DM2.currentTrack=this.trackSelection,DM2.currentChapter=this.chapterSelection,this.loadingOverlayEntity.reparent(this.introScreen),this.loadingOverlay.setVisibleOpen(),this.loadingOverlay.playCloseAnimation(function(){MainUi.Root=this.app.root.findByName("Root"),DM2.LOWMEM&&this.unloadAssets(),this.sfxManager.fadeOut(DM2.SFX_MUSIC_TITLE),this.app.graphicsDevice.off("resizecanvas"),e.mouse.off(pc.EVENT_MOUSEDOWN),e.loadSceneHierarchy(t,function(t,e){t?console.log(t):MainUi.Root&&MainUi.Root.destroy()})},this)},MainUi.prototype.setupSoundButton=function(t){var e=MainUi.divContent.querySelector("#sound");if(e){DM2.isMuted()?e.className="soundOff":e.className="soundOn";var i=function(){DM2.isMuted()?DM2.sendActionEvent(DM2.BMI_ACTION_UNMUTE,t):DM2.sendActionEvent(DM2.BMI_ACTION_MUTE,t),this.app.fire(DM2.EVENT_TOGGLE_SFX,!DM2.isMuted())}.bind(this);DM2.addEventListeners(e,i,DM2.voiceOver.toggleSound,this.app)}},MainUi.prototype.setupSkipIntroButton=function(){var t=MainUi.divContent.querySelector(".skip");if(t){var e=function(){0<this.introTimeout&&(this.introTimout=10,DM2.sendActionEvent(DM2.BMI_ACTION_CONTINUE,DM2.SCREEN_ID_BRIEFING),this.gotoScene(this.trackSelection+".json"))}.bind(this);DM2.addEventListeners(t,e,DM2.voiceOver.skip,this.app)}},MainUi.prototype.setupPauseButton=function(t){var e=MainUi.divContent.querySelector(".pause");if(e){var i=function(){DM2.sendActionEvent(DM2.BMI_ACTION_PAUSE,t),this.app.fire(DM2.EVENT_TOGGLE_PAUSE,!0)}.bind(this);DM2.addEventListeners(e,i,DM2.voiceOver.pause,this.app)}},MainUi.prototype.setupSettingsButton=function(t){var e=MainUi.divContent.querySelector(".settings");if(e){var i=function(){DM2.sendActionEvent(DM2.BMI_ACTION_SETTINGS,t),this.app.fire(DM2.EVENT_TOGGLE_SETTINGS,!0)}.bind(this);DM2.addEventListeners(e,i,DM2.voiceOver.settings,this.app)}},MainUi.prototype.setupHowToButton=function(t){var e=MainUi.divContent.querySelector(".howto");if(e){var i=function(){DM2.sendActionEvent(DM2.BMI_ACTION_HOWTO,t),this.app.fire(DM2.EVENT_TOGGLE_HOWTO,!0)}.bind(this);DM2.addEventListeners(e,i,DM2.voiceOver.howToPlay,this.app)}};var PropBase=pc.createScript("propBase");PropBase.attributes.add("isMoving",{type:"boolean",default:!1}),PropBase.attributes.add("isRelativeToTrack",{type:"boolean",default:!1}),PropBase.attributes.add("relativeVelocity",{type:"number"}),PropBase.attributes.add("moveTriggerDistance",{type:"number"}),PropBase.attributes.add("sfxTrigger",{type:"string",default:"none"}),PropBase.attributes.add("sfxIsRandom",{type:"boolean",default:!0}),PropBase.prototype.initialize=function(){this.playerController=this.app.root.findByName("PlayerController").script.playerController,this.isTriggered=!1,this.isSFXTriggered=!1,this.collider=this.entity.collision,this.AABB=new pc.BoundingBox(pc.Vec3.ZERO,this.collider.halfExtents)},PropBase.prototype.step=function(t,e){if(this.isMoving&&this.updateMovement(t,e),!this.isTriggered){var i=this.entity.getLocalPosition().clone();if(i.z<32&&!this.isSFXTriggered&&"none"!=this.sfxTrigger)this.isSFXTriggered=!0,(!this.sfxIsRandom||10*Math.random()<3)&&this.app.fire(DM2.EVENT_TRIGGER_SFX,this.sfxTrigger);if(!this.isAlwaysCollide){var s="trigger"===this.entity.name||"boss_waypoint"===this.entity.name||"boss_attack"===this.entity.name||"end_level"===this.entity.name,n=this.isFloating&&!this.playerController.isFlying,o=!this.isFloating&&(this.playerController.isFlying||this.playerController.isRamping);if(!s&&(n||o))return}i.z>this.playerController.getAABB().center.z+.5*DM2.SEGMENT_SCALE||(this.AABB.center=i,DM2.checkAABBCollision(this.AABB,this.playerController.getAABB(),t,e)&&(this.isTriggered=!0,this.collisionCallback&&(this.callbackContext?this.collisionCallback.call(this.callbackContext,this.playerController):this.collisionCallback(this.playerController))))}},PropBase.prototype.registerCallbacks=function(t,e,i){this.collisionCallback=t,this.resetCallback=e,this.callbackContext=i},PropBase.prototype.resetProp=function(){this.isTriggered=!1,this.isSFXTriggered=!1,this.resetCallback&&(this.callbackContext?this.resetCallback.call(this.callbackContext):this.resetCallback())},PropBase.prototype.updateMovement=function(t,e){var i=this.entity.getLocalPosition().clone();i.z<this.moveTriggerDistance*DM2.SEGMENT_SCALE&&(this.isRelativeToTrack?i.z-=t*this.relativeVelocity:i.z-=e*t*this.relativeVelocity,this.entity.setLocalPosition(i))};var TriggerProp=pc.createScript("triggerProp");TriggerProp.prototype.initialize=function(){this.propBase=this.entity.script.propBase,this.propBase.registerCallbacks(this.onCollision,!1,this)},TriggerProp.prototype.onCollision=function(t){this.app.fire(DM2.EVENT_TRIGGER,this.entity.triggerName)};var BossController=pc.createScript("bossController");BossController.attributes.add("bombDropEntity",{type:"entity"}),BossController.attributes.add("bossEntity",{type:"entity"}),BossController.attributes.add("moveSpeed",{type:"number"}),BossController.attributes.add("defeatWait",{type:"number",default:2.6}),BossController.attributes.add("bombDropDelay",{type:"number",default:.5}),BossController.prototype.initialize=function(){this.lanes=this.app.root.findByName("TrackLanes").script.trackLanes,this.levelController=this.app.root.findByName("LevelController").script.levelController,this.trackRunner=this.app.root.findByName("TrackRunner").script.trackRunner,this.playerController=this.app.root.findByName("PlayerController").script.playerController,this.endExplosions=this.entity.findByName("Explosions").script.bossEndExplosions,this.bombDrop=this.bombDropEntity.script.bombDrop,this.animator=this.bossEntity.animation,this.animator.activate=!1,this.isPlayingIntro=!1,this.props=[],this.isDefeated=!1,this.defeatedTimeout=this.defeatWait,this.animationTimout=0,this.currentTime=0,this.delayedFunctions=[],this.hasStarted=!1,this.trackPosition=this.entity.getPosition().clone(),this.trackBend=pc.Vec3.ZERO,this.app.on(DM2.EVENT_TRIGGER,this.onEventTrigger,this);var t=this.lanes.getStartingLane().getLocalPosition();t.z=this.entity.getLocalPosition().z,this.entity.setLocalPosition(t.clone())},BossController.prototype.update=function(t){this.hasStarted&&(this.currentTime+=t,this.updateDelayedFunctions(),this.updateFunction&&this.updateFunction(t),this.isDefeated&&0<this.defeatedTimeout?(this.defeatedTimeout-=t,this.defeatedTimeout<0&&this.finishBattle()):this.isDefeated||(this.animationTimout<=0?this.playAnimation(DM2.bossStates.idle,!0):this.animationTimout-=t),this.setFinalPosition(t))},BossController.prototype.setFinalPosition=function(t){var e=this.entity.getPosition().clone(),i=.5*DM2.SEGMENT_SCALE,s=this.trackRunner.getNearestSegment(e.z+.5*DM2.SEGMENT_SCALE+i);if(s){var n=this.trackRunner.ctrlOrigin,o=this.trackRunner.ctrlForward,r=s.controlPoints,a=(e.z+i-s.getPosition().z)/DM2.SEGMENT_SCALE,l=DM2.bendOffsetValue(a,n.clone(),o.clone(),r);this.isDefeated?(this.trackBend.x=0,this.trackBend.y=0):(this.trackBend.x=pc.math.lerp(this.trackBend.x,l.x,10*t),this.trackBend.y=pc.math.lerp(this.trackBend.y,l.y,10*t))}e.x=this.trackPosition.x+this.trackBend.x,e.y=this.trackPosition.y+this.trackBend.y,this.entity.setPosition(e)},BossController.prototype.moveToPos=function(t){this.trackPosition.x<t.x?this.moveLeft(t):this.moveRight(t)},BossController.prototype.attack=function(){this.playAnimation(DM2.bossStates.attack,!1),this.app.fire(DM2.EVENT_TRIGGER_SFX,DM2.SFX_BOSS_LAUGH),this.delayedFunctions.push({target:this.bombDrop,func:this.bombDrop.drop,t:this.currentTime+this.bombDropDelay})},BossController.prototype.taunt=function(){this.playAnimation(DM2.bossStates.taunt,!0)},BossController.prototype.finishBattle=function(){this.endExplosions.triggerExplosions(),this.playAnimation(DM2.bossStates.defeated,!1)},BossController.prototype.addProp=function(t){this.props.push(t)},BossController.prototype.onEventTrigger=function(t){t===DM2.TRIGGER_START_INTRO?this.startIntro():t!==DM2.TRIGGER_BOSS_DEFEATED||this.isDefeated||(this.isDefeated=!0,this.moveToPlayerPos())},BossController.prototype.updateDelayedFunctions=function(){for(var t=this.delayedFunctions.length-1;0<=t;t--){var e=this.delayedFunctions[t];e.t<=this.currentTime&&(e.func.call(e.target),this.delayedFunctions.splice(t,1))}},BossController.prototype.playAnimation=function(t,e){this.currentState=t,this.currentAnimation=this.animator.getAnimation(t),this.animator.play(t),this.animator.loop=e,this.animationTimout=this.currentAnimation.duration},BossController.prototype.startIntro=function(){this.hasStarted=!0,this.playAnimation(DM2.bossStates.intro,!1)},BossController.prototype.moveLeft=function(e){var i=this;this.updateFunction=function(t){i.trackPosition.x+=t*i.moveSpeed,i.trackPosition.x>e.x&&(i.trackPosition.x=e.x,i.updateFunction=null)}},BossController.prototype.moveRight=function(e){var i=this;this.updateFunction=function(t){i.trackPosition.x-=t*i.moveSpeed,i.trackPosition.x<e.x&&(i.trackPosition.x=e.x,i.updateFunction=null)}},BossController.prototype.moveToPlayerPos=function(){var t=this.playerController.vehicleEntity.getPosition();this.moveToPos(t)};var BossWaypoint=pc.createScript("bossWaypoint");BossWaypoint.prototype.initialize=function(){this.bossController=this.app.root.findByName("BossController").script.bossController,this.lanes=this.app.root.findByName("TrackLanes").script.trackLanes,this.propBase=this.entity.script.propBase,this.propBase.registerCallbacks(this.onCollision,null,this)},BossWaypoint.prototype.onCollision=function(t){var e=this.entity.getLocalPosition(),i=this.lanes.getClosestLane(e).getLocalPosition();this.bossController.moveToPos(i)};var BossAttack=pc.createScript("bossAttack");BossAttack.prototype.initialize=function(){this.bossController=this.app.root.findByName("BossController").script.bossController,this.propBase=this.entity.script.propBase,this.propBase.registerCallbacks(this.onCollision,null,this)},BossAttack.prototype.onCollision=function(t){this.bossController.attack()};var LevelEnd=pc.createScript("levelEnd");LevelEnd.prototype.initialize=function(){this.propBase=this.entity.script.propBase,this.propBase.registerCallbacks(this.onCollision,null,this)},LevelEnd.prototype.onCollision=function(t){this.app.fire(DM2.EVENT_TRIGGER,DM2.TRIGGER_LEVEL_END)};var BombDrop=pc.createScript("bombDrop");BombDrop.attributes.add("dropSpeed",{type:"number",default:2}),BombDrop.attributes.add("ammo",{type:"string",default:"bomb"}),BombDrop.attributes.add("shoot",{type:"boolean",default:!1}),BombDrop.prototype.initialize=function(){this.dropHeight=10,this.propManager=this.app.root.findByName("PropManager").script.propManager,this.levelController=this.app.root.findByName("LevelController").script.levelController,this.bossController=this.app.root.findByName("BossController").script.bossController,this.entity.enabled=!1,this.timeStep=0,this.startY=this.entity.getLocalPosition().y},BombDrop.prototype.update=function(t){if(this.isDropping){this.levelController.getSpeed();var e=this.entity.getLocalPosition();if(this.timeStep+=2*t,e.y=this.startY*(1-this.timeStep*(this.timeStep-.5)*this.dropSpeed),0<e.x&&(e.x-=.5*this.timeStep),0<e.y&&!this.shoot)this.entity.setLocalPosition(e);else{var i=this.entity.getPosition();i.y=0,this.entity.enabled=!1,this.isDropping=!1,this.app.fire(DM2.EVENT_TRIGGER_SFX,DM2.SFX_BOSS_ATTACK),this.propManager.spawnPropDirect(this.ammo,i)}}},BombDrop.prototype.drop=function(){var t=this.entity.getLocalPosition();t.y=this.dropHeight,t.z=0,this.timeStep=0,this.entity.enabled=!0,this.isDropping=!0,this.entity.setLocalPosition(t)};var IntroCameraController=pc.createScript("introCameraController");IntroCameraController.attributes.add("offsetCurve",{type:"curve",title:"Offset Curve",curves:["x","y","z"]}),IntroCameraController.attributes.add("duration",{type:"number",default:3,title:"Duration (secs)"}),IntroCameraController.prototype.initialize=function(){this.gameCamera=this.app.root.findByName("GameCamera").camera,this.gameCamera.enabled=!1,this.introCamera=this.entity.findByPath("IntroCamera").camera,this.introCamera.enabled=!1,this.introActive=!1,this.time=0,this.startPosition=this.introCamera.entity.getPosition().clone(),this.position=this.startPosition.clone(),this.targetPosition=this.gameCamera.entity.getPosition().clone(),this.startRotation=this.introCamera.entity.getLocalEulerAngles(),this.rotation=this.startRotation.clone(),this.targetRotation=this.gameCamera.entity.getEulerAngles().clone(),this.app.on(DM2.EVENT_TRIGGER,this.onEventTrigger,this),this.app.on(DM2.EVENT_ASSETS_LOADED,this.onAssetsLoaded,this)},IntroCameraController.prototype.update=function(t){this.introActive&&this.updateIntro(t)},IntroCameraController.prototype.onEventTrigger=function(t){t===DM2.TRIGGER_START_INTRO&&(this.introCamera.enabled=!0,this.introActive=!0)},IntroCameraController.prototype.onAssetsLoaded=function(){this.updateIntro(0)},IntroCameraController.prototype.updateIntro=function(t){if(this.time+=t,this.time<=this.duration){var e=this.time/this.duration,i=this.offsetCurve.value(e);this.position.copy(this.startPosition),this.position.x=this.startPosition.x+i[0]*(this.targetPosition.x-this.startPosition.x),this.position.y=this.startPosition.y+i[0]*(this.targetPosition.y-this.startPosition.y),this.position.z=this.startPosition.z+i[0]*(this.targetPosition.z-this.startPosition.z),this.introCamera.entity.setPosition(this.position),this.rotation.copy(this.startRotation),this.rotation.x=this.startRotation.x+i[0]*Math.abs(this.targetRotation.x-this.startRotation.x),this.rotation.y=this.startRotation.y+i[0]*(this.targetRotation.y-this.startRotation.y),this.rotation.z=this.startRotation.z+i[0]*(this.targetRotation.z-this.startRotation.z),this.introCamera.entity.setEulerAngles(this.rotation)}else this.endIntro()},IntroCameraController.prototype.endIntro=function(){this.introActive=!1,this.gameCamera.enabled=!0,this.introCamera.enabled=!1,this.app.fire(DM2.EVENT_TRIGGER,DM2.TRIGGER_END_INTRO)};var FireRenderer=pc.createScript("fireRenderer");FireRenderer.attributes.add("vs",{type:"asset",assetType:"shader",title:"Vertex Shader"}),FireRenderer.attributes.add("fs",{type:"asset",assetType:"shader",title:"Fragment Shader"}),FireRenderer.prototype.initialize=function(){this.gameCamera=this.app.root.findByName("GameCamera").camera,this.isAssetsLoaded=!1,this.app.on(DM2.EVENT_ASSETS_LOADED,this.onAllAssetsLoaded,this)},FireRenderer.prototype.update=function(t){this.isAssetsLoaded&&(this.flameMaterial.setParameter("_timer",this.timer),this.timer+=40*t)},FireRenderer.prototype.onAllAssetsLoaded=function(){this.setupMaterial(),this.isAssetsLoaded=!0},FireRenderer.prototype.setupMaterial=function(){var i=this.entity.model.model,t=this.app.graphicsDevice,e=pc.shaderChunks,s="";s+=e.transformDeclVS,s+=pc.programlib.skinCode(t),s+=e.transformSkinnedVS,s+="uniform mat4 matrix_view;",s+="uniform float _timer;",s+="attribute vec4 aColor;",s+="varying vec4  vColor;",s+="float rand(vec2 co) {",s+="return fract(sin(dot(co.xy ,vec2(12.9898,78.233))) * 43758.5453);",s+="}",s+="float hash(float n)",s+="{",s+="    return fract(sin(n)*43758.5453);",s+="}",s+="float noise(vec3 x)",s+="{",s+="   vec3 p = floor(x);",s+="   vec3 f = fract(x);",s+="   f = f*f*(3.0-2.0*f);",s+="   float n = p.x + p.y*57.0 + 113.0*p.z;",s+="   return mix(mix(mix( hash(n+0.0), hash(n+1.0),f.x),mix( hash(n+57.0), hash(n+58.0),f.x),f.y),mix(mix( hash(n+113.0), hash(n+114.0),f.x),mix( hash(n+170.0), hash(n+171.0),f.x),f.y),f.z);",s+="}",s+=pc.programlib.begin(),s+="vColor = aColor;",s+="vec4 pos = getPosition();",s+="pos.y += .5*noise(getWorldPosition()*5.0 + vec3(0.0, _timer, 0.0)) - 0.25;",s+="pos.x += .2*noise(getWorldPosition()*5.0 + vec3(_timer, 0.0, 0.0)) - 0.1;",s+="gl_Position = pos;";var n=s+=pc.programlib.end(),o="precision "+t.precision+" float;\n";o+=this.fs.resource;var r={attributes:{vertex_position:pc.SEMANTIC_POSITION,vertex_boneWeights:pc.SEMANTIC_BLENDWEIGHT,vertex_boneIndices:pc.SEMANTIC_BLENDINDICES,aColor:pc.SEMANTIC_COLOR},vshader:n,fshader:o};this.shader=new pc.Shader(t,r),this.flameMaterial=new pc.Material,this.time=0,this.ticker=0,this.timer=0,this.flameMaterial.setShader(this.shader),this.flameMaterial.blendType=pc.BLEND_ADDITIVE;var a=this.flameMaterial;i.meshInstances.map(function(t,e){"flame_GEO"===t.node.name?t.material=a:"shadow_GEO"!==t.node.name&&(t.material=i.meshInstances[1].material)})};var SpeedLines=pc.createScript("speedLines");SpeedLines.attributes.add("vs",{type:"asset",assetType:"shader",title:"Vertex Shader"}),SpeedLines.attributes.add("fs",{type:"asset",assetType:"shader",title:"Fragment Shader"}),SpeedLines.attributes.add("textureMap",{type:"asset",assetType:"texture",title:"Texture Map"}),SpeedLines.attributes.add("alphaStrength",{type:"number",default:0}),SpeedLines.prototype.initialize=function(){var t=this.app,e=this.entity.model.model,i=t.graphicsDevice,s=(this.textureMap.resource,this.vs.resource),n="precision "+i.precision+" float;\n";n+=this.fs.resource;var o={attributes:{vertex_position:pc.SEMANTIC_POSITION,aUv0:pc.SEMANTIC_TEXCOORD0,aColor:pc.SEMANTIC_COLOR},vshader:s,fshader:n};this.gameCamera=t.root.findByName("GameCamera").camera,this.timer=0,this.shader=new pc.Shader(i,o),this.material=new pc.Material,this.material.setShader(this.shader),this.material.setParameter("uAlphaStrength",0),this.material.blendType=pc.BLEND_ADDITIVEALPHA,this.material.depthTest=!1,e.meshInstances[0].material=this.material},SpeedLines.prototype.update=function(t){this.material.setParameter("uFXTextureMap",this.textureMap.resource),this.material.setParameter("uSLTimer",this.timer),this.material.setParameter("uAlphaStrength",this.alphaStrength),this.timer+=t,1<this.timer&&(this.timer=0)};var AriaProp=pc.createScript("aria_prop");AriaProp.attributes.add("epsilon",{type:"number",default:.1}),AriaProp.prototype.initialize=function(){this.propBase=this.entity.script.propBase,this.propBase.registerCallbacks(this.onCollision,null,this)},AriaProp.prototype.onCollision=function(t){};var SettingsUi=pc.createScript("settings_ui");SettingsUi.attributes.add("settingsContent",{type:"asset",assetType:"html",title:"Settings HTML"}),SettingsUi.prototype.initialize=function(){SettingsUi.divContent=document.querySelector(".settingsScreen"),SettingsUi.divContent||(SettingsUi.divContent=document.createElement("div"),SettingsUi.divContent.classList.add("settingsScreen"),this.injectContent()),SettingsUi.divContent.innerHTML=this.settingsContent.resource||"",this.bindEvents(),SettingsUi.divContent.style.display="none",this.isVisible=!1,this.on("enable",this.onEnable),this.on("disable",this.onDisable),this.onEnable()},SettingsUi.prototype.onEnable=function(){this.app.off(DM2.EVENT_TOGGLE_SFX,this.onToggleSFX,this),this.app.on(DM2.EVENT_TOGGLE_SFX,this.onToggleSFX,this),this.app.off(DM2.EVENT_TOGGLE_SPEEDFX,this.onToggleSpeed,this),this.app.on(DM2.EVENT_TOGGLE_SPEEDFX,this.onToggleSpeed,this),this.onToggleSFX(DM2.isMuted()),this.onToggleSpeed(DM2.getGameData()[DM2.SETTING_SPEED_FX])},SettingsUi.prototype.onDisable=function(){this.app.off(DM2.EVENT_TOGGLE_SFX,this.onToggleSFX,this)},SettingsUi.prototype.onToggleSFX=function(t){var e=SettingsUi.divContent.querySelector("#audioToggle");DM2.setMuted(t),DM2.isMuted()?e.className="toggleOff":e.className="toggleOn"},SettingsUi.prototype.onToggleSpeed=function(t){var e=SettingsUi.divContent.querySelector("#speedToggle");DM2.putGameData(DM2.SETTING_SPEED_FX,t),e.className=t?"toggleOff":"toggleOn"},SettingsUi.prototype.injectContent=function(){var t=DM2.getGameHolder();t?t.appendChild(SettingsUi.divContent):document.body.appendChild(SettingsUi.divContent)},SettingsUi.prototype.bindEvents=function(){var t=SettingsUi.divContent.querySelector(".closeButton"),e=SettingsUi.divContent.querySelector("#audioToggle"),i=SettingsUi.divContent.querySelector("#speedToggle");if(t){var s=function(){this.app.fire(DM2.EVENT_TOGGLE_SETTINGS,!1)}.bind(this);DM2.addEventListeners(t,s,DM2.voiceOver.close,this.app)}if(e){var n=function(){this.app.fire(DM2.EVENT_TOGGLE_SFX,!DM2.isMuted())}.bind(this);DM2.addEventListeners(e,n,DM2.voiceOver.toggleSound,this.app)}if(i){var o=function(){var t=DM2.getGameData()[DM2.SETTING_SPEED_FX];this.app.fire(DM2.EVENT_TOGGLE_SPEEDFX,!t)}.bind(this);DM2.addEventListeners(i,o,DM2.voiceOver.toggleSpeedFX,this.app)}this.app.off(DM2.EVENT_TOGGLE_SETTINGS,this.onToggleSettings),this.app.on(DM2.EVENT_TOGGLE_SETTINGS,this.onToggleSettings,this)},SettingsUi.prototype.onToggleSettings=function(t){t?this.showSettingsOverlay():this.hideSettingsOverlay()},SettingsUi.prototype.showSettingsOverlay=function(){if(!this.isVisible){var t=SettingsUi.divContent,e=t.parentNode;t.style.display="block",e.appendChild(t),this.audioSetting=DM2.isMuted()||!1,this.speedSetting=DM2.getGameData()[DM2.SETTING_SPEED_FX]||!1,this.isVisible=!0,this.setViewControlsEnabled(!1)}},SettingsUi.prototype.hideSettingsOverlay=function(){if(this.isVisible){var t=SettingsUi.divContent,e=DM2.isMuted()||!1,i=DM2.getGameData()[DM2.SETTING_SPEED_FX]||!1,s=[];e!=this.audioSetting&&s.push("audio_muted-"+e),i!=this.speedSetting&&s.push("speed_fx_disabled-"+i),s=s.join(","),e==this.audioSetting&&i==this.speedSetting&&(s="none"),DM2.sendExitSettings(s),t.style.display="none",this.isVisible=!1,this.setViewControlsEnabled(!0)}},SettingsUi.prototype.setViewControlsEnabled=function(t){var e=this.app.root.findByName("HowToUi").script.howtoUi;e&&(1==this.howToWasShowing&&t?e.showHowToOverlay():(this.howToWasShowing=e.isVisible,e.hideHowToOverlay())),this.app.root.findByName("PauseUi").script.pauseUi.setControlsVisible(t&&1!=this.howToWasShowing);var i=this.app.root.findByName("MainUi");i&&i.script.main_ui.setControlsVisible(t&&1!=this.howToWasShowing)};var Button=pc.createScript("button");Button.attributes.add("category",{type:"string"}),Button.attributes.add("data",{type:"string"}),Button.attributes.add("voiceOver",{type:"string"}),Button.attributes.add("targetElement",{type:"entity",title:"Target Image Node"}),Button.attributes.add("normalImage",{type:"asset",title:"Normal Image"}),Button.attributes.add("activeImage",{type:"asset",title:"Active Image"});var cp=new pc.Vec3;Object.defineProperty(pc.ElementComponent.prototype,"canvasPosition",{get:function(){return cp.lerp(this.canvasCorners[0],this.canvasCorners[2],.5),cp}}),Button.prototype.initialize=function(){this.element=this.entity.element,this.halfHeight=.5*this.entity.element._height*DM2.RESOLUTION_SIZE,this.halfWidth=.5*this.entity.element._width*DM2.RESOLUTION_SIZE,this.graphicsDev=this.app.graphicsDevice,this.transition=this.entity.script.buttonTransition,this.isActive=!0,this.hasFocus=!1,this.toggleCount=0;for(var t=this.entity.parent;t&&t!==this.entity.root&&!this.screen;)t.screen?this.screen=t.screen:t=t.parent;this.targetElement?this.imageElement=this.targetElement.element:this.imageElement=this.element,this.transition.transitionIn(),this.on("enable",this.onEnable),this.on("disable",this.onDisable),pc.platform.mobile?this.app.touch.on(pc.EVENT_TOUCHSTART,this.onTouchStart,this):(this.app.mouse.on(pc.EVENT_MOUSEDOWN,this.onMouseDown,this),this.app.mouse.on(pc.EVENT_MOUSEMOVE,this.onMouseMove,this)),this.app.on(DM2.EVENT_TOGGLE_PAUSE,this.onOverlayToggled,this),this.app.on(DM2.EVENT_TOGGLE_HOWTO,this.onOverlayToggled,this)},Button.prototype.update=function(t){if(this.activeImage&&this.normalImage)if(this.delayedHandleInput&&(this.delayedHandleInput(),this.delayedHandleInput=null),this.hasFocus){if(pc.platform.mobile||(this.imageElement.texture=this.activeImage.resource),this.app.keyboard.wasPressed(pc.KEY_SPACE)||this.app.keyboard.wasPressed(pc.KEY_ENTER)){if(!this.enabled||!DM2.checkIfActiveInHeirachy(this.entity))return;this.delayedHandleInput=this.handleInput}}else this.imageElement.texture=this.normalImage.resource},Button.prototype.onEnable=function(){pc.platform.mobile?(this.app.touch.off(pc.EVENT_TOUCHSTART,this.onTouchStart,this),this.app.touch.on(pc.EVENT_TOUCHSTART,this.onTouchStart,this)):(this.app.mouse.off(pc.EVENT_MOUSEDOWN,this.onMouseDown,this),this.app.mouse.off(pc.EVENT_MOUSEMOVE,this.onMouseMove,this),this.app.mouse.on(pc.EVENT_MOUSEDOWN,this.onMouseDown,this),this.app.mouse.on(pc.EVENT_MOUSEMOVE,this.onMouseMove,this)),this.hasFocus=!1,this.isActive=!0,this.imageElement.texture=this.normalImage.resource,this.transition.transitionIn()},Button.prototype.onDisable=function(){this.hasFocus=!1,this.isActive=!1,pc.platform.mobile?this.app.touch.off(pc.EVENT_TOUCHSTART,this.onTouchStart,this):(this.app.mouse.off(pc.EVENT_MOUSEDOWN,this.onMouseDown,this),this.app.mouse.off(pc.EVENT_MOUSEMOVE,this.onMouseMove,this))},Button.prototype.setFocus=function(t){this.hasFocus=t},Button.prototype.onMouseDown=function(t){var e=this.element.canvasPosition;t.cancelBubble||this.isButtonHit(t,e)&&this.handleInput(t)},Button.prototype.onMouseMove=function(t){if(this.isActive){var e=this.element.canvasPosition,i=this.isButtonHit(t,e);i&&!this.hasFocus?(this.hasFocus=!0,this.voiceOver&&this.app.fire(DM2.EVENT_PLAY_VOICEOVER,this.voiceOver)):!i&&this.hasFocus&&(this.hasFocus=!1)}},Button.prototype.onTouchStart=function(t){var e=this.element.canvasPosition;1===t.touches.length&&this.isButtonHit(t.touches[0],e)&&(this.voiceOver&&this.app.fire(DM2.EVENT_PLAY_VOICEOVER,this.voiceOver),this.handleInput(t.touches[0]))},Button.prototype.onOverlayToggled=function(t){this.toggleCount+=t?-1:1,0<this.toggleCount&&(this.toggleCount=0),this.isActive=0===this.toggleCount},Button.prototype.handleInput=function(t){this.enabled&&DM2.checkIfActiveInHeirachy(this.entity)&&this.isActive&&(t&&(t.cancelBubble=!0),this.app.fire(DM2.EVENT_BUTTON_CLICK,{category:this.category,data:this.data}))},Button.prototype.isButtonHit=function(t,e){var i=this.screen.scale,s=e.x+this.halfWidth*i,n=e.x-this.halfWidth*i,o=e.y+this.halfHeight*i,r=e.y-this.halfHeight*i;return t.x<s&&t.x>n&&t.y<o&&t.y>r};var HowToUi=pc.createScript("howtoUi");HowToUi.attributes.add("howToContent",{type:"asset",assetType:"html",title:"HowTo HTML"}),HowToUi.prototype.initialize=function(){HowToUi.divContent=document.querySelector(".howToOverlay"),HowToUi.divContent||(HowToUi.divContent=document.createElement("div"),HowToUi.divContent.classList.add("howToOverlay"),this.injectContent()),HowToUi.divContent.innerHTML=this.howToContent.resource||"",this.bindEvents(),this.showNextSlide(),this.hideHowToOverlay()},HowToUi.prototype.showHowToOverlay=function(t){var e=HowToUi.divContent;e.style.display="block",e.parentNode.appendChild(e),this.isVisible=!0},HowToUi.prototype.hideHowToOverlay=function(){HowToUi.divContent.style.display="none",this.isVisible=!1},HowToUi.prototype.injectContent=function(){var t=DM2.getGameHolder();t?t.appendChild(HowToUi.divContent):document.body.appendChild(HowToUi.divContent)},HowToUi.prototype.bindEvents=function(){var t=HowToUi.divContent.querySelector(".back");if(t){var e=function(){DM2.sendActionEvent(DM2.BMI_ACTION_BACK,DM2.SCREEN_ID_HOWTO),this.app.fire(DM2.EVENT_TOGGLE_HOWTO,!1)}.bind(this);DM2.addEventListeners(t,e,DM2.voiceOver.back,this.app)}var i=HowToUi.divContent.querySelector(".skip");if(i){var s=function(){DM2.sendActionEvent(DM2.BMI_ACTION_CONTINUE,DM2.SCREEN_ID_HOWTO),this.app.fire(DM2.EVENT_TOGGLE_HOWTO,!1)}.bind(this);DM2.addEventListeners(i,s,DM2.voiceOver.skip,this.app)}var n=HowToUi.divContent.querySelector(".soundOn");if(n){var o=function(){DM2.isMuted()?DM2.sendActionEvent(DM2.BMI_ACTION_UNMUTE,DM2.SCREEN_ID_HOWTO):DM2.sendActionEvent(DM2.BMI_ACTION_MUTE,DM2.SCREEN_ID_HOWTO),this.app.fire(DM2.EVENT_TOGGLE_SFX,!DM2.isMuted())}.bind(this);DM2.isMuted()&&(n.className="soundOff"),DM2.addEventListeners(n,o,DM2.voiceOver.toggleSound,this.app)}var r=HowToUi.divContent.querySelector(".settings");if(r){var a=function(){DM2.sendActionEvent(DM2.BMI_ACTION_SETTINGS,DM2.SCREEN_ID_HOWTO),this.app.fire(DM2.EVENT_TOGGLE_SETTINGS,!0)}.bind(this);DM2.addEventListeners(r,a,DM2.voiceOver.settings,this.app)}var l=HowToUi.divContent.querySelector(".nextButton");if(l){var h=function(){this.showNextSlide()}.bind(this);DM2.addEventListeners(l,h)}var c=HowToUi.divContent.querySelector(".prevButton");if(c){var p=function(){this.showPrevSlide()}.bind(this);DM2.addEventListeners(c,p)}this.app.on(DM2.EVENT_TOGGLE_HOWTO,this.onToggleHowTo,this),this.app.on(DM2.EVENT_TOGGLE_SFX,this.onToggleSFX,this)},HowToUi.prototype.onToggleHowTo=function(t,e){t?this.showHowToOverlay(e):this.hideHowToOverlay(),this.setViewControlsEnabled(!t)},HowToUi.prototype.showNextSlide=function(){var t=HowToUi.divContent.querySelector("#infoImage");void 0===this.currentSlide?this.currentSlide=0:(this.currentSlide++,5<this.currentSlide&&(this.currentSlide=5)),t.className="infoImage"+this.currentSlide,this.setAltText(),this.updateDotsHolder()},HowToUi.prototype.showPrevSlide=function(){var t=HowToUi.divContent.querySelector("#infoImage");void 0===this.currentSlide?this.currentSlide=0:(this.currentSlide--,this.currentSlide<0&&(this.currentSlide=0)),t.className="infoImage"+this.currentSlide,this.setAltText(),this.updateDotsHolder()},HowToUi.prototype.updateDotsHolder=function(){this.currentDot&&(this.currentDot.style.display="none"),this.currentDot=HowToUi.divContent.querySelector("#dot"+this.currentSlide),this.currentDot.style.display="block"},HowToUi.prototype.setAltText=function(){switch(this.currentSlide){case 0:pc.platform.mobile?infoImage.setAttribute("alt","Tap the arrows to switch lanes"):infoImage.setAttribute("alt","Switch lanes by pressing the left, right or A, D keys on your keyboard");break;case 1:infoImage.setAttribute("alt","Avoid the obstacles");break;case 2:infoImage.setAttribute("alt","Pick up nitro boosters to go faster");break;case 3:infoImage.setAttribute("alt","Use ramps to jump");break;case 4:infoImage.setAttribute("alt","Collect all the coins");break;case 5:infoImage.setAttribute("alt","Pick up lasers to blast obstacles out of the way")}},HowToUi.prototype.onToggleSFX=function(t){DM2.setMuted(t);var e=HowToUi.divContent.querySelector("#sound");e&&(DM2.isMuted()?e.className="soundOff":e.className="soundOn")},HowToUi.prototype.setViewControlsEnabled=function(t){this.app.root.findByName("PauseUi").script.pauseUi.setControlsVisible(t);var e=this.app.root.findByName("MainUi");e&&e.script.main_ui.setControlsVisible(t)};var ResultUi=pc.createScript("resultUi");ResultUi.attributes.add("resultContent",{type:"asset",assetType:"html",title:"Result HTML"}),ResultUi.prototype.initialize=function(){ResultUi.divContent=document.querySelector(".resultScreen"),this.sfxManager=DM2.findSFXManagerForApp(this.app),ResultUi.divContent||(ResultUi.divContent=document.createElement("div"),ResultUi.divContent.classList.add("resultScreen"),this.injectContent()),this.star1Fill=this.entity.findByName("Star1Fill"),this.star2Fill=this.entity.findByName("Star2Fill"),this.star3Fill=this.entity.findByName("Star3Fill"),this.titleText=this.entity.findByName("TitleText"),this.timerText=this.entity.findByName("TimeText"),this.blueprintText=this.entity.findByName("BlueprintText"),this.bestTimeText=this.entity.findByName("BestTimeText"),this.underTimeText=this.entity.findByName("TimeUnderText"),ResultUi.divContent.innerHTML=this.resultContent.resource||"",this.bindEvents(),ResultUi.divContent.style.display="none",this.app.on(DM2.EVENT_TOGGLE_PAUSE,this.onTogglePause,this),this.displayTimeout=0,this.hasDisplayed=!1},ResultUi.prototype.update=function(t){this.displayTimeout+=t,!this.hasDisplayed&&2<this.displayTimeout&&(ResultUi.divContent.style.display="block",this.hasDisplayed=!0)},ResultUi.prototype.setScore=function(t){this.timerText.element.text=t.totalTime,this.blueprintText.element.text=t.blueprintScore,this.underTimeText.element.text=t.targetTime,this.bestTimeText.element.text=t.bestTime;var e=DM2.SFX_SCORE_1;this.titleText.element.text="COMPLETE!",1<t.totalStars&&(this.titleText.element.text="GOOD RUN!",e=DM2.SFX_SCORE_2),2<t.totalStars&&(this.titleText.element.text="CLEAN RUN!",e=DM2.SFX_SCORE_3),this.timerText.setLocalScale(1,.001,1),this.star1Fill.setLocalScale(.001,.001,.001),this.star2Fill.setLocalScale(.001,.001,.001),this.star3Fill.setLocalScale(.001,.001,.001);var i=.5;this.timerText.tween(this.timerText.getLocalScale()).to({x:1,y:1,z:1},.5,pc.ElasticInOut).delay(i).start(),t.underTime&&(i+=.5,this.star1Fill.tween(this.star1Fill.getLocalScale()).to({x:1,y:1,z:1},.5,pc.ElasticInOut).delay(i).start()),t.allBlueprints&&(i+=.5,this.star2Fill.tween(this.star2Fill.getLocalScale()).to({x:1,y:1,z:1},.5,pc.ElasticInOut).delay(i).start()),t.noCrashes&&(i+=.5,this.star3Fill.tween(this.star3Fill.getLocalScale()).to({x:1,y:1,z:1},.5,pc.ElasticInOut).delay(i).start()),this.sfxManager.play(e)},ResultUi.prototype.injectContent=function(){var t=DM2.getGameHolder();t?t.appendChild(ResultUi.divContent):document.body.appendChild(ResultUi.divContent)},ResultUi.prototype.bindEvents=function(){var e=this.app,t=ResultUi.divContent.querySelector(".continueButton");if(t){DM2.addEventListeners(t,function(t){DM2.sendActionEvent(DM2.BMI_ACTION_CONTINUE,DM2.SCREEN_ID_RESULT),e.fire(DM2.EVENT_GAME_CONTINUE)},DM2.voiceOver.continue,this.app)}var i=ResultUi.divContent.querySelector(".restartButton");if(i){DM2.addEventListeners(i,function(t){DM2.sendActionEvent(DM2.BMI_ACTION_RESTART,DM2.SCREEN_ID_RESULT),e.fire(DM2.EVENT_LEVEL_RESTART)},DM2.voiceOver.playAgain,this.app)}var s=ResultUi.divContent.querySelector(".pause");if(s){DM2.addEventListeners(s,function(){DM2.sendActionEvent(DM2.BMI_ACTION_PAUSE,DM2.SCREEN_ID_GAME),e.fire(DM2.EVENT_TOGGLE_PAUSE,!0)},DM2.voiceOver.pause,this.app)}},ResultUi.prototype.onTogglePause=function(t){ResultUi.divContent.style.display=t?"none":"block"};var UiStyle=pc.createScript("ui-style");UiStyle.attributes.add("targetPlatform",{type:"number",default:0,enum:[{mobile:0},{desktop:1}]}),UiStyle.attributes.add("commonStyle",{type:"asset",assetType:"css",title:"Common CSS"}),UiStyle.attributes.add("howto",{type:"asset",title:"How to Play"}),UiStyle.attributes.add("howtoHover",{type:"asset",title:"How to Play - Hover"}),UiStyle.attributes.add("howtoPressed",{type:"asset",title:"How to Play - Pressed"}),UiStyle.attributes.add("pause",{type:"asset",title:"Pause"}),UiStyle.attributes.add("pauseHover",{type:"asset",title:"Pause - Hover"}),UiStyle.attributes.add("pausePressed",{type:"asset",title:"Pause - Pressed"}),UiStyle.attributes.add("settings",{type:"asset",title:"Settings"}),UiStyle.attributes.add("settingsHover",{type:"asset",title:"Settings - Hover"}),UiStyle.attributes.add("settingsPressed",{type:"asset",title:"Settings - Pressed"}),UiStyle.attributes.add("soundOn",{type:"asset",title:"Sound On"}),UiStyle.attributes.add("soundOnHover",{type:"asset",title:"Sound On - Hover"}),UiStyle.attributes.add("soundOnPressed",{type:"asset",title:"Sound On - Pressed"}),UiStyle.attributes.add("soundOff",{type:"asset",title:"Sound Off"}),UiStyle.attributes.add("soundOffHover",{type:"asset",title:"Sound Off - Hover"}),UiStyle.attributes.add("soundOffPressed",{type:"asset",title:"Sound Off - Pressed"}),UiStyle.attributes.add("home",{type:"asset",title:"Home"}),UiStyle.attributes.add("homeHover",{type:"asset",title:"Home - Hover"}),UiStyle.attributes.add("homePressed",{type:"asset",title:"Home - Pressed"}),UiStyle.attributes.add("back",{type:"asset",title:"Back"}),UiStyle.attributes.add("backHover",{type:"asset",title:"Back - Hover"}),UiStyle.attributes.add("backPressed",{type:"asset",title:"Back - Pressed"}),UiStyle.attributes.add("start",{type:"asset",title:"Start"}),UiStyle.attributes.add("startHover",{type:"asset",title:"Start - Hover"}),UiStyle.attributes.add("startPressed",{type:"asset",title:"Start - Pressed"}),UiStyle.attributes.add("exit",{type:"asset",title:"Exit"}),UiStyle.attributes.add("exitHover",{type:"asset",title:"Exit - Hover"}),UiStyle.attributes.add("exitPressed",{type:"asset",title:"Exit - Pressed"}),UiStyle.attributes.add("overlayBackground",{type:"asset",title:"Overlay Background"}),UiStyle.attributes.add("clearColorImage",{type:"asset",title:"Clear Color Image"}),UiStyle.attributes.add("titleBackground",{type:"asset",title:"Title Background"}),UiStyle.attributes.add("hudStyle",{type:"asset",assetType:"css",title:"HUD CSS"}),UiStyle.attributes.add("leftButton",{type:"asset",title:"Left"}),UiStyle.attributes.add("leftButtonPressed",{type:"asset",title:"Left - Pressed"}),UiStyle.attributes.add("rightButton",{type:"asset",title:"Right"}),UiStyle.attributes.add("rightButtonPressed",{type:"asset",title:"Right - Pressed"}),UiStyle.attributes.add("keyboardControlsArrows",{type:"asset",title:"Arrow Keyboard Controls"}),UiStyle.attributes.add("keyboardControlsWASD",{type:"asset",title:"WASD Keyboard Controls"}),UiStyle.attributes.add("howToStyle",{type:"asset",assetType:"css",title:"HowTo CSS"}),UiStyle.attributes.add("howToInfoImage0",{type:"asset",title:"Info Image 1"}),UiStyle.attributes.add("howToInfoImage0_desktop",{type:"asset",title:"Info Image 1 - Desktop Version"}),UiStyle.attributes.add("howToInfoImage1",{type:"asset",title:"Info Image 2"}),UiStyle.attributes.add("howToInfoImage2",{type:"asset",title:"Info Image 3"}),UiStyle.attributes.add("howToInfoImage3",{type:"asset",title:"Info Image 4"}),UiStyle.attributes.add("howToInfoImage4",{type:"asset",title:"Info Image 5"}),UiStyle.attributes.add("howToInfoImage5",{type:"asset",title:"Info Image 6"}),UiStyle.attributes.add("howToDotHolder",{type:"asset",title:"Dot Holder"}),UiStyle.attributes.add("howToDotFill",{type:"asset",title:"Dot Fill"}),UiStyle.attributes.add("howToPrevButton",{type:"asset",title:"Previous Button"}),UiStyle.attributes.add("howToNextButton",{type:"asset",title:"Next Button"}),UiStyle.attributes.add("mainStyle",{type:"asset",assetType:"css",title:"Main CSS"}),UiStyle.attributes.add("skip",{type:"asset",title:"Skip"}),UiStyle.attributes.add("skipHover",{type:"asset",title:"Skip - Hover"}),UiStyle.attributes.add("skipPressed",{type:"asset",title:"Skip - Pressed"}),UiStyle.attributes.add("pauseStyle",{type:"asset",assetType:"css",title:"Pause CSS"}),UiStyle.attributes.add("replay",{type:"asset",title:"Replay"}),UiStyle.attributes.add("replayHover",{type:"asset",title:"Replay - Hover"}),UiStyle.attributes.add("replayPressed",{type:"asset",title:"Replay - Pressed"}),UiStyle.attributes.add("levelSelect",{type:"asset",title:"Level Select"}),UiStyle.attributes.add("levelSelectHover",{type:"asset",title:"Level Select - Hover"}),UiStyle.attributes.add("levelSelectPressed",{type:"asset",title:"Level Select - Pressed"}),UiStyle.attributes.add("resultStyle",{type:"asset",assetType:"css",title:"Result CSS"}),UiStyle.attributes.add("resultContinue",{type:"asset",title:"Continue"}),UiStyle.attributes.add("resultContinueHover",{type:"asset",title:"Continue - Hover"}),UiStyle.attributes.add("resultContinuePressed",{type:"asset",title:"Continue - Pressed"}),UiStyle.attributes.add("resultRestart",{type:"asset",title:"Restart"}),UiStyle.attributes.add("resultRestartHover",{type:"asset",title:"Restart - Hover"}),UiStyle.attributes.add("resultRestartPressed",{type:"asset",title:"Restart - Pressed"}),UiStyle.attributes.add("settingsStyle",{type:"asset",assetType:"css",title:"Settings CSS"}),UiStyle.attributes.add("toggleOn",{type:"asset",title:"Toggle On"}),UiStyle.attributes.add("toggleOff",{type:"asset",title:"Toggle Off"}),UiStyle.attributes.add("settingsCloseButton",{type:"asset",title:"Settings Close"}),UiStyle.attributes.add("settingsIcon",{type:"asset",title:"Settings Icon"}),UiStyle.prototype.initialize=function(){window.addEventListener("resize",this.onResize.bind(this)),this.onResize()},UiStyle.prototype.onResize=function(){var t=window.innerWidth;t>DM2.MOBILE_MAX_WIDTH&&1===this.targetPlatform?this.injectDynamicContent():t<=DM2.MOBILE_MAX_WIDTH&&0===this.targetPlatform&&this.injectDynamicContent()},UiStyle.prototype.injectDynamicContent=function(){this.injectCommonStyle(),this.injectGameStyle(),this.injectHowToStyle(),this.injectMainMenuStyle(),this.injectPauseStyle(),this.injectResultStyle(),this.injectSettingsStyle()},UiStyle.prototype.injectCommonStyle=function(){var t=document.getElementById("dm-common-style");t||((t=document.createElement("style")).id="dm-common-style",document.head.appendChild(t)),t.innerHTML=this.commonStyle.resource||"",t.innerHTML=t.innerHTML.replace("[button-img-howto]",this.howto.getFileUrl()),t.innerHTML=t.innerHTML.replace("[button-img-howto:hover]",this.howtoHover.getFileUrl()),t.innerHTML=t.innerHTML.replace("[button-img-howto:pressed]",this.howtoPressed.getFileUrl()),t.innerHTML=t.innerHTML.replace("[button-img-pause]",this.pause.getFileUrl()),t.innerHTML=t.innerHTML.replace("[button-img-pause:hover]",this.pauseHover.getFileUrl()),t.innerHTML=t.innerHTML.replace("[button-img-pause:pressed]",this.pausePressed.getFileUrl()),t.innerHTML=t.innerHTML.replace("[button-img-settings]",this.settings.getFileUrl()),t.innerHTML=t.innerHTML.replace("[button-img-settings:hover]",this.settingsHover.getFileUrl()),t.innerHTML=t.innerHTML.replace("[button-img-settings:pressed]",this.settingsPressed.getFileUrl()),t.innerHTML=t.innerHTML.replace("[button-img-home]",this.home.getFileUrl()),t.innerHTML=t.innerHTML.replace("[button-img-home:hover]",this.homeHover.getFileUrl()),t.innerHTML=t.innerHTML.replace("[button-img-home:pressed]",this.homePressed.getFileUrl()),t.innerHTML=t.innerHTML.replace("[button-img-back]",this.back.getFileUrl()),t.innerHTML=t.innerHTML.replace("[button-img-back:hover]",this.backHover.getFileUrl()),t.innerHTML=t.innerHTML.replace("[button-img-back:pressed]",this.backPressed.getFileUrl()),t.innerHTML=t.innerHTML.replace("[button-img-soundOn]",this.soundOn.getFileUrl()),t.innerHTML=t.innerHTML.replace("[button-img-soundOn:hover]",this.soundOnHover.getFileUrl()),t.innerHTML=t.innerHTML.replace("[button-img-soundOn:pressed]",this.soundOnPressed.getFileUrl()),t.innerHTML=t.innerHTML.replace("[button-img-soundOff]",this.soundOff.getFileUrl()),t.innerHTML=t.innerHTML.replace("[button-img-soundOff:hover]",this.soundOffHover.getFileUrl()),t.innerHTML=t.innerHTML.replace("[button-img-soundOff:pressed]",this.soundOffPressed.getFileUrl()),t.innerHTML=t.innerHTML.replace("[button-img-start]",this.start.getFileUrl()),t.innerHTML=t.innerHTML.replace("[button-img-start:hover]",this.startHover.getFileUrl()),t.innerHTML=t.innerHTML.replace("[button-img-start:pressed]",this.startPressed.getFileUrl()),t.innerHTML=t.innerHTML.replace("[button-img-exit]",this.exit.getFileUrl()),t.innerHTML=t.innerHTML.replace("[button-img-exit:hover]",this.exitHover.getFileUrl()),t.innerHTML=t.innerHTML.replace("[button-img-exit:pressed]",this.exitPressed.getFileUrl()),DM2.gmi?t.innerHTML=t.innerHTML.replace(/\[asset-dir\]/g,DM2.gmi.gameDir||"."):t.innerHTML=t.innerHTML.replace(/\[asset-dir\]/g,".")},UiStyle.prototype.injectGameStyle=function(){var t=document.getElementById("hudStyle");t||((t=document.createElement("style")).id="hudStyle",document.head.appendChild(t),t.innerHTML=this.hudStyle.resource||"",t.innerHTML=t.innerHTML.replace("[button-img-left]",this.leftButton.getFileUrl()),t.innerHTML=t.innerHTML.replace("[button-img-left:pressed]",this.leftButtonPressed.getFileUrl()),t.innerHTML=t.innerHTML.replace("[button-img-right]",this.rightButton.getFileUrl()),t.innerHTML=t.innerHTML.replace("[button-img-right:pressed]",this.rightButtonPressed.getFileUrl()),pc.platform.mobile||(t.innerHTML=t.innerHTML.replace("[img-keyboard-wasd]",this.keyboardControlsWASD.getFileUrl()),t.innerHTML=t.innerHTML.replace("[img-keyboard-arrows]",this.keyboardControlsArrows.getFileUrl())),DM2.gmi?t.innerHTML=t.innerHTML.replace(/\[asset-dir\]/g,DM2.gmi.gameDir||"."):t.innerHTML=t.innerHTML.replace(/\[asset-dir\]/g,"."))},UiStyle.prototype.injectHowToStyle=function(){var t=document.getElementById("howToUiStyle");t||((t=document.createElement("style")).id="howToUiStyle",document.head.appendChild(t),t.innerHTML=this.howToStyle.resource||"",t.innerHTML=t.innerHTML.replace("[button-img-prev]",this.howToPrevButton.getFileUrl()),t.innerHTML=t.innerHTML.replace("[button-img-next]",this.howToNextButton.getFileUrl()),pc.platform.mobile?t.innerHTML=t.innerHTML.replace("[button-img-howToInfo0]",this.howToInfoImage0.getFileUrl()):t.innerHTML=t.innerHTML.replace("[button-img-howToInfo0]",this.howToInfoImage0_desktop.getFileUrl()),t.innerHTML=t.innerHTML.replace("[button-img-howToInfo1]",this.howToInfoImage1.getFileUrl()),t.innerHTML=t.innerHTML.replace("[button-img-howToInfo2]",this.howToInfoImage2.getFileUrl()),t.innerHTML=t.innerHTML.replace("[button-img-howToInfo3]",this.howToInfoImage3.getFileUrl()),t.innerHTML=t.innerHTML.replace("[button-img-howToInfo4]",this.howToInfoImage4.getFileUrl()),t.innerHTML=t.innerHTML.replace("[button-img-howToInfo5]",this.howToInfoImage5.getFileUrl()),t.innerHTML=t.innerHTML.replace("[img-dot-holder]",this.howToDotHolder.getFileUrl()),t.innerHTML=t.innerHTML.replace("[img-dot-fill]",this.howToDotFill.getFileUrl()),t.innerHTML=t.innerHTML.replace("[background-img-howTo]",this.overlayBackground.getFileUrl()))},UiStyle.prototype.injectMainMenuStyle=function(){var t=document.getElementById("mainUiStyle");t||((t=document.createElement("style")).id="mainUiStyle",document.head.appendChild(t),t.innerHTML=this.mainStyle.resource||"",t.innerHTML=t.innerHTML.replace("[button-img-skip]",this.skip.getFileUrl()),t.innerHTML=t.innerHTML.replace("[button-img-skip:hover]",this.skipHover.getFileUrl()),t.innerHTML=t.innerHTML.replace("[button-img-skip:pressed]",this.skipPressed.getFileUrl()))},UiStyle.prototype.injectPauseStyle=function(){var t=document.getElementById("pauseUiStyle");if(!t){(t=document.createElement("style")).id="pauseUiStyle",document.head.appendChild(t);var e="@font-face { font-family : 'Rubik'; src : url("+(DM2.gmi?DM2.gmi.gameDir+"splash/rubik.woff2":"https://fonts.gstatic.com/s/rubik/v4/UAhftYFr35UpkSlTfXNWLwzyDMXhdD8sAj6OAJTFsBI.woff2")+"); } \n";t.innerHTML=e+(this.pauseStyle.resource||""),t.innerHTML=t.innerHTML.replace("[background-title]",this.titleBackground.getFileUrl()),t.innerHTML=t.innerHTML.replace("[button-img-restart]",this.replay.getFileUrl()),t.innerHTML=t.innerHTML.replace("[button-img-restart:hover]",this.replayHover.getFileUrl()),t.innerHTML=t.innerHTML.replace("[button-img-restart:pressed]",this.replayPressed.getFileUrl()),t.innerHTML=t.innerHTML.replace("[button-img-levelSelect]",this.levelSelect.getFileUrl()),t.innerHTML=t.innerHTML.replace("[button-img-levelSelect:hover]",this.levelSelectHover.getFileUrl()),t.innerHTML=t.innerHTML.replace("[button-img-levelSelect:pressed]",this.levelSelectPressed.getFileUrl()),t.innerHTML=t.innerHTML.replace("[button-img-resume]",this.start.getFileUrl()),t.innerHTML=t.innerHTML.replace("[button-img-resume:hover]",this.startHover.getFileUrl()),t.innerHTML=t.innerHTML.replace("[button-img-resume:pressed]",this.startPressed.getFileUrl()),t.innerHTML=t.innerHTML.replace("[background-img-pause]",this.overlayBackground.getFileUrl())}},UiStyle.prototype.injectResultStyle=function(){var t=document.getElementById("resultUiStyle");t||((t=document.createElement("style")).id="resultUiStyle",document.head.appendChild(t),t.innerHTML=this.resultStyle.resource||"",t.innerHTML=t.innerHTML.replace("[button-img-resultContinue]",this.resultContinue.getFileUrl()),t.innerHTML=t.innerHTML.replace("[button-img-resultContinue:hover]",this.resultContinueHover.getFileUrl()),t.innerHTML=t.innerHTML.replace("[button-img-resultContinue:pressed]",this.resultContinuePressed.getFileUrl()),t.innerHTML=t.innerHTML.replace("[button-img-resultRestart]",this.resultRestart.getFileUrl()),t.innerHTML=t.innerHTML.replace("[button-img-resultRestart:hover]",this.resultRestartHover.getFileUrl()),t.innerHTML=t.innerHTML.replace("[button-img-resultRestart:pressed]",this.resultRestartPressed.getFileUrl()))},UiStyle.prototype.injectSettingsStyle=function(){var t=document.getElementById("settingsUiStyle");t||((t=document.createElement("style")).id="settingsUiStyle",document.head.appendChild(t),t.innerHTML=this.settingsStyle.resource||"",t.innerHTML=t.innerHTML.replace("[button-img-toggleOn]",this.toggleOn.getFileUrl()),t.innerHTML=t.innerHTML.replace("[button-img-toggleOff]",this.toggleOff.getFileUrl()),t.innerHTML=t.innerHTML.replace("[button-img-settingsClose]",this.settingsCloseButton.getFileUrl()),t.innerHTML=t.innerHTML.replace("[background-img-settings]",this.overlayBackground.getFileUrl()),t.innerHTML=t.innerHTML.replace("[img-settings-icon]",this.settingsIcon.getFileUrl()))};var NoanimProp=pc.createScript("noanimProp");NoanimProp.prototype.initialize=function(){this.propManager=this.app.root.findByName("PropManager").script.propManager,this.propBase=this.entity.script.propBase,this.propBase.registerCallbacks(this.onCollision,this.onResetProp,this)},NoanimProp.prototype.onCollision=function(t){this.app.fire(DM2.EVENT_TRIGGER_SFX,DM2.SFX_CAR_CRASH),this.entity.hit=!0,this.propManager.spawnPropDirect("explosion",this.entity.getPosition()),t.crashVehicle()};var IntroScreen=pc.createScript("intro_screen");IntroScreen.prototype.initialize=function(){this.greenbackUIElement=this.entity.findByName("Greenback"),this.loociferUIElement=this.entity.findByName("Loocifer"),this.quarkUIElement=this.entity.findByName("Quark"),this.culpritUIElement=this.entity.findByName("Culprit"),this.dangerUIElement=this.entity.findByName("DM"),this.penfoldUIElement=this.entity.findByName("Penfold"),this.pomPomUIElement=this.entity.findByName("PomPom"),this.brunelUIElement=this.entity.findByName("Brunel"),this.textLine0=this.entity.findByName("Line0Text"),this.textLine1=this.entity.findByName("Line1Text"),this.textLine2=this.entity.findByName("Line2Text")},IntroScreen.prototype.setLocation=function(t,e){switch(t){case DM2.LOCATION_LONDON:this.setLocationLondon(e);break;case DM2.LOCATION_TOKYO:this.setLocationTokyo(e);break;case DM2.LOCATION_SPACE:this.setLocationSpace(e);break;case DM2.LOCATION_TRENCH:this.setLocationTrench(e);break;case DM2.LOCATION_FACTORY:this.setLocationFactory(e)}},IntroScreen.prototype.setLocationLondon=function(t){switch(this.greenbackUIElement.enabled=!0,this.loociferUIElement.enabled=!1,this.quarkUIElement.enabled=!1,this.culpritUIElement.enabled=!1,this.pomPomUIElement.enabled=!1,this.brunelUIElement.enabled=!1,t){case DM2.trackIDs.London01:case DM2.trackIDs.London02:this.textLine0.element.text="Mission...",this.textLine1.element.text="...reach...",this.textLine2.element.text="...the Baron";break;case DM2.trackIDs.LondonBoss:this.textLine0.element.text="Mission...",this.textLine1.element.text="...catch...",this.textLine2.element.text="...the Baron"}this.playIntroAnimation(this.greenbackUIElement)},IntroScreen.prototype.setLocationTokyo=function(t){switch(this.greenbackUIElement.enabled=!1,this.loociferUIElement.enabled=!1,this.quarkUIElement.enabled=!1,this.culpritUIElement.enabled=!1,this.pomPomUIElement.enabled=!1,this.brunelUIElement.enabled=!1,t){case DM2.trackIDs.Tokyo01:this.culpritUIElement.enabled=!0,this.textLine0.element.text="Mission...",this.textLine1.element.text="...find...",this.textLine2.element.text="...the culprit",this.playIntroAnimation(this.culpritUIElement);break;case DM2.trackIDs.Tokyo02:this.loociferUIElement.enabled=!0,this.textLine0.element.text="Mission...",this.textLine1.element.text="...reach...",this.textLine2.element.text="...Dr. Loo-cifer",this.playIntroAnimation(this.loociferUIElement);break;case DM2.trackIDs.TokyoBoss:this.loociferUIElement.enabled=!0,this.textLine0.element.text="Mission...",this.textLine1.element.text="...defeat...",this.textLine2.element.text="...Dr. Loo-cifer",this.playIntroAnimation(this.loociferUIElement)}},IntroScreen.prototype.setLocationSpace=function(t){switch(this.greenbackUIElement.enabled=!1,this.loociferUIElement.enabled=!1,this.quarkUIElement.enabled=!0,this.culpritUIElement.enabled=!1,this.pomPomUIElement.enabled=!1,this.brunelUIElement.enabled=!1,t){case DM2.trackIDs.Space01:case DM2.trackIDs.Space02:this.textLine0.element.text="Mission...",this.textLine1.element.text="...find...",this.textLine2.element.text="...Quark";break;case DM2.trackIDs.SpaceBoss:this.textLine0.element.text="Mission...",this.textLine1.element.text="...stop...",this.textLine2.element.text="...Quark"}this.playIntroAnimation(this.quarkUIElement)},IntroScreen.prototype.setLocationTrench=function(t){switch(this.greenbackUIElement.enabled=!1,this.loociferUIElement.enabled=!1,this.quarkUIElement.enabled=!1,this.culpritUIElement.enabled=!1,this.pomPomUIElement.enabled=!0,this.brunelUIElement.enabled=!1,t){case DM2.trackIDs.Trench01:this.textLine0.element.text="Mission...",this.textLine1.element.text="...find...",this.textLine2.element.text="...Pom Pom";break;case DM2.trackIDs.Trench02:this.textLine0.element.text="Mission...",this.textLine1.element.text="...chase...",this.textLine2.element.text="...Pom Pom";break;case DM2.trackIDs.TrenchBoss:this.textLine0.element.text="Mission...",this.textLine1.element.text="...defeat...",this.textLine2.element.text="...Pom Pom"}this.playIntroAnimation(this.pomPomUIElement)},IntroScreen.prototype.setLocationFactory=function(t){switch(this.greenbackUIElement.enabled=!1,this.loociferUIElement.enabled=!1,this.quarkUIElement.enabled=!1,this.culpritUIElement.enabled=!1,this.pomPomUIElement.enabled=!1,this.brunelUIElement.enabled=!0,t){case DM2.trackIDs.Factory01:this.textLine0.element.text="Mission...",this.textLine1.element.text="...find...",this.textLine2.element.text="...Isambard";break;case DM2.trackIDs.Factory02:this.textLine0.element.text="Mission...",this.textLine1.element.text="...chase...",this.textLine2.element.text="...Isambard";break;case DM2.trackIDs.FactoryBoss:this.textLine0.element.text="Mission...",this.textLine1.element.text="...defeat...",this.textLine2.element.text="...Isambard"}this.playIntroAnimation(this.brunelUIElement)},IntroScreen.prototype.playIntroAnimation=function(t){var e=this.dangerUIElement.getLocalPosition().clone(),i=this.penfoldUIElement.getLocalPosition().clone(),s=t.getLocalPosition().clone();this.dangerUIElement.setLocalPosition(e.x-600,e.y,e.z),this.penfoldUIElement.setLocalPosition(i.x+600,i.y,i.z),t.setLocalPosition(s.x-600,s.y,s.z),this.textLine0.element.opacity=0,this.textLine1.element.opacity=0,this.textLine2.element.opacity=0;var n={x:e.x,y:e.y,z:e.z};this.dangerUIElement.tween(this.dangerUIElement.getLocalPosition()).to(n,1,pc.SineOut).delay(.25).on("complete",function(){this.textLine0.element.opacity=1},this).start();var o={x:i.x,y:i.y,z:i.z};this.penfoldUIElement.tween(this.penfoldUIElement.getLocalPosition()).to(o,1,pc.SineOut).delay(.75).on("complete",function(){this.textLine1.element.opacity=1},this).start();var r={x:s.x,y:s.y,z:s.z};t.tween(t.getLocalPosition()).to(r,1,pc.SineOut).delay(1.25).on("complete",function(){this.textLine2.element.opacity=1},this).start()};var UiVoiceOver=pc.createScript("uiVoiceOver");UiVoiceOver.prototype.initialize=function(){this.app.on(DM2.EVENT_PLAY_VOICEOVER,this.onPlayVoiceOver,this),this.on("disable",this.onDisable,this)},UiVoiceOver.prototype.onDisable=function(){this.app.off(DM2.EVENT_PLAY_VOICEOVER,this.onPlayVoiceOver,this)},UiVoiceOver.prototype.onPlayVoiceOver=function(t){DM2.isMuted()||(this.entity.sound.stop(),this.entity.sound.play(t))};var TrackScoreIndicator=pc.createScript("trackScoreIndicator");TrackScoreIndicator.attributes.add("trackData",{type:"asset"}),TrackScoreIndicator.attributes.add("star1",{type:"entity"}),TrackScoreIndicator.attributes.add("star2",{type:"entity"}),TrackScoreIndicator.attributes.add("star3",{type:"entity"}),TrackScoreIndicator.prototype.initialize=function(){var t=DM2.getGameData()[DM2.SETTING_DIFFICULTY],e="score_"+this.trackData.name.replace(".json","_"+t),i=DM2.getGameData()[e];this.star1.enabled=!1,this.star2.enabled=!1,this.star3.enabled=!1,i||(i=0),this.star3.enabled=3<=i,this.star2.enabled=2<=i,this.star1.enabled=1<=i};var TabSelect=pc.createScript("tabSelect");TabSelect.attributes.add("controlID0",{type:"string",title:"Control ID 0"}),TabSelect.attributes.add("controlID1",{type:"string",title:"Control ID 1"}),TabSelect.attributes.add("controlID2",{type:"string",title:"Control ID 2"}),TabSelect.attributes.add("controlID3",{type:"string",title:"Control ID 3"}),TabSelect.attributes.add("controlID4",{type:"string",title:"Control ID 4"}),TabSelect.attributes.add("controlID5",{type:"string",title:"Control ID 5"}),TabSelect.attributes.add("controlID6",{type:"string",title:"Control ID 6"}),TabSelect.attributes.add("controlID7",{type:"string",title:"Control ID 7"}),TabSelect.attributes.add("controlID8",{type:"string",title:"Control ID 8"}),TabSelect.attributes.add("controlID9",{type:"string",title:"Control ID 9"}),TabSelect.prototype.initialize=function(){this.controls=[],this.setupControls(),this.focusCurrentControl(),this.on("enable",this.onEnable),this.on("disable",this.onDisable),this.isEnabled=!0,this.app.on(DM2.EVENT_TOGGLE_PAUSE,this.onPauseToggled,this),this.app.on(DM2.EVENT_TOGGLE_HOWTO,this.onPauseToggled,this)},TabSelect.prototype.update=function(t){this.isEnabled&&this.app.keyboard.wasPressed(pc.KEY_TAB)&&this.onTabKeyDown()},TabSelect.prototype.onTabKeyDown=function(t){this.currentIndex=(this.currentIndex+1)%this.controlCount,this.focusCurrentControl()},TabSelect.prototype.onPauseToggled=function(t){this.isEnabled=!t,this.currentControl&&this.currentControl.setFocus(!t),this.isEnabled?this.setupControls():this.removeExistingFocusElements()},TabSelect.prototype.removeExistingFocusElements=function(){var t=DM2.getGameHolder();t||(t=document.body);for(var e=t.querySelectorAll("[title^=pcFocusElement]"),i=0;i<e.length;i++)e[i].parentNode.removeChild(e[i]);this.controls=[]},TabSelect.prototype.getFocusElementForIndex=function(t){var e="pcFocusElement"+t,i=document.getElementById(e),s=document.getElementById("focusElementContainer");if(!s){(s=document.createElement("div")).id="focusElementContainer";var n=DM2.getGameHolder();n||(n=document.body),n.appendChild(s)}return i||((i=document.createElement("button")).id=e,i.title=e,i.tabIndex=t,i.classList.add("tabFocus"),s.appendChild(i)),i},TabSelect.prototype.onEnable=function(){this.isEnabled=!0,this.setupControls()},TabSelect.prototype.onDisable=function(){this.isEnabled=!1},TabSelect.prototype.setupControls=function(){this.removeExistingFocusElements(),this.controlID0&&this.addControlWithID(this.controlID0),this.controlID1&&this.addControlWithID(this.controlID1),this.controlID2&&this.addControlWithID(this.controlID2),this.controlID3&&this.addControlWithID(this.controlID3),this.controlID4&&this.addControlWithID(this.controlID4),this.controlID5&&this.addControlWithID(this.controlID5),this.controlID6&&this.addControlWithID(this.controlID6),this.controlID7&&this.addControlWithID(this.controlID7),this.controlID8&&this.addControlWithID(this.controlID8),this.controlID9&&this.addControlWithID(this.controlID9),this.controlCount=this.controls.length,this.currentIndex=0},TabSelect.prototype.addControlWithID=function(t){var e=null,i=this.controls.length+1;if("."===t[0]){var s=document.getElementById(t.replace(".",""));if(!s)return;s.tabIndex=i,e={element:s,type:0}}else{var n=this.entity.findByName(t);if(!n)return;var o=n.script.button;if(!o)return;e={element:o,type:1,domElement:this.getFocusElementForIndex(i)}}null!==e&&this.controls.push(e)},TabSelect.prototype.focusCurrentControl=function(){this.currentControl&&(this.currentControl.setFocus(!1),this.currentControl=null);var t=this.controls[this.currentIndex];switch(t.type){case 0:t.element.focus();break;case 1:this.currentControl=t.element,this.currentControl.setFocus(!0),t.domElement.focus()}};var LoadingUi=pc.createScript("loadingUi"),LFT_CLOSED_X=224,RHT_CLOSED_X=-102,LFT_OPEN_X=-1e3,RHT_OPEN_X=1e3,TWEEN_TIME=1;LoadingUi.prototype.setVisibleClosed=function(){var t=this.entity.findByName("LeftShutter"),e=this.entity.findByName("RightShutter");t.setLocalPosition(LFT_CLOSED_X,0,0),e.setLocalPosition(RHT_CLOSED_X,0,0),this.entity.enabled=!0},LoadingUi.prototype.setVisibleOpen=function(){var t=this.entity.findByName("LeftShutter"),e=this.entity.findByName("RightShutter");t.setLocalPosition(LFT_OPEN_X,0,0),e.setLocalPosition(RHT_OPEN_X,0,0),this.entity.enabled=!0},LoadingUi.prototype.hide=function(){this.entity.enabled=!1},LoadingUi.prototype.playOpenAnimation=function(t,e){var i=this.entity.findByName("LeftShutter"),s=this.entity.findByName("RightShutter");i.tween(i.getLocalPosition()).to({x:LFT_OPEN_X,y:0,z:0},TWEEN_TIME,pc.SineOut).start(),s.tween(s.getLocalPosition()).to({x:RHT_OPEN_X,y:0,z:0},TWEEN_TIME,pc.SineOut).on("complete",t,e).start()},LoadingUi.prototype.playCloseAnimation=function(t,e){var i=this.entity.findByName("LeftShutter"),s=this.entity.findByName("RightShutter");this.app.fire(DM2.EVENT_TRIGGER_SFX,DM2.SFX_LOADING_START),i.tween(i.getLocalPosition()).to({x:LFT_CLOSED_X,y:0,z:0},TWEEN_TIME,pc.SineOut).start(),s.tween(s.getLocalPosition()).to({x:RHT_CLOSED_X,y:0,z:0},TWEEN_TIME,pc.SineOut).on("complete",t,e).start()},pc.extend(pc,function(){var t=function(t){this._app=t,this._tweens=[],this._add=[]};t.prototype={add:function(t){return this._add.push(t),t},update:function(t){for(var e=0,i=this._tweens.length;e<i;)this._tweens[e].update(t)?e++:(this._tweens.splice(e,1),i--);this._add.length&&(this._tweens=this._tweens.concat(this._add),this._add.length=0)}};var e=function(t,e,i){pc.events.attach(this),this.manager=e,i&&(this.entity=null),this.time=0,this.complete=!1,this.playing=!1,this.stopped=!0,this.pending=!1,this.target=t,this.duration=0,this._currentDelay=0,this.timeScale=1,this._reverse=!1,this._delay=0,this._yoyo=!1,this._count=0,this._numRepeats=0,this._repeatDelay=0,this._from=!1,this._slerp=!1,this._fromQuat=new pc.Quat,this._toQuat=new pc.Quat,this._quat=new pc.Quat,this.easing=pc.EASE_LINEAR,this._sv={},this._ev={}};e.prototype={to:function(t,e,i,s,n,o){return t instanceof pc.Vec3?this._properties={x:t.x,y:t.y,z:t.z}:t instanceof pc.Color?(this._properties={r:t.r,g:t.g,b:t.b},void 0!==t.a&&(this._properties.a=t.a)):this._properties=t,this.duration=e,i&&(this.easing=i),s&&this.delay(s),n&&this.repeat(n),o&&this.yoyo(o),this},from:function(t,e,i,s,n,o){return t instanceof pc.Vec3?this._properties={x:t.x,y:t.y,z:t.z}:t instanceof pc.Color?(this._properties={r:t.r,g:t.g,b:t.b},void 0!==t.a&&(this._properties.a=t.a)):this._properties=t,this.duration=e,i&&(this.easing=i),s&&this.delay(s),n&&this.repeat(n),o&&this.yoyo(o),this._from=!0,this},rotate:function(t,e,i,s,n,o){return t instanceof pc.Quat?this._properties={x:t.x,y:t.y,z:t.z,w:t.w}:t instanceof pc.Vec3?this._properties={x:t.x,y:t.y,z:t.z}:t instanceof pc.Color?(this._properties={r:t.r,g:t.g,b:t.b},void 0!==t.a&&(this._properties.a=t.a)):this._properties=t,this.duration=e,i&&(this.easing=i),s&&this.delay(s),n&&this.repeat(n),o&&this.yoyo(o),this._slerp=!0,this},start:function(){if(this.playing=!0,this.complete=!1,this.stopped=!1,this._count=0,this.pending=0<this._delay,this._reverse&&!this.pending?this.time=this.duration:this.time=0,this._from){for(var t in this._properties)this._sv[t]=this._properties[t],this._ev[t]=this.target[t];if(this._slerp){this._toQuat.setFromEulerAngles(this.target.x,this.target.y,this.target.z);var e=void 0!==this._properties.x?this._properties.x:this.target.x,i=void 0!==this._properties.y?this._properties.y:this.target.y,s=void 0!==this._properties.z?this._properties.z:this.target.z;this._fromQuat.setFromEulerAngles(e,i,s)}}else{for(var t in this._properties)this._sv[t]=this.target[t],this._ev[t]=this._properties[t];if(this._slerp){this._fromQuat.setFromEulerAngles(this.target.x,this.target.y,this.target.z);e=void 0!==this._properties.x?this._properties.x:this.target.x,i=void 0!==this._properties.y?this._properties.y:this.target.y,s=void 0!==this._properties.z?this._properties.z:this.target.z;this._toQuat.setFromEulerAngles(e,i,s)}}return this._currentDelay=this._delay,this.manager.add(this),this},pause:function(){this.playing=!1},resume:function(){this.playing=!0},stop:function(){this.playing=!1,this.stopped=!0},delay:function(t){return this._delay=t,this.pending=!0,this},repeat:function(t,e){return this._count=0,this._numRepeats=t,this._repeatDelay=e||0,this},loop:function(t){return t?(this._count=0,this._numRepeats=1/0):this._numRepeats=0,this},yoyo:function(t){return this._yoyo=t,this},reverse:function(){return this._reverse=!this._reverse,this},chain:function(){for(var t=arguments.length;t--;)0<t?arguments[t-1]._chained=arguments[t]:this._chained=arguments[t];return this},update:function(t){if(this.stopped)return!1;if(!this.playing)return!0;if(!this._reverse||this.pending?this.time+=t*this.timeScale:this.time-=t*this.timeScale,this.pending){if(!(this.time>this._currentDelay))return!0;this._reverse?this.time=this.duration-(this.time-this._currentDelay):this.time=this.time-this._currentDelay,this.pending=!1}var e=0;(!this._reverse&&this.time>this.duration||this._reverse&&this.time<0)&&(this._count++,this.complete=!0,this.playing=!1,this._reverse?(e=this.duration-this.time,this.time=0):(e=this.time-this.duration,this.time=this.duration));var i,s,n=this.time/this.duration,o=this.easing(n);for(var r in this._properties)i=this._sv[r],s=this._ev[r],this.target[r]=i+(s-i)*o;if(this._slerp&&this._quat.slerp(this._fromQuat,this._toQuat,o),this.entity&&(this.entity._dirtify(!0),this._slerp&&this.entity.setLocalRotation(this._quat)),this.fire("update",t),this.complete){var a=this._repeat(e);return a?this.fire("loop"):(this.fire("complete",e),this._chained&&this._chained.start()),a}return!0},_repeat:function(t){if(this._count<this._numRepeats){if(this._reverse?this.time=this.duration-t:this.time=t,this.complete=!1,this.playing=!0,this._currentDelay=this._repeatDelay,this.pending=!0,this._yoyo){for(var e in this._properties)tmp=this._sv[e],this._sv[e]=this._ev[e],this._ev[e]=tmp;this._slerp&&(this._quat.copy(this._fromQuat),this._fromQuat.copy(this._toQuat),this._toQuat.copy(this._quat))}return!0}return!1}};var i=function(t){return 1-s(1-t)},s=function(t){return t<1/2.75?7.5625*t*t:t<2/2.75?7.5625*(t-=1.5/2.75)*t+.75:t<2.5/2.75?7.5625*(t-=2.25/2.75)*t+.9375:7.5625*(t-=2.625/2.75)*t+.984375};return{TweenManager:t,Tween:e,Linear:function(t){return t},QuadraticIn:function(t){return t*t},QuadraticOut:function(t){return t*(2-t)},QuadraticInOut:function(t){return(t*=2)<1?.5*t*t:-.5*(--t*(t-2)-1)},CubicIn:function(t){return t*t*t},CubicOut:function(t){return--t*t*t+1},CubicInOut:function(t){return(t*=2)<1?.5*t*t*t:.5*((t-=2)*t*t+2)},QuarticIn:function(t){return t*t*t*t},QuarticOut:function(t){return 1- --t*t*t*t},QuarticInOut:function(t){return(t*=2)<1?.5*t*t*t*t:-.5*((t-=2)*t*t*t-2)},QuinticIn:function(t){return t*t*t*t*t},QuinticOut:function(t){return--t*t*t*t*t+1},QuinticInOut:function(t){return(t*=2)<1?.5*t*t*t*t*t:.5*((t-=2)*t*t*t*t+2)},SineIn:function(t){return 0===t?0:1===t?1:1-Math.cos(t*Math.PI/2)},SineOut:function(t){return 0===t?0:1===t?1:Math.sin(t*Math.PI/2)},SineInOut:function(t){return 0===t?0:1===t?1:.5*(1-Math.cos(Math.PI*t))},ExponentialIn:function(t){return 0===t?0:Math.pow(1024,t-1)},ExponentialOut:function(t){return 1===t?1:1-Math.pow(2,-10*t)},ExponentialInOut:function(t){return 0===t?0:1===t?1:(t*=2)<1?.5*Math.pow(1024,t-1):.5*(2-Math.pow(2,-10*(t-1)))},CircularIn:function(t){return 1-Math.sqrt(1-t*t)},CircularOut:function(t){return Math.sqrt(1- --t*t)},CircularInOut:function(t){return(t*=2)<1?-.5*(Math.sqrt(1-t*t)-1):.5*(Math.sqrt(1-(t-=2)*t)+1)},BackIn:function(t){return t*t*(2.70158*t-1.70158)},BackOut:function(t){return--t*t*(2.70158*t+1.70158)+1},BackInOut:function(t){var e=2.5949095;return(t*=2)<1?t*t*((e+1)*t-e)*.5:.5*((t-=2)*t*((e+1)*t+e)+2)},BounceIn:i,BounceOut:s,BounceInOut:function(t){return t<.5?.5*i(2*t):.5*s(2*t-1)+.5},ElasticIn:function(t){var e,i=.1;return 0===t?0:1===t?1:(!i||i<1?(i=1,e=.1):e=.4*Math.asin(1/i)/(2*Math.PI),-i*Math.pow(2,10*(t-=1))*Math.sin((t-e)*(2*Math.PI)/.4))},ElasticOut:function(t){var e,i=.1;return 0===t?0:1===t?1:(!i||i<1?(i=1,e=.1):e=.4*Math.asin(1/i)/(2*Math.PI),i*Math.pow(2,-10*t)*Math.sin((t-e)*(2*Math.PI)/.4)+1)},ElasticInOut:function(t){var e,i=.1;return 0===t?0:1===t?1:(!i||i<1?(i=1,e=.1):e=.4*Math.asin(1/i)/(2*Math.PI),(t*=2)<1?i*Math.pow(2,10*(t-=1))*Math.sin((t-e)*(2*Math.PI)/.4)*-.5:i*Math.pow(2,-10*(t-=1))*Math.sin((t-e)*(2*Math.PI)/.4)*.5+1)}}}()),function(){var e=pc.Application.getApplication();e&&(e._tweenManager=new pc.TweenManager(e),e.on("update",function(t){e._tweenManager.update(t)}),pc.Application.prototype.tween=function(t){return new pc.Tween(t,this._tweenManager)},pc.Entity.prototype.tween=function(t){var e=this._app.tween(t);return e.entity=this,e})}();var ScrollingBackground=pc.createScript("scrollingBackground");ScrollingBackground.prototype.initialize=function(){this.shouldAnimate=!DM2.getGameData()[DM2.SETTING_SPEED_FX],this.app.on(DM2.EVENT_TOGGLE_SPEEDFX,this.onToggleSpeedFX,this)},ScrollingBackground.prototype.update=function(t){this.shouldAnimate&&(this.entity.element.rect.x+=2*t,this.entity.element.rect=this.entity.element.rect)},ScrollingBackground.prototype.onToggleSpeedFX=function(t){this.shouldAnimate=!t};var ButtonTransition=pc.createScript("buttonTransition");ButtonTransition.attributes.add("delay",{type:"number"}),ButtonTransition.attributes.add("offset",{type:"number",default:1024});TWEEN_TIME=1;ButtonTransition.prototype.transitionIn=function(){this.offset||(this.offset=1024),this.startPosition||(this.startPosition=this.entity.getLocalPosition().clone()),this.entity.setLocalPosition(this.startPosition.x+this.offset,this.startPosition.y,this.startPosition.z);var t={x:this.startPosition.x,y:this.startPosition.y,z:this.startPosition.z};this.entity.tween(this.entity.getLocalPosition()).to(t,TWEEN_TIME,pc.SineOut).delay(this.delay).start()},ButtonTransition.prototype.transitionOut=function(){this.startPosition||(this.startPosition=this.entity.getLocalPosition().clone());var t={x:this.startPosition.x-this.offset,y:this.startPosition.y,z:this.startPosition.z};this.entity.tween(this.entity.getLocalPosition()).to(t,TWEEN_TIME,pc.SineOut).delay(this.delay).start()};var ParentToshadowBone=pc.createScript("parentToshadowBone");ParentToshadowBone.prototype.initialize=function(){this.app.on(DM2.EVENT_ASSETS_LOADED,this.onAllAssetsLoaded,this);var t=this.app.root.findByName("_shadow_");t&&t.destroy()},ParentToshadowBone.prototype.onAllAssetsLoaded=function(){this.shadow=this.entity.findByName("shadow");var t=this.shadow.getPosition();this.shadowParent=this.shadow.parent,this.shadow.reparent(this.entity.findByName("shadow_JNT")),this.shadow.setLocalScale(100,100,100),this.shadow.setPosition(t),this.shadow.name="_shadow_"},ParentToshadowBone.prototype.onTriggerEvent=function(t){t===DM2.TRIGGER_LEVEL_END&&this.shadow.reparent(this.shadowParent)},ParentToshadowBone.prototype.onDisable=function(){this.shadow.reparent(this.shadowParent)};var PauseUi=pc.createScript("pauseUi");PauseUi.attributes.add("pauseContent",{type:"asset",assetType:"html",title:"Pause HTML"}),PauseUi.attributes.add("titlePause",{type:"boolean",title:"Title Pause Menu"}),PauseUi.prototype.initialize=function(){PauseUi.divContent=document.querySelector(".pauseOverlay"),PauseUi.divContent||(PauseUi.divContent=document.createElement("div"),PauseUi.divContent.classList.add("pauseOverlay"),this.injectContent()),PauseUi.divContent.innerHTML=this.pauseContent.resource||"",this.bindEvents(),this.hidePauseOverlay(),this.onToggleSFX(DM2.isMuted())},PauseUi.prototype.showPauseOverlay=function(t){if(!(t&&t.cancelBubble||!0===this.isVisible)){var e=PauseUi.divContent;e.style.display="block",PauseUi.divContent.parentNode.appendChild(e),GameUi.divContent&&(this.gameUiDisplayStyle=GameUi.divContent.style.display,GameUi.divContent.style.display="none"),this.isVisible=!0}},PauseUi.prototype.hidePauseOverlay=function(t){!1!==this.isVisible&&(PauseUi.divContent.style.display="none",GameUi.divContent&&(GameUi.divContent.style.display=this.gameUiDisplayStyle),this.isVisible=!1)},PauseUi.prototype.setControlsVisible=function(t){var e=PauseUi.divContent.querySelector(".home");e&&(e.style.display=t?"block":"none");var i=PauseUi.divContent.querySelector(".resume");i&&(i.style.display=t?"block":"none");var s=PauseUi.divContent.querySelector(".settings");s&&(s.style.display=t?"block":"none");var n=PauseUi.divContent.querySelector(".howto");n&&(n.style.display=t?"block":"none");var o=PauseUi.divContent.querySelector("#sound");if(o&&(o.style.display=t?"block":"none"),this.displayAllButtons){var r=PauseUi.divContent.querySelector(".restart");r&&(r.style.display=t?"block":"none");var a=PauseUi.divContent.querySelector(".levelSelect");a&&(a.style.display=t?"block":"none")}},PauseUi.prototype.injectContent=function(){var t=DM2.getGameHolder();t?t.appendChild(PauseUi.divContent):document.body.appendChild(PauseUi.divContent)},PauseUi.prototype.bindEvents=function(){var t=PauseUi.divContent.querySelector(".home");if(t){var e=function(t){DM2.lastChapterPlayed=null,DM2.sendActionEvent(DM2.BMI_ACTION_HOME,DM2.SCREEN_ID_PAUSE),this.app.fire(DM2.EVENT_GAME_CONTINUE)}.bind(this);DM2.addEventListeners(t,e,DM2.voiceOver.home,this.app)}var i=PauseUi.divContent.querySelector(".resume");if(i){var s=function(t){t.cancelBubble=!0,DM2.sendActionEvent(DM2.BMI_ACTION_UNPAUSE,DM2.SCREEN_ID_PAUSE),this.app.fire(DM2.EVENT_TOGGLE_PAUSE,!1)}.bind(this);DM2.addEventListeners(i,s,DM2.voiceOver.play,this.app)}var n=PauseUi.divContent.querySelector(".settings");if(n){var o=function(){DM2.sendActionEvent(DM2.BMI_ACTION_SETTINGS,DM2.SCREEN_ID_PAUSE),this.app.fire(DM2.EVENT_TOGGLE_SETTINGS,!0)}.bind(this);DM2.addEventListeners(n,o,DM2.voiceOver.settings,this.app)}var r=PauseUi.divContent.querySelector(".howto");if(r){var a=function(){DM2.sendActionEvent(DM2.BMI_ACTION_HOWTO,DM2.SCREEN_ID_PAUSE),this.app.fire(DM2.EVENT_TOGGLE_HOWTO,!0)}.bind(this);DM2.addEventListeners(r,a,DM2.voiceOver.howToPlay,this.app)}var l=PauseUi.divContent.querySelector(".restart");if(l){var h=function(){this.app.fire(DM2.EVENT_LEVEL_RESTART)}.bind(this);DM2.addEventListeners(l,h,DM2.voiceOver.playAgain,this.app)}var c=PauseUi.divContent.querySelector(".levelSelect");if(c){var p=function(){this.app.fire(DM2.EVENT_LEVEL_SELECT)}.bind(this);DM2.addEventListeners(c,p,DM2.voiceOver.levelSelect,this.app)}var d=PauseUi.divContent.querySelector("#sound");if(d){var u=function(){DM2.isMuted()?DM2.sendActionEvent(DM2.BMI_ACTION_UNMUTE,DM2.SCREEN_ID_PAUSE):DM2.sendActionEvent(DM2.BMI_ACTION_MUTE,DM2.SCREEN_ID_PAUSE),this.app.fire(DM2.EVENT_TOGGLE_SFX,!DM2.isMuted())}.bind(this);DM2.addEventListeners(d,u,DM2.voiceOver.toggleSound,this.app)}this.app.off(DM2.EVENT_TOGGLE_PAUSE,this.onTogglePause),this.app.off(DM2.EVENT_TOGGLE_SFX,this.onToggleSFX),this.app.on(DM2.EVENT_TOGGLE_PAUSE,this.onTogglePause,this),this.app.on(DM2.EVENT_TOGGLE_SFX,this.onToggleSFX,this)},PauseUi.prototype.onTogglePause=function(t,e){if(t){this.showPauseOverlay(),this.displayAllButtons=e;var i=PauseUi.divContent.querySelector(".levelSelect"),s=PauseUi.divContent.querySelector(".restart");e?(i.style.display="block",s.style.display="block"):(i.style.display="none",s.style.display="none")}else this.hidePauseOverlay()},PauseUi.prototype.onToggleSFX=function(t){DM2.setMuted(t);var e=PauseUi.divContent.querySelector("#sound");e&&(DM2.isMuted()?e.className="soundOff":e.className="soundOn")};var SfxManager=pc.createScript("sfxManager");SfxManager.prototype.initialize=function(){if(this.app.on(DM2.EVENT_TRIGGER_SFX,this.onSFXTrigger,this),this.app.on(DM2.EVENT_TOGGLE_SFX,this.onToggleSFX,this),this.app.on(DM2.EVENT_TOGGLE_PAUSE,this.onTogglePause,this),this.fadeList=[],this.audioContext=this.entity.sound.system.manager.context,this.on("disable",this.onDisable),!DM2.LOWMEM){var i=this.entity.sound.slots;Object.keys(i).map(function(t,e){i[t].load()})}},SfxManager.prototype.update=function(t){for(var e=this.fadeList.length-1;0<=e;e--){(0,this.fadeList[e])(t,2)&&this.fadeList.splice(e,1)}},SfxManager.prototype.resumePlayback=function(){this.audioContext&&"running"!==this.audioContext.state&&this.audioContext.resume()},SfxManager.prototype.play=function(t){DM2.isMuted()||!this.entity.sound.slot(t)||this.entity.sound.slot(t).isPlaying||this.entity.sound.play(t)},SfxManager.prototype.stop=function(t){this.entity.sound.slot(t)&&(this.entity.sound.pause(t),this.entity.sound.stop(t))},SfxManager.prototype.fadeOut=function(t){if(this.entity.sound&&this.entity.sound.slot(t)){var i=this.entity.sound.slot(t);i.startVolume=i.volume;this.fadeList.push(function(t,e){return 0<i.volume&&(i.volume-=t*e),i.volume<=0&&(i.volume=i.startVolume,i.pause(),i.stop(),!0)})}},SfxManager.prototype.onSFXTrigger=function(t){this.play(t)},SfxManager.prototype.onToggleSFX=function(t){this.entity.sound.volume=t?0:this.isPaused?0:1},SfxManager.prototype.onTogglePause=function(t){this.entity.sound.volume=t?0:DM2.isMuted()?0:1,this.isPaused=t},SfxManager.prototype.onDisable=function(){this.app.off(DM2.EVENT_TRIGGER_SFX,this.onSFXTrigger,this),this.app.off(DM2.EVENT_TOGGLE_SFX,this.onToggleSFX,this),this.app.off(DM2.EVENT_TOGGLE_PAUSE,this.onTogglePause,this)};var SfxEventBridge=pc.createScript("sfxEventBridge");SfxEventBridge.attributes.add("eventID",{type:"string",default:""}),SfxEventBridge.attributes.add("sfxID",{type:"string",default:""}),SfxEventBridge.prototype.initialize=function(){this.app.on(this.eventID,this.onEventTrigger,this)},SfxEventBridge.prototype.onEventTrigger=function(t){this.app.fire(DM2.EVENT_TRIGGER_SFX,this.sfxID)};var BossIntro=pc.createScript("bossIntro");BossIntro.attributes.add("hideAfterIntro",{type:"boolean",default:!0}),BossIntro.prototype.initialize=function(){this.app.on(DM2.EVENT_TRIGGER,this.onIntroStart,this),this.entity.model.enabled=!1},BossIntro.prototype.update=function(t){this.hideAfterIntro&&0<this.introTimeout&&(this.introTimeout-=t,this.introTimeout<=0&&(this.entity.enabled=!1))},BossIntro.prototype.onIntroStart=function(t){if(t===DM2.TRIGGER_START_INTRO){this.entity.model.enabled=!0;var e=this.entity.animation;e.activate=!1,e.play(DM2.bossStates.quickIntro);var i=e.getAnimation(DM2.bossStates.quickIntro);this.introTimeout=i.duration+2}};var BossEndExplosions=pc.createScript("bossEndExplosions");BossEndExplosions.prototype.initialize=function(){this.explosions=this.entity.children.filter(function(t,e){return"explosion"===t.name}),this.hasTriggered=!1,this.explosionIndex=0,this.nextExplosionTime=0,this.currExplosionTime=0},BossEndExplosions.prototype.update=function(t){if(this.hasTriggered&&this.explosionIndex<this.explosions.length&&(this.currExplosionTime+=t,this.currExplosionTime>this.nextExplosionTime)){this.nextExplosionTime=this.currExplosionTime+.25*Math.random();var e=this.explosions[this.explosionIndex];e.enabled=!0,e.animation.play("explode.json"),this.explosionIndex++}},BossEndExplosions.prototype.triggerExplosions=function(){this.hasTriggered||(this.hasTriggered=!0)},(DM2=DM2||{}).checkCollision=function(t,e,i,s,n){if(!(Math.abs(e.x-i.x)<=1))return!1;var o=e.z>=i.z,r=Math.abs(e.z-i.z);return r<n||(e.z+=s*t,!!(e.z<i.z&&n<r&&o))},DM2.checkAABBCollision=function(t,e,i,s){if(t.intersects(e))return!0;for(var n=t.center.clone(),o=i/50,r=!1,a=0;a<100&&(t.center.z-=s*o,!(r=t.intersects(e)));a+=1);return t.center=n,!!r},DM2.calcCatmulRomPoint=function(t,e,i,s,n){var o=this.calcCatmulRomScalar(t,e.x,i.x,s.x,n.x),r=this.calcCatmulRomScalar(t,e.y,i.y,s.y,n.y),a=this.calcCatmulRomScalar(t,e.z,i.z,s.z,n.z);return new pc.Vec3(o,r,a)},DM2.calcCatmulRomScalar=function(t,e,i,s,n){return.5*(2*i+(s-e)*t+(2*e-5*i+4*s-n)*t*t+(3*i-e-3*s+n)*t*t*t)},DM2.calcProjection=function(t,e){t.scale(e.dot(t));var i=t.clone();return i.sub(e),i},DM2.bendOffsetValue=function(t,e,i,s){i.normalize();var n=DM2.calcCatmulRomPoint(t,s[0],s[1],s[2],s[3]);return n.sub(e),DM2.calcProjection(i,n)},DM2.getChapterNameForAssetTag=function(t){switch(t){case"london":return DM2.LOCATION_LONDON;case"tokyo":return DM2.LOCATION_TOKYO;case"space":return DM2.LOCATION_SPACE;case"trench":return DM2.LOCATION_TRENCH;case"factory1":case"factory2":case"factory3":return DM2.LOCATION_FACTORY}},DM2.checkIfActiveInHeirachy=function(t){return!(!t||!t.enabled)&&(t.parent==t.root||DM2.checkIfActiveInHeirachy(t.parent))},DM2.findSFXManagerForApp=function(t){var e;return(e=DM2.LOWMEM?t.root.findByName("SFXManager-sd"):t.root.findByName("SFXManager-hd")).enabled=!0,e.script.sfxManager},DM2.isFirstPlay=function(){return!0!==DM2.getGameData()[DM2.SETTING_HAS_PLAYED]},DM2.isTurboMode=function(){return DM2.getGameData()[DM2.SETTING_DIFFICULTY]===DM2.DIFFICULTY_TURBO},DM2.getLevelNameForTrack=function(t){var e=DM2.getHumanReadableTrackName(t);return DM2.currentChapter+"_"+e},DM2.getLevelName=function(){return DM2.getLevelNameForTrack(DM2.currentTrack)},DM2.getFullLevelName=function(){return DM2.getLevelName()+"_"+DM2.getGameData()[DM2.SETTING_DIFFICULTY]},DM2.getHumanReadableTrackName=function(t){switch(t){case DM2.trackIDs.London01:case DM2.trackIDs.Tokyo01:case DM2.trackIDs.Space01:case DM2.trackIDs.Trench01:case DM2.trackIDs.Factory01:return"track01";case DM2.trackIDs.London02:case DM2.trackIDs.Tokyo02:case DM2.trackIDs.Space02:case DM2.trackIDs.Trench02:case DM2.trackIDs.Factory02:return"track02";case DM2.trackIDs.LondonBoss:case DM2.trackIDs.TokyoBoss:case DM2.trackIDs.SpaceBoss:case DM2.trackIDs.TrenchBoss:case DM2.trackIDs.FactoryBoss:return"track03";default:return t}},DM2.addEventListeners=function(e,i,t,s){if(e.addEventListener("keydown",function(t){t.keyCode;13!==t.keyCode&&32!==t.keyCode||i()},!1),e.addEventListener("mousedown",i,!1),t&&s){var n=function(){s.fire(DM2.EVENT_PLAY_VOICEOVER,t)};pc.platform.mobile?(e.addEventListener("touchstart",n,!1),e.addEventListener("touchmove",function(t){t.preventDefault()})):(e.addEventListener("mouseover",n,!1),e.addEventListener("mouseout",function(t){e.blur()},!1))}pc.platform.ios&&e.addEventListener("gesturestart",function(t){t.preventDefault()})},DM2.getGameHolder=function(){return DM2.gmi?document.getElementById("dm-ui-layer"):null},DM2.setGameHolderTouchEnabled=function(t){var e=DM2.getGameHolder();e&&(e.style.pointerEvents=t?"auto":"none")},(DM2=DM2||{}).LOWMEM=!1,DM2.FIXED_T=.016,DM2.BEND_INDEX=10,DM2.MAX_SEGMENTS=12,DM2.MOBILE_MAX_WIDTH=770,DM2.LOAD_TIMEOUT=40,DM2.PREWARM_FRAMES=4,DM2.SEGMENT_SCALE=16,DM2.ENABLE_DA=!1,DM2.PICKUP_FX_TO=1.5,DM2.PROP_CACHE_SIZE=10,DM2.SEGM_CACHE_SIZE=5,DM2.RESOLUTION_SIZE=1,DM2.configPlayer={cameraXOffset:-2.5,cameraYOffset:30,cameraXRate:10,cameraYRate:.5,cameraZRate:3,cameraYMin:2,cameraYMax:5,cameraZPos:6,cameraYPos:4,oversteerTrigger:.3,oversteerValue:20,oversteerRate:2,maxSpeed:50,minSpeed:7,nitroSpeed:95,nitroAccel:2,nitroTime:3,forwardAccel:.25,brakeAccel:.5,stopAccel:1,lazerDuration:3,useJoypad:"NONE"},DM2.trackStarConfig={london_track01:[101,80,70],london_track02:[103,81,64],london_track03:[128,113,90],tokyo_track01:[90,78,65],tokyo_track02:[105,89,80],tokyo_track03:[131,115,102],space_track01:[90,71,67],space_track02:[105,84,70],space_track03:[124,110,100],trench_track01:[90,70,60],trench_track02:[87,70,60],trench_track03:[140,125,115],factory_track01:[98,78,68],factory_track02:[120,110,90],factory_track03:[122,105,90]},DM2.resultDelay={default:3,london:7,tokyo:7,space:7,trench:7,factory:7},DM2.easySettings={maxSpeed:40,minSpeed:6,nitroSpeed:90,animSpeed:1},DM2.normalSettings={maxSpeed:50,minSpeed:7,nitroSpeed:95,animSpeed:1},DM2.turboSettings={maxSpeed:60,minSpeed:10,nitroSpeed:100,animSpeed:1.2},DM2.trackIDs={London01:"535127",London02:"535129",LondonBoss:"535108",Tokyo01:"535130",Tokyo02:"535132",TokyoBoss:"535120",Space01:"535133",Space02:"535134",SpaceBoss:"530249",Trench01:"600854",Trench02:"600920",TrenchBoss:"600922",Factory01:"600923",Factory02:"600924",FactoryBoss:"600925"},DM2.configPropRender={bus:{uXRotCorrection:-1,uYRotCorrection:1},taxi:{uXRotCorrection:-1,uYRotCorrection:1},ramp:{uXRotCorrection:1,uYRotCorrection:1},bomb:{uXRotCorrection:1,uYRotCorrection:1},traffic_london:{uXRotCorrection:-1,uYRotCorrection:1},booster:{uXRotCorrection:1,uYRotCorrection:1,glowMeshIndex:1},blueprint:{uXRotCorrection:-1,uYRotCorrection:1,glowMeshIndex:1},battery:{uXRotCorrection:-1,uYRotCorrection:1,glowMeshIndex:1},safety_mouse:{uXRotCorrection:1,uYRotCorrection:1},water_balloon:{uXRotCorrection:1,uYRotCorrection:1},toilet_henchman:{uXRotCorrection:1,uYRotCorrection:1},train_back:{uXRotCorrection:-1,uYRotCorrection:1},train_front:{uXRotCorrection:1,uYRotCorrection:1},train_middle:{uXRotCorrection:1,uYRotCorrection:1},waterfall:{uXRotCorrection:1,uYRotCorrection:1},traffic_tokyo:{uXRotCorrection:-1,uYRotCorrection:1},manhole:{uXRotCorrection:1,uYRotCorrection:1},flooded_area:{uXRotCorrection:1,uYRotCorrection:1},factory_pipe:{uXRotCorrection:1,uYRotCorrection:1},rock:{uXRotCorrection:1,uYRotCorrection:1},quark_mine:{uXRotCorrection:1,uYRotCorrection:1},fake_mark_iv:{uXRotCorrection:1,uYRotCorrection:1},clown_car:{uXRotCorrection:-1,uYRotCorrection:1},clown_cannon:{uXRotCorrection:-1,uYRotCorrection:1},clown_box:{uXRotCorrection:-1,uYRotCorrection:1},computer_terminal:{uXRotCorrection:1,uYRotCorrection:1},electrical_pylon:{uXRotCorrection:-1,uYRotCorrection:1}},(DM2=DM2||{}).exitGame=function(){DM2.gmi?DM2.gmi.exit():location.reload()},DM2.sendStatsEvent=function(t,e,i){DM2.gmi?DM2.gmi.sendStatsEvent(t,e,i):(console.log("mock gmi :: gmi.sendStatsEvent("+t+", "+e+", "+i+")"),i&&console.dir(i))},DM2.sendActionEvent=function(t,e){DM2._gmiFirstAction||(DM2.sendStatsEvent("game_first_click",t,{game_screen:e}),DM2._gmiFirstAction=!0),DM2.sendStatsEvent("game_click",t,{game_screen:e})},DM2.sendChapterSelect=function(t){var e={};e.game_chapter=t,e.game_difficulty=DM2.getGameData()[DM2.SETTING_DIFFICULTY],e.game_template="null",e.settings_status=DM2.getSettingsStatus(),DM2.sendStatsEvent("game_level","chapter",e)},DM2.sendTrackSelect=function(t,e){var i={};i.game_chapter=t,i.game_difficulty=DM2.getGameData()[DM2.SETTING_DIFFICULTY],i.game_level_name=DM2.getHumanReadableTrackName(e),i.game_template="null",i.settings_status=DM2.getSettingsStatus(),DM2.sendStatsEvent("game_level","selected",i)},DM2.sendDifficultySelect=function(t){var e={};e.game_difficulty=t,e.game_template="null",e.settings_status=DM2.getSettingsStatus(),DM2.sendStatsEvent("game_level","difficulty",e)},DM2.sendLevelStarted=function(){var t={};t.game_chapter=DM2.currentChapter,t.game_level_name=DM2.getHumanReadableTrackName(DM2.currentTrack),t.game_difficulty=DM2.getGameData()[DM2.SETTING_DIFFICULTY],t.game_template="null",t.settings_status=DM2.getSettingsStatus(),DM2.sendStatsEvent("game_level","started",t)},DM2.sendLevelCompleted=function(t,e,i,s){i&&DM2.updateLevelPlayCount(DM2.currentTrack);var n={};n.game_chapter=DM2.currentChapter,n.game_level_name=DM2.getHumanReadableTrackName(DM2.currentTrack),n.game_difficulty=DM2.getGameData()[DM2.SETTING_DIFFICULTY],n.game_template="null",n.settings_status=DM2.getSettingsStatus(),n.level_play_count=DM2.getLevelPlayCount(DM2.currentTrack).toString(),n.stars_awarded=t.toString(),n.stars_detail=s.join("."),n.game_level_time=e.replace(" ",""),DM2.sendStatsEvent("game_level","complete",n)},DM2.setHeartbeatData=function(t,e){var i={};i.game_screen=t,i.heartbeat_period=15,i.game_template="null",i.settings_status=DM2.getSettingsStatus(),e&&(i.level_name=e),DM2._heartbeatData=i},DM2.sendHeartbeat=function(){DM2._heartbeatData&&DM2.sendStatsEvent("timer","heartbeat",DM2._heartbeatData)},DM2.sendExitSettings=function(t){DM2.sendStatsEvent("game_click","exit_settings",{settings_changed:t})},DM2.setMuted=function(t){DM2.gmi?DM2.gmi.setMuted(t):DM2._isMuted=t},DM2.updateLevelPlayCount=function(t){var e="dm_"+t+"_playcount",i=DM2.getGameData()[DM2.SETTING_SPEED_FX];i||(i=0),i+=1,DM2.putGameData(e,i)},DM2.getLevelPlayCount=function(t){var e=DM2.getGameData()[DM2.SETTING_SPEED_FX];return e||(e=0),e},DM2.isMuted=function(){return DM2.gmi?DM2.gmi.getAllSettings().muted:(DM2._isMuted||(DM2._isMuted=!1),DM2._isMuted)},DM2.putGameData=function(t,e){DM2.gmi&&DM2.gmi.getAllSettings().gameData?DM2.gmi.setGameData(t,e):(DM2._gameData||(DM2._gameData={}),DM2._gameData[t]=e)},DM2.getGameData=function(){return DM2.gmi&&DM2.gmi.getAllSettings().gameData?DM2.gmi.getAllSettings().gameData:(DM2._gameData||(DM2._gameData={}),DM2._gameData)},DM2.getSettingsStatus=function(){return"difficulty-"+(DM2.getGameData()[DM2.SETTING_DIFFICULTY]||"false")+".muted-"+DM2.isMuted()+".motion-"+(DM2.getGameData()[DM2.SETTING_SPEED_FX]||"false")};var BlueprintProp=pc.createScript("blueprintProp");BlueprintProp.prototype.initialize=function(){this.sfxManager=DM2.findSFXManagerForApp(this.app),this.propBase=this.entity.script.propBase,this.propBase.registerCallbacks(this.onCollision,this.onResetProp,this)},BlueprintProp.prototype.onCollision=function(t){t.pickupBlueprint(this.entity.triggerName),this.sfxManager.play(DM2.SFX_COLLECTIBLE_PICKUP),this.entity.model.enabled=!1},BlueprintProp.prototype.onResetProp=function(){this.entity.model.enabled=!0};var Skyplane=pc.createScript("skyplane");Skyplane.attributes.add("vs",{type:"asset",assetType:"shader",title:"Vertex Shader"}),Skyplane.attributes.add("fs",{type:"asset",assetType:"shader",title:"Fragment Shader"}),Skyplane.attributes.add("textureMap",{type:"asset",assetType:"texture",title:"Texture Map"}),Skyplane.prototype.initialize=function(){DM2.LOWMEM?this.entity.enabled=!1:(this.gameCamera=this.app.root.findByName("GameCamera").camera,this.trackRunner=this.app.root.findByName("TrackRunner").script.trackRunner,this.ctrlForward=pc.Vec3.ZERO,this.app.on(DM2.EVENT_ASSETS_LOADED,this.setupMaterial,this))},Skyplane.prototype.update=function(t){if(this.material){var e=this.trackRunner.smoothedForward;this.material.setParameter("uParallax",e.data)}},Skyplane.prototype.setupMaterial=function(){if(this.vs&&this.fs){var t=this.gameCamera.clearColor.clone(),e=this.app,i=this.entity.model.model,s=e.graphicsDevice,n=this.textureMap.resource,o=this.vs.resource,r="precision "+s.precision+" float;\n";r+=this.fs.resource;var a={attributes:{aPosition:pc.SEMANTIC_POSITION,aNormal:pc.SEMANTIC_NORMAL,aUv0:pc.SEMANTIC_TEXCOORD0,aColor:pc.SEMANTIC_COLOR},vshader:o,fshader:r};if(this.shader=new pc.Shader(s,a),this.material=new pc.Material,this.time=0,this.material.setShader(this.shader),this.material.setParameter("uTextureMap",n),this.material.setParameter("uFogColor",t.data),this.material.blendType=pc.BLEND_NORMAL,i)for(var l=0;l<i.meshInstances.length;l++)i.meshInstances[l].material=this.material;else console.error("no model on prop: "+this.entity.name)}};var TankProp=pc.createScript("tankProp");TankProp.prototype.initialize=function(){this.propBase=this.entity.script.propBase,this.propBase.registerCallbacks(this.onCollision,this.onResetProp,this)},TankProp.prototype.onCollision=function(t){this.entity.animation.enabled=!0,this.entity.animation.play("vehicle_hitforward.json"),this.app.fire(DM2.EVENT_TRIGGER_SFX,DM2.SFX_CAR_CRASH),t.crashVehicle()},TankProp.prototype.onResetProp=function(){this.entity.animation.currentTime=0,this.entity.animation.enabled=!1};var ChapterScreen=pc.createScript("chapterScreen");ChapterScreen.prototype.initialize=function(){ChapterScreen.chaptersHolder=this.entity.findByName("ChapterSelect"),ChapterScreen.dot1=this.entity.findByName("Dot1"),ChapterScreen.dot2=this.entity.findByName("Dot2"),ChapterScreen.easyIcon=this.entity.findByName("EasyImage"),ChapterScreen.mediumIcon=this.entity.findByName("MediumImage"),ChapterScreen.hardIcon=this.entity.findByName("HardImage");var t=this;this.on("enable",function(){t.onEnable()}),ChapterScreen.chaptersHolder.setLocalPosition(-700,0,0),t.onEnable()},ChapterScreen.prototype.moveLeft=function(t){var e=new pc.Vec3(0,0,0);t&&t.stopPropagation(),ChapterScreen.dot1.enabled=!0,ChapterScreen.dot2.enabled=!1,ChapterScreen.chaptersHolder.tween(ChapterScreen.chaptersHolder.getLocalPosition()).to(e,.5,pc.SineOut).start()},ChapterScreen.prototype.moveRight=function(t){var e=new pc.Vec3(-700,0,0);t&&t.stopPropagation(),ChapterScreen.dot1.enabled=!1,ChapterScreen.dot2.enabled=!0,ChapterScreen.chaptersHolder.tween(ChapterScreen.chaptersHolder.getLocalPosition()).to(e,.5,pc.SineOut).start()},ChapterScreen.prototype.onEnable=function(){var t=DM2.getGameData()[DM2.SETTING_DIFFICULTY];ChapterScreen.easyIcon.enabled=t===DM2.DIFFICULTY_EASY,ChapterScreen.mediumIcon.enabled=t===DM2.DIFFICULTY_NORMAL,ChapterScreen.hardIcon.enabled=t===DM2.DIFFICULTY_TURBO;var e=MainUi.divContent.querySelector(".prevChapter");e&&(DM2.addEventListeners(e,this.moveLeft,DM2.voiceOver.previous,this.app),e.style.display="none");var i=MainUi.divContent.querySelector(".nextChapter");i&&(DM2.addEventListeners(i,this.moveRight,DM2.voiceOver.next,this.app),i.style.display="none");ChapterScreen.dot1.enabled=!0,ChapterScreen.dot2.enabled=!1;var s=new pc.Vec3(0,0,0);ChapterScreen.chaptersHolder.tween(ChapterScreen.chaptersHolder.getLocalPosition()).to(s,.5,pc.SineOut).delay(2.5).on("complete",function(){e.style.display="block",i.style.display="block"}).start()};var FloatingProp=pc.createScript("floatingProp");FloatingProp.prototype.initialize=function(){this.propBase=this.entity.script.propBase,this.propBase.isFloating=!0};var DM2,AlwaysCollideProp=pc.createScript("alwaysCollideProp");AlwaysCollideProp.prototype.initialize=function(){this.propBase=this.entity.script.propBase,this.propBase.isAlwaysCollide=!0},(DM2=DM2||{}).shaderChunk={},DM2.shaderChunk.headerVS=["uniform vec4  uFogColor;","varying vec4  vFogColor;","attribute vec3 aPosition;","attribute vec3 aNormal;","attribute vec2 aUv0;","attribute vec4 aColor;","varying vec4  vNormal;","varying vec4  vColor;","varying vec2  vUv0;","varying float vDepth;","uniform mat4 matrix_model;","uniform mat4 matrix_viewProjection;",""].join("\n"),DM2.shaderChunk.trackBendingVS=["uniform vec3 uOrigin;","uniform vec3 uForward;","","uniform vec3 uP0;","uniform vec3 uP1;","uniform vec3 uP2;","uniform vec3 uP3;","","vec3 calcCatmullRom(float t)","{","    vec3 p0 = uP0;","    vec3 p1 = uP1;","    vec3 p2 = uP2;","    vec3 p3 = uP3;","","    vec3 a = 2.0 * p1;","    vec3 b = p2 - p0;","    vec3 c = 2.0 * p0 - 5.0 * p1 + 4.0 * p2 - p3;","    vec3 d = -p0 + 3.0 * p1 - 3.0 * p2 + p3;","","    vec3 pos = 0.5 * (a + (b * t) + (c * t * t) + (d * t * t * t));","","    return pos;","}","","vec3 calcOffset(vec3 fwd, vec3 ctrl)","{","    vec3 proj_CtrlFwd = dot(ctrl, fwd) * fwd;","    vec3 offset       = proj_CtrlFwd - ctrl;","","    return offset;","}","","vec4 bendTrackVertexToWorld(vec3 p)","{","    vec4 worldPos = matrix_model * vec4(p, 1.0);","    vec4 pos      = worldPos;","","    if(worldPos.z > 8.0)","    {","        vec3  fwd      = normalize(uForward);","        float normZ    = (aPosition.z + 50.0) / 100.0;","        vec3  ctrl     = calcCatmullRom(normZ);","        vec3  offset   = calcOffset(fwd, ctrl - uOrigin);","","        pos.x += offset.x;","        pos.y += offset.y;","    }","","    return pos;","}",""].join("\n"),DM2.shaderChunk.propBendingVS=["uniform vec3 uOrigin;","uniform vec3 uForward;","","uniform float uScaleFactor;","uniform float uXRotCorrection;","uniform float uYRotCorrection;","uniform float uOffset;","","uniform vec3 uP0;","uniform vec3 uP1;","uniform vec3 uP2;","uniform vec3 uP3;","","vec3 calcCatmullRom(float t)","{","    vec3 p0 = uP0;","    vec3 p1 = uP1;","    vec3 p2 = uP2;","    vec3 p3 = uP3;","","    vec3 a = 2.0 * p1;","    vec3 b = p2 - p0;","    vec3 c = 2.0 * p0 - 5.0 * p1 + 4.0 * p2 - p3;","    vec3 d = -p0 + 3.0 * p1 - 3.0 * p2 + p3;","","    vec3 pos = 0.5 * (a + (b * t) + (c * t * t) + (d * t * t * t));","","    return pos;","}","","vec3 calcOffset(vec3 fwd, vec3 ctrl)","{","    vec3 proj_CtrlFwd = dot(ctrl, fwd) * fwd;","    vec3 offset       = proj_CtrlFwd - ctrl;","","    return offset;","}","","vec4 bendPropVertexToWorld(vec3 p)","{","    vec4 pos = matrix_model * vec4(p, 1.0);","","    if(pos.z > 8.0)","    {","        vec3  fwd      = normalize(uForward);","        float normZ    = (50.0 + uXRotCorrection * uScaleFactor * p.z) / 100.0 - uOffset;","        vec3  ctrl     = calcCatmullRom(normZ);","        vec3  offset   = calcOffset(fwd, ctrl - uOrigin);","","        pos.x         += offset.x * uYRotCorrection;","        pos.y         += offset.y;","    }","","    return pos;","}",""].join("\n");var PortalDecorator=pc.createScript("portalDecorator");PortalDecorator.attributes.add("vs",{type:"asset",assetType:"shader",title:"Vertex Shader"}),PortalDecorator.attributes.add("fs",{type:"asset",assetType:"shader",title:"Fragment Shader"}),PortalDecorator.attributes.add("diffuseMap",{type:"asset",assetType:"texture",title:"Diffuse Map"}),PortalDecorator.prototype.initialize=function(){this.gameCamera=this.app.root.findByName("GameCamera").camera,this.diffusemapTex=this.diffuseMap.resource,this.segmentRenderer=this.entity.script.segmentRenderer,this.gameEngine=this.app.root.findByName("GameEngine").script.gameEngine,this.segmentRenderer.registerDecorator(this)},PortalDecorator.prototype.onUpdateMaterial=function(t,e){var i=this.gameEngine.globalTimers[0],s=this.gameEngine.globalTimers[1],n=this.gameEngine.globalTimers[2];t.setParameter("uTimer",i),t.setParameter("uTimerTex",s),t.setParameter("uTimer2",n),t.setParameter("uDiffuseMap",this.diffusemapTex),t.setParameter("uZOffset",this.entity.getLocalPosition().z)},PortalDecorator.prototype.setupVertShader=function(t){return t=DM2.shaderChunk.headerVS,t+=DM2.shaderChunk.trackBendingVS,t+=this.vs.resource},PortalDecorator.prototype.setupFragShader=function(t){return t="precision "+this.app.graphicsDevice.precision+" float;\n",t+=this.fs.resource};var AntimatterDecorator=pc.createScript("antimatterDecorator");AntimatterDecorator.attributes.add("vs",{type:"asset",assetType:"shader",title:"Vertex Shader"}),AntimatterDecorator.attributes.add("fs",{type:"asset",assetType:"shader",title:"Fragment Shader"}),AntimatterDecorator.attributes.add("diffuseMap",{type:"asset",assetType:"texture",title:"Diffuse Map"}),AntimatterDecorator.attributes.add("swirlMap",{type:"asset",assetType:"texture",title:"Swirl Map"}),AntimatterDecorator.prototype.initialize=function(){this.gameCamera=this.app.root.findByName("GameCamera").camera,this.diffusemapTex=this.diffuseMap.resource,this.swirlMapTex=this.swirlMap.resource,this.propRenderer=this.entity.script.propRenderer,this.timer=0,this.timertex=0,this.propRenderer.registerDecorator(this)},AntimatterDecorator.prototype.onUpdateMaterial=function(t,e){t.setParameter("uTimer",this.timer),t.setParameter("uTimerTex",this.timertex),t.setParameter("uDiffuseMap",this.diffusemapTex),t.setParameter("uSwirlMap",this.swirlMapTex),this.timer+=2*e,this.timertex+=1.2*e},AntimatterDecorator.prototype.setupVertShader=function(t){return t=DM2.shaderChunk.headerVS,t+=DM2.shaderChunk.propBendingVS,t+=this.vs.resource},AntimatterDecorator.prototype.setupFragShader=function(t){return t="precision "+this.app.graphicsDevice.precision+" float;\n",t+=this.fs.resource};var LaserRenderer=pc.createScript("laserRenderer");LaserRenderer.attributes.add("vs",{type:"asset",assetType:"shader",title:"Vertex Shader"}),LaserRenderer.attributes.add("fs",{type:"asset",assetType:"shader",title:"Fragment Shader"}),LaserRenderer.attributes.add("diffuseMap",{type:"asset",assetType:"texture",title:"Diffuse Map"}),LaserRenderer.prototype.initialize=function(){this.gameCamera=this.app.root.findByName("GameCamera").camera,this.gameEngine=this.app.root.findByName("GameEngine").script.gameEngine,this.isAssetsLoaded=!1,this.app.on(DM2.EVENT_ASSETS_LOADED,this.onAllAssetsLoaded,this)},LaserRenderer.prototype.update=function(t){if(this.isAssetsLoaded){var e=this.gameEngine.globalTimers[0];this.laserMaterial.setParameter("uTimer",e),this.laserMaterial.setParameter("uDiffuseMap",this.diffusemapTex)}},LaserRenderer.prototype.onAllAssetsLoaded=function(){this.diffusemapTex=this.diffuseMap.resource,this.setupMaterial(),this.isAssetsLoaded=!0},LaserRenderer.prototype.setupMaterial=function(){var t=this.entity.model.model,e=this.app.graphicsDevice,i=this.vs.resource,s="precision "+e.precision+" float;\n";s+=this.fs.resource;var n={attributes:{vertex_position:pc.SEMANTIC_POSITION,vertex_boneWeights:pc.SEMANTIC_BLENDWEIGHT,vertex_boneIndices:pc.SEMANTIC_BLENDINDICES,aColor:pc.SEMANTIC_COLOR,aUv0:pc.SEMANTIC_TEXCOORD0},vshader:i,fshader:s};this.shader=new pc.Shader(e,n),this.laserMaterial=new pc.Material,this.time=0,this.ticker=0,this.timer=0,this.laserMaterial.setShader(this.shader);var o=this.laserMaterial;t.meshInstances.map(function(t,e){t.material=o})};var BatteryProp=pc.createScript("batteryProp");BatteryProp.prototype.initialize=function(){this.propBase=this.entity.script.propBase,this.propBase.registerCallbacks(this.onCollision,this.onResetProp,this)},BatteryProp.prototype.onCollision=function(t){t.pickupBattery(),this.entity.model.enabled=!1},BatteryProp.prototype.onResetProp=function(){this.entity.model.enabled=!0};var PlayerLazer=pc.createScript("playerLazer");PlayerLazer.prototype.initialize=function(){this.propManager=this.app.root.findByName("PropManager").script.propManager},PlayerLazer.prototype.checkCollisions=function(t,e){t=t.normalize();for(var i=this.propManager.activeProps,s=this.propManager.activeCount,n=new pc.Ray(this.entity.getPosition(),t),o=0;o<s;o++){var r=i[o];if("blueprint"!==r.name&&"trigger"!==r.name&&"boss_waypoint"!==r.name&&"boss_attack"!==r.name&&r.position.z<2*DM2.SEGMENT_SCALE){var a=r.script.propBase;a.AABB.center=r.getPosition(),!r.hit&&a.AABB.intersectsRay(n)&&(r.hit=!0,this.propManager.spawnPropDirect("explosion",r.getPosition()))}}};var ExplosionProp=pc.createScript("explosionProp");ExplosionProp.prototype.initialize=function(){this.propBase=this.entity.script.propBase,this.propBase.registerCallbacks(this.onCollision,this.onResetProp,this);var t=this;this.on("enable",function(){t.onEnable()}),this.onEnable()},ExplosionProp.prototype.onEnable=function(){this.entity.animation.enabled=!0,this.entity.animation.play("explode.json")},ExplosionProp.prototype.onCollision=function(t){},ExplosionProp.prototype.onResetProp=function(){this.entity.model.enabled=!0,this.entity.animation.currentTime=0,this.entity.animation.enabled=!1};var NewChapterLabel=pc.createScript("newChapterLabel");NewChapterLabel.attributes.add("data",{type:"string"}),NewChapterLabel.prototype.initialize=function(){this.settingsKey="DM2_has_clicked_"+this.data,DM2.getGameData()[this.settingsKey]?this.entity.element.enabled=!1:this.app.on(DM2.EVENT_BUTTON_CLICK,this.onButtonClick,this)},NewChapterLabel.prototype.onButtonClick=function(t){t.data==this.data&&DM2.putGameData(this.settingsKey,!0)};